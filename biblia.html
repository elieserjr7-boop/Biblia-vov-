<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>B√≠blia Sagrada</title>
    
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B√≠blia">
    <meta name="theme-color" content="#2c3e50">

    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <style>
        /* --- ESTILO GERAL (CSS) --- */
        * { box-sizing: border-box; }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: #fdfbf7;
            color: #111;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- CABE√áALHO --- */
        header {
            /* Padr√£o: Comportamento NORMAL (bloco) para menus */
            position: relative; 
            background-color: #2c3e50;
            color: white;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform;
            width: 100%;
        }

        /* T√çTULO E VERS√ÉO */
        h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px; }

        .seletor-versao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            margin: 10px auto 0 auto; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .label-versao { font-size: 14px; font-weight: normal; color: #ecf0f1; white-space: nowrap; }
        
        #select-versao {
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            width: 100%;
            flex: 1;
        }

        /* --- CORPO PRINCIPAL (√ÅREA DE ROLAGEM) --- */
        main {
            flex: 1; 
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
            
            /* Padr√£o (Menus): Padding pequeno */
            padding-top: 10px; 
            padding-bottom: 80px; /* Espa√ßo para o menu de abas */
            transition: padding-top 0.3s ease;
        }

        /* =========================================
           MODO LEITURA (Ativado apenas no Texto)
           ========================================= */
        
        /* Quando estiver lendo, o header vira FIXO (Flutuante) */
        body.modo-leitura header {
            position: fixed;
            top: 0; left: 0; right: 0;
        }

        /* Quando estiver lendo (COM BARRA VIS√çVEL), compensamos a altura dela */
        body.modo-leitura main {
            padding-top: 140px; /* Altura do cabe√ßalho + margem */
            padding-bottom: 100px; /* Rodap√© de navega√ß√£o */
        }

        /* MODO IMERSIVO (Barras Ocultas) */
        body.modo-leitura.imersivo header { 
            transform: translateY(-100%); /* Esconde Header */
        }
        body.modo-leitura.imersivo #rodape-nav { 
            transform: translateY(100%); /* Esconde Footer */
        }
        
        /* AQUI EST√Å A CORRE√á√ÉO DA MARGEM: */
        body.modo-leitura.imersivo main {
            /* Calcula: 25px fixos + a √°rea do notch (se houver) */
            padding-top: calc(25px + env(safe-area-inset-top)); 
            padding-bottom: 20px;
        }


        /* --- ELEMENTOS VISUAIS --- */
        .separador-testamento {
            background-color: #d35400; 
            color: white; 
            padding: 12px;
            font-size: 20px; 
            font-weight: bold; 
            text-align: center;
            border-radius: 8px; 
            margin: 15px 15px 15px 15px;
            text-transform: uppercase; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-livros { 
            display: grid; 
            gap: 12px; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            padding: 0 15px 20px 15px;
        }

        .grade-capitulos { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 10px; 
            padding: 15px;
        }

        button { touch-action: manipulation; }
        button:active { transform: scale(0.96); opacity: 0.8; }

        .btn-livro {
            background-color: #ecf0f1; border: 2px solid #bdc3c7;
            padding: 15px; font-size: 16px; text-align: center;
            border-radius: 10px; cursor: pointer; font-weight: bold; color: #2c3e50;
        }
        
        .btn-hinario {
            background-color: #ecf0f1; border: 2px solid #bdc3c7;
            padding: 20px; font-size: 18px; text-align: center;
            border-radius: 10px; cursor: pointer; font-weight: bold; color: #2c3e50;
        }

        .btn-capitulo {
            padding: 15px; font-size: 20px; background-color: #fff;
            border: 2px solid #2c3e50; border-radius: 8px; cursor: pointer;
            color: #2c3e50; font-weight: bold;
        }

        .btn-voltar-topo {
            grid-column: 1 / -1; 
            background-color: #e74c3c; color: white; border: none;
            padding: 15px; font-size: 18px; border-radius: 12px;
            cursor: pointer; margin: 10px 15px 20px 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* TEXTO DA B√çBLIA */
        #texto-biblico, #texto-hino {
            font-size: 24px; 
            line-height: 1.8; 
            padding: 0 20px;
            text-align: left; 
            margin-bottom: 40px;
            cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .versiculo-num {
            font-size: 16px; color: #e67e22; font-weight: bold;
            vertical-align: super; margin-right: 4px; user-select: none;
        }

        /* HIN√ÅRIOS LISTA */
        .lista-hinos { display: flex; flex-direction: column; gap: 10px; padding: 0 15px; }
        .item-hino {
            background: white; border: 1px solid #bdc3c7; padding: 15px;
            border-radius: 8px; font-size: 18px; color: #2c3e50; text-align: left; cursor: pointer;
        }
        .estrofe-hino { margin-bottom: 25px; }

        /* --- BARRA DE NAVEGA√á√ÉO (RODAP√â LEITURA) --- */
        #rodape-nav {
            background-color: #ecf0f1; 
            padding: 10px;
            display: flex; gap: 15px;
            border-top: 3px solid #bdc3c7;
            
            position: fixed; 
            bottom: 0; left: 0; right: 0;
            z-index: 1000; 
            
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .btn-nav {
            flex: 1; padding: 15px 0; font-size: 24px;
            background-color: #2c3e50; color: white;
            border: none; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-voltar-menu { background-color: #d35400; font-size: 16px; flex: 1; }

        /* --- MENU PRINCIPAL (ABAS) --- */
        #abas-principais {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 70px; background-color: #fff;
            display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 900;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .aba {
            flex: 1; border: none; background: transparent;
            font-size: 14px; font-weight: bold; color: #95a5a6;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .aba.ativa { color: #2c3e50; background-color: #ecf0f1; border-top: 3px solid #e67e22; }
        .icone-aba { font-size: 24px; margin-bottom: 2px; }

        /* UTILIT√ÅRIOS */
        .escondido { display: none !important; }

        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #e67e22; background: rgba(255,255,255,0.95);
            padding: 20px; border-radius: 10px; z-index: 2000;
            display: none; width: 80%; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body id="corpo-app">

    <header id="cabecalho-principal">
        <h1 id="titulo-app">B√≠blia Sagrada</h1>
        
        <div id="area-versao" class="seletor-versao-container escondido">
            <span class="label-versao">Vers√£o:</span>
            <select id="select-versao" onchange="mudarVersao()">
                <option value="NVI">NVI - Nova Vers√£o Internacional</option>
                <option value="NVT">NVT - Nova Vers√£o Transformadora</option>
                <option value="ACF">ACF - Almeida Corrigida Fiel</option>
                <option value="ARA">ARA - Almeida Revista e Atualizada</option>
                <option value="ARC">ARC - Almeida Revista e Corrigida</option>
                <option value="AA">AA - Almeida Atualizada</option>
                <option value="TB">TB - Tradu√ß√£o Brasileira</option>
                <option value="KJA">KJA - King James Atualizada</option>
                <option value="NAA">NAA - Nova Almeida Atualizada</option>
                <option value="NBV">NBV - Nova B√≠blia Viva</option>
                <option value="NTLH">NTLH - Nova Tradu√ß√£o Linguagem de Hoje</option>
                <option value="AS21">A21 - Almeida S√©culo 21</option>
                <option value="KJF">KJF - King James Fiel</option>
            </select>
        </div>
    </header>

    <div id="loading">‚è≥ Carregando...</div>

    <main id="area-principal">
        
        <div id="tab-biblia">
            <div id="tela-livros"></div>
            <div id="tela-capitulos" class="grade-capitulos escondido"></div>
            
            <div id="tela-leitura" class="escondido">
                <h2 id="titulo-capitulo-leitura" style="text-align:center; color:#2c3e50; margin-top:0;"></h2>
                <div id="texto-biblico" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-hinarios" class="escondido">
            <div id="tela-escolha-hinario" class="grade-livros" style="margin-top:20px;">
                <button class="btn-hinario" onclick="abrirHinario('harpa')">üéµ Harpa Crist√£</button>
                <button class="btn-hinario" onclick="abrirHinario('cantor')">üéº Cantor Crist√£o</button>
            </div>

            <div id="tela-lista-hinos" class="escondido">
                <button class="btn-voltar-topo" onclick="voltarParaEscolhaHinario()">&#11013; Voltar aos Hin√°rios</button>
                <input type="text" id="busca-hino" placeholder="N√∫mero ou nome..." 
                       style="width:90%; padding:15px; margin: 0 auto 15px auto; display:block; font-size:18px; border-radius:8px; border:1px solid #ccc;"
                       onkeyup="filtrarHinos()">
                <div id="lista-hinos-container" class="lista-hinos"></div>
            </div>

            <div id="tela-leitura-hino" class="escondido">
                <h2 id="titulo-hino-leitura" style="text-align:center; color:#2c3e50; margin-top:0;"></h2>
                <div id="texto-hino" onclick="alternarImersao()"></div>
            </div>
        </div>

    </main>

    <footer id="rodape-nav" class="escondido">
        <button type="button" class="btn-nav btn-voltar-menu" onclick="voltarInicioLeitura()">In√≠cio</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(-1)">&#9664;</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(1)">&#9654;</button>
    </footer>

    <nav id="abas-principais">
        <button class="aba ativa" onclick="mudarAba('biblia')" id="btn-aba-biblia">
            <span class="icone-aba">üìñ</span> B√≠blia
        </button>
        <button class="aba" onclick="mudarAba('hinarios')" id="btn-aba-hinarios">
            <span class="icone-aba">üéµ</span> Hin√°rios
        </button>
    </nav>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }

        // --- DADOS ESTRUTURAIS ---
        const antigoTestamento = [{ nome: "G√™nesis", caps: 50 }, { nome: "√äxodo", caps: 40 }, { nome: "Lev√≠tico", caps: 27 }, { nome: "N√∫meros", caps: 36 }, { nome: "Deuteron√¥mio", caps: 34 }, { nome: "Josu√©", caps: 24 }, { nome: "Ju√≠zes", caps: 21 }, { nome: "Rute", caps: 4 }, { nome: "1 Samuel", caps: 31 }, { nome: "2 Samuel", caps: 24 }, { nome: "1 Reis", caps: 22 }, { nome: "2 Reis", caps: 25 }, { nome: "1 Cr√¥nicas", caps: 29 }, { nome: "2 Cr√¥nicas", caps: 36 }, { nome: "Esdras", caps: 10 }, { nome: "Neemias", caps: 13 }, { nome: "Ester", caps: 10 }, { nome: "J√≥", caps: 42 }, { nome: "Salmos", caps: 150 }, { nome: "Prov√©rbios", caps: 31 }, { nome: "Eclesiastes", caps: 12 }, { nome: "C√¢nticos", caps: 8 }, { nome: "Isa√≠as", caps: 66 }, { nome: "Jeremias", caps: 52 }, { nome: "Lamenta√ß√µes", caps: 5 }, { nome: "Ezequiel", caps: 48 }, { nome: "Daniel", caps: 12 }, { nome: "Oseias", caps: 14 }, { nome: "Joel", caps: 3 }, { nome: "Am√≥s", caps: 9 }, { nome: "Obadias", caps: 1 }, { nome: "Jonas", caps: 4 }, { nome: "Miqueias", caps: 7 }, { nome: "Naum", caps: 3 }, { nome: "Habacuque", caps: 3 }, { nome: "Sofonias", caps: 3 }, { nome: "Ageu", caps: 2 }, { nome: "Zacarias", caps: 14 }, { nome: "Malaquias", caps: 4 }];
        const novoTestamento = [{ nome: "Mateus", caps: 28 }, { nome: "Marcos", caps: 16 }, { nome: "Lucas", caps: 24 }, { nome: "Jo√£o", caps: 21 }, { nome: "Atos", caps: 28 }, { nome: "Romanos", caps: 16 }, { nome: "1 Cor√≠ntios", caps: 16 }, { nome: "2 Cor√≠ntios", caps: 13 }, { nome: "G√°latas", caps: 6 }, { nome: "Ef√©sios", caps: 6 }, { nome: "Filipenses", caps: 4 }, { nome: "Colossenses", caps: 4 }, { nome: "1 Tessalonicenses", caps: 5 }, { nome: "2 Tessalonicenses", caps: 3 }, { nome: "1 Tim√≥teo", caps: 6 }, { nome: "2 Tim√≥teo", caps: 4 }, { nome: "Tito", caps: 3 }, { nome: "Filemom", caps: 1 }, { nome: "Hebreus", caps: 13 }, { nome: "Tiago", caps: 5 }, { nome: "1 Pedro", caps: 5 }, { nome: "2 Pedro", caps: 3 }, { nome: "1 Jo√£o", caps: 5 }, { nome: "2 Jo√£o", caps: 1 }, { nome: "3 Jo√£o", caps: 1 }, { nome: "Judas", caps: 1 }, { nome: "Apocalipse", caps: 22 }];

        // VARI√ÅVEIS DE ESTADO
        let modoAtual = 'biblia';
        let bibliaCompleta = null;
        let versaoCarregadaNome = "";
        
        let livroAtualIndex = 0; 
        let livroAtualNome = "";
        let livroAtualMaxCaps = 0;
        let capituloAtual = 1;

        let dadosHinario = [];
        let hinoAtual = 1;

        // ELEMENTOS DOM
        const corpoApp = document.getElementById('corpo-app');
        const loading = document.getElementById('loading');
        const cabecalho = document.getElementById('cabecalho-principal');
        const areaVersao = document.getElementById('area-versao');
        const rodape = document.getElementById('rodape-nav');
        const abasPrincipais = document.getElementById('abas-principais');
        const selectVersao = document.getElementById('select-versao');
        const tituloApp = document.getElementById('titulo-app');

        const tabBiblia = document.getElementById('tab-biblia');
        const tabHinarios = document.getElementById('tab-hinarios');
        
        const telaLivros = document.getElementById('tela-livros');
        const telaCapitulos = document.getElementById('tela-capitulos');
        const telaLeitura = document.getElementById('tela-leitura');
        const textoBiblico = document.getElementById('texto-biblico');
        
        const telaEscolhaHinario = document.getElementById('tela-escolha-hinario');
        const telaListaHinos = document.getElementById('tela-lista-hinos');
        const telaLeituraHino = document.getElementById('tela-leitura-hino');

        // --- INICIALIZA√á√ÉO ---
        function iniciarApp() {
            renderizarLivros();
            carregarVersaoBiblia(selectVersao.value);
        }

        async function carregarVersaoBiblia(versao) {
            if (versaoCarregadaNome === versao && bibliaCompleta) return;

            mostrarLoading(true);
            try {
                const resp = await fetch(`./${versao}.json`);
                if(!resp.ok) throw new Error("Arquivo n√£o encontrado");
                
                bibliaCompleta = await resp.json();
                versaoCarregadaNome = versao;
                console.log(`Vers√£o ${versao} carregada com sucesso!`);

                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }

            } catch (e) {
                alert(`Erro ao carregar a vers√£o ${versao}. Verifique se o arquivo JSON existe.`);
                console.error(e);
            } finally {
                mostrarLoading(false);
            }
        }

        function mudarVersao() {
            carregarVersaoBiblia(selectVersao.value);
        }

        // --- L√ìGICA DE INTERFACE ---
        
        function alternarBarras(modo) {
            // Remove imers√£o e modo leitura padr√£o
            corpoApp.classList.remove('imersivo');

            if (modo === 'leitura') {
                // ATIVA O MODO LEITURA (Header fixo e click para esconder)
                corpoApp.classList.add('modo-leitura');
                
                abasPrincipais.classList.add('escondido');
                rodape.classList.remove('escondido');
                
                if(modoAtual === 'biblia') areaVersao.classList.remove('escondido');
                else areaVersao.classList.add('escondido');

            } else { // Navega√ß√£o (Menus)
                // DESATIVA O MODO LEITURA (Header normal)
                corpoApp.classList.remove('modo-leitura');

                abasPrincipais.classList.remove('escondido');
                rodape.classList.add('escondido');
                areaVersao.classList.add('escondido');
            }
        }

        function alternarImersao() {
            // S√≥ alterna se estivermos de fato lendo (tiver a classe modo-leitura)
            if (corpoApp.classList.contains('modo-leitura')) {
                corpoApp.classList.toggle('imersivo');
            }
        }

        function mudarAba(aba) {
            modoAtual = aba;
            document.querySelectorAll('.aba').forEach(btn => btn.classList.remove('ativa'));
            document.getElementById(`btn-aba-${aba}`).classList.add('ativa');
            
            tabBiblia.classList.add('escondido');
            tabHinarios.classList.add('escondido');
            
            // Ao mudar de aba, sempre voltamos para o estado de navega√ß√£o padr√£o
            alternarBarras('navegacao');

            if (aba === 'biblia') {
                tabBiblia.classList.remove('escondido');
                tituloApp.innerText = "B√≠blia Sagrada";
                
                // Se j√° estava lendo, restaura a leitura
                if (!telaLeitura.classList.contains('escondido')) {
                    alternarBarras('leitura');
                } else {
                    // Se n√£o estava lendo, garante que o header est√° normal
                    renderizarLivros();
                }
            } else {
                tabHinarios.classList.remove('escondido');
                tituloApp.innerText = "Hin√°rios";
                
                if (telaLeituraHino.classList.contains('escondido')) {
                    telaListaHinos.classList.add('escondido');
                    telaEscolhaHinario.classList.remove('escondido');
                } else {
                    alternarBarras('leitura');
                }
            }
        }

        // --- FUN√á√ïES DA B√çBLIA ---
        
        function renderizarLivros() {
            telaLivros.innerHTML = "";
            telaCapitulos.classList.add('escondido');
            telaLeitura.classList.add('escondido');
            telaLivros.classList.remove('escondido');
            
            alternarBarras('navegacao'); // Garante header normal
            tituloApp.innerText = "B√≠blia Sagrada";

            function criarSecao(titulo, lista, offsetIndex) {
                const divTitulo = document.createElement('div');
                divTitulo.className = 'separador-testamento';
                divTitulo.innerText = titulo;
                telaLivros.appendChild(divTitulo);
                
                const grid = document.createElement('div');
                grid.className = 'grade-livros';
                
                lista.forEach((livro, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-livro';
                    btn.innerText = livro.nome;
                    const indiceGlobal = offsetIndex + index;
                    btn.onclick = () => abrirCapitulos(indiceGlobal, livro.nome, livro.caps);
                    grid.appendChild(btn);
                });
                telaLivros.appendChild(grid);
            }
            criarSecao("Antigo Testamento", antigoTestamento, 0);
            criarSecao("Novo Testamento", novoTestamento, 39);
        }

        function abrirCapitulos(indexGlobal, nome, totalCaps) {
            livroAtualIndex = indexGlobal;
            livroAtualNome = nome;
            livroAtualMaxCaps = totalCaps;
            
            tituloApp.innerText = nome;
            telaLivros.classList.add('escondido');
            telaCapitulos.classList.remove('escondido');
            telaCapitulos.innerHTML = "";
            
            alternarBarras('navegacao'); // Garante header normal

            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'btn-voltar-topo';
            btnVoltar.innerHTML = "&#11013; Escolher outro livro"; 
            btnVoltar.onclick = () => { renderizarLivros(); };
            telaCapitulos.appendChild(btnVoltar);

            for (let i = 1; i <= totalCaps; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn-capitulo';
                btn.innerText = i;
                btn.onclick = () => lerCapitulo(i);
                telaCapitulos.appendChild(btn);
            }
        }

        function lerCapitulo(numero) {
            if (!bibliaCompleta) return;
            capituloAtual = numero;
            mostrarLoading(true);

            try {
                const livroDados = bibliaCompleta[livroAtualIndex];
                if (!livroDados) throw new Error("Livro n√£o encontrado.");
                
                const capituloTextoArray = livroDados.chapters[capituloAtual - 1];
                if (!capituloTextoArray) throw new Error("Cap√≠tulo n√£o encontrado.");

                let html = "";
                capituloTextoArray.forEach((versiculo, idx) => {
                    html += `<span class="versiculo-num">${idx + 1}</span> ${versiculo}<br><br>`;
                });

                document.getElementById('titulo-capitulo-leitura').innerText = `${livroAtualNome} ${capituloAtual}`;
                textoBiblico.innerHTML = html;
                
                telaCapitulos.classList.add('escondido');
                telaLeitura.classList.remove('escondido');
                
                // AQUI ATIVA O MODO LEITURA (Header flutuante)
                alternarBarras('leitura');
                window.scrollTo(0,0);

            } catch (erro) {
                console.error(erro);
                textoBiblico.innerHTML = "<p>Erro ao carregar o texto. Verifique se o arquivo JSON est√° correto.</p>";
            } finally {
                mostrarLoading(false);
            }
        }

        // --- FUN√á√ïES DOS HIN√ÅRIOS ---

        async function abrirHinario(tipo) {
            telaEscolhaHinario.classList.add('escondido');
            mostrarLoading(true);
            
            let url = (tipo === 'harpa') ? "./harpa.json" : "./cantor.json";
            tituloApp.innerText = (tipo === 'harpa') ? "Harpa Crist√£" : "Cantor Crist√£o";

            try {
                if(dadosHinario.length === 0 || dadosHinario.tipo !== tipo) {
                    const resp = await fetch(url);
                    if(!resp.ok) throw new Error("Erro de rede");
                    
                    let json = await resp.json();
                    let listaFinal = [];

                    if (Array.isArray(json)) {
                        listaFinal = json.map(h => ({
                            numero: h.numero || h.number || h.id, 
                            titulo: h.titulo || h.title,
                            letra: h.letra || h.text || h.verses || h.lyrics
                        }));
                    } else {
                        listaFinal = Object.values(json)
                            .filter(obj => obj.hino)
                            .map(obj => {
                                let partes = obj.hino.split(" - ");
                                let num = partes[0].trim();
                                let tit = partes.length > 1 ? partes.slice(1).join(" - ").trim() : "Sem t√≠tulo";
                                let letraArr = (obj.verses && typeof obj.verses === 'object') ? Object.values(obj.verses) : obj.verses;
                                return { numero: num, titulo: tit, letra: letraArr };
                            });
                        listaFinal.sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
                    }
                    dadosHinario = listaFinal;
                    dadosHinario.tipo = tipo; 
                }
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao'); // Header normal na lista
            } catch(e) {
                alert("Erro ao abrir Hin√°rio. Verifique se o arquivo JSON existe.");
                telaEscolhaHinario.classList.remove('escondido');
            } finally {
                mostrarLoading(false);
            }
        }

        function renderizarListaHinos(filtro = "") {
            const container = document.getElementById('lista-hinos-container');
            container.innerHTML = "";
            const termo = filtro.toLowerCase();
            dadosHinario.forEach((hino, index) => {
                if(String(hino.titulo).toLowerCase().includes(termo) || String(hino.numero).includes(termo)) {
                    const div = document.createElement('div');
                    div.className = 'item-hino';
                    div.innerHTML = `<strong>${hino.numero}.</strong> ${hino.titulo}`;
                    div.onclick = () => lerHino(index);
                    container.appendChild(div);
                }
            });
        }

        function filtrarHinos() { 
            renderizarListaHinos(document.getElementById('busca-hino').value); 
        }

        function lerHino(index) {
            hinoAtual = index;
            const hino = dadosHinario[index];
            let letraRaw = hino.letra;
            let letraHTML = "";

            if (!letraRaw) {
                letraHTML = "<p>Letra indispon√≠vel.</p>";
            } else if (Array.isArray(letraRaw)) {
                letraRaw.forEach(estrofe => {
                     let texto = (typeof estrofe === 'string') ? estrofe : (estrofe.verse || estrofe.text || "");
                     letraHTML += `<div class="estrofe-hino">${texto.replace(/\n/g, '<br>')}</div>`;
                });
            } else {
                letraHTML = `<div class="estrofe-hino">${String(letraRaw).replace(/\n/g, '<br>')}</div>`;
            }

            document.getElementById('titulo-hino-leitura').innerText = `${hino.numero}. ${hino.titulo}`;
            document.getElementById('texto-hino').innerHTML = letraHTML;
            
            telaListaHinos.classList.add('escondido');
            telaLeituraHino.classList.remove('escondido');
            
            // ATIVA O MODO LEITURA (Header flutuante)
            alternarBarras('leitura');
            window.scrollTo(0,0);
        }

        function voltarParaEscolhaHinario() {
            telaListaHinos.classList.add('escondido');
            telaEscolhaHinario.classList.remove('escondido');
            tituloApp.innerText = "Hin√°rios";
            alternarBarras('navegacao');
        }

        function voltarInicioLeitura() {
            // VOLTA AO MODO NORMAL (Header fixo normal)
            alternarBarras('navegacao');
            
            if (modoAtual === 'biblia') {
                telaLeitura.classList.add('escondido');
                telaCapitulos.classList.remove('escondido');
                tituloApp.innerText = livroAtualNome;
            } else {
                telaLeituraHino.classList.add('escondido');
                telaListaHinos.classList.remove('escondido');
            }
        }

        function navegarConteudo(direcao) {
            if (modoAtual === 'biblia') {
                const novoCap = capituloAtual + direcao;
                if (novoCap < 1 || novoCap > livroAtualMaxCaps) return alert("Fim do livro.");
                lerCapitulo(novoCap);
            } else {
                const novoIndex = hinoAtual + direcao;
                if (novoIndex < 0 || novoIndex >= dadosHinario.length) return alert("Fim do hin√°rio.");
                lerHino(novoIndex);
            }
        }

        function mostrarLoading(ativo) { 
            loading.style.display = ativo ? 'block' : 'none'; 
        }

        iniciarApp();
    </script>
</body>
</html>
