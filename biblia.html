<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>B√≠blia Sagrada</title>
    
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B√≠blia">
    <meta name="theme-color" content="#2c3e50">

    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <style>
        /* --- ESTILO GERAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif; /* Fonte mais moderna */
            background-color: #fdfbf7;
            color: #111;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- CABE√áALHO --- */
        header {
            position: relative; 
            background-color: #2c3e50;
            color: white;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform;
            width: 100%;
        }

        #btn-tema {
            position: absolute;
            right: 15px;
            top: max(15px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
        }

        h1 { margin: 0; font-size: 20px; letter-spacing: 0.5px; font-weight: 600; }

        .seletor-versao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            margin: 10px auto 0 auto; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .label-versao { font-size: 13px; color: #ecf0f1; white-space: nowrap; }
        
        #select-versao {
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 14px; /* Fonte menor para caber os nomes */
            font-weight: 600;
            color: #2c3e50;
            background-color: #fff;
            width: 100%;
            flex: 1;
            text-overflow: ellipsis;
        }

        /* --- CORPO PRINCIPAL --- */
        main {
            flex: 1; 
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
            padding-top: 10px; 
            padding-bottom: 80px; 
        }

        body.modo-leitura header { position: fixed; top: 0; left: 0; right: 0; }
        body.modo-leitura main { padding-top: 140px; padding-bottom: 100px; }

        body.modo-leitura.imersivo header { transform: translateY(-100%); }
        body.modo-leitura.imersivo #rodape-nav { transform: translateY(100%); }
        body.modo-leitura.imersivo main { padding-top: calc(43px + env(safe-area-inset-top)); padding-bottom: 20px; }

        /* --- B√çBLIA E HIN√ÅRIOS --- */
        .separador-testamento {
            background-color: #d35400; color: white; padding: 10px;
            font-size: 18px; font-weight: bold; text-align: center;
            border-radius: 6px; margin: 15px; text-transform: uppercase; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-livros { 
            display: grid; gap: 10px; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            padding: 0 15px 20px 15px;
        }

        .grade-capitulos { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }

        button { touch-action: manipulation; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }

        .btn-livro, .btn-hinario {
            background-color: #ecf0f1; border: 1px solid #bdc3c7;
            padding: 12px; font-size: 15px; text-align: center;
            border-radius: 8px; cursor: pointer; font-weight: bold; color: #2c3e50;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-hinario { padding: 20px; font-size: 18px; }

        .btn-capitulo {
            padding: 12px; font-size: 18px; background-color: #fff;
            border: 1px solid #2c3e50; border-radius: 6px; cursor: pointer;
            color: #2c3e50; font-weight: bold;
        }

        .btn-voltar-topo {
            grid-column: 1 / -1; 
            background-color: #e74c3c; color: white; border: none;
            padding: 12px; font-size: 16px; border-radius: 8px;
            cursor: pointer; margin: 10px 15px 20px 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #texto-biblico, #texto-hino {
            font-size: 22px; line-height: 1.7; padding: 0 20px;
            text-align: left; margin-bottom: 40px; cursor: pointer; 
        }
        
        .versiculo-num {
            font-size: 14px; color: #e67e22; font-weight: bold;
            vertical-align: super; margin-right: 3px; user-select: none;
        }

        /* --- BUSCA --- */
        .container-busca { padding: 15px; text-align: center; }
        .wrapper-input { position: relative; display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        #input-busca { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #bdc3c7; font-size: 16px; outline: none; }
        #btn-mic { background: #e67e22; border: none; color: white; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #btn-mic.ouvindo { background-color: #e74c3c; animation: pulsando 1.5s infinite; }
        
        .resultado-item {
            background: white; border: 1px solid #eee; padding: 12px;
            border-radius: 8px; margin-bottom: 10px; text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .res-ref { font-weight: bold; color: #d35400; font-size: 15px; display: block; margin-bottom: 4px; }
        .res-texto { font-size: 15px; color: #444; line-height: 1.4; }
        .btn-comparar { margin-top: 8px; background-color: #3498db; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 13px; cursor: pointer; width: 100%; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: flex-end;
        }
        .modal-conteudo {
            background: #fff; width: 100%; height: 80vh;
            border-radius: 15px 15px 0 0; padding: 15px;
            overflow-y: auto; animation: subir 0.3s ease-out;
        }
        @keyframes subir { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulsando { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .item-comparacao { border-bottom: 1px solid #f0f0f0; padding: 12px 0; }
        .comp-versao { font-weight: bold; color: #555; font-size: 12px; background: #eee; padding: 2px 5px; border-radius: 3px; }
        .comp-texto { font-size: 16px; margin-top: 4px; display: block; color: #222; }
        .btn-fechar-modal { width: 100%; background: #e74c3c; color: white; border: none; padding: 12px; font-size: 16px; border-radius: 8px; margin-bottom: 10px; position: sticky; top: 0; z-index: 10; }

        /* --- NAVEGA√á√ÉO --- */
        #rodape-nav {
            background-color: #ecf0f1; padding: 8px; display: flex; gap: 10px;
            border-top: 1px solid #bdc3c7; position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 1000; padding-bottom: max(8px, env(safe-area-inset-bottom));
        }
        .btn-nav { flex: 1; padding: 12px 0; font-size: 20px; background-color: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .btn-voltar-menu { background-color: #d35400; font-size: 14px; }

        #abas-principais {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 65px; background-color: #fff;
            display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 900; padding-bottom: env(safe-area-inset-bottom);
        }
        .aba { flex: 1; border: none; background: transparent; font-size: 11px; font-weight: bold; color: #95a5a6; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .aba.ativa { color: #2c3e50; border-top: 3px solid #e67e22; }
        .icone-aba { font-size: 22px; margin-bottom: 2px; }

        .escondido { display: none !important; }

        /* LOADING DISCRETO */
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 25px;
            border-radius: 25px; z-index: 3000; font-size: 14px; font-weight: bold;
            display: none; backdrop-filter: blur(4px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* --- MODO ESCURO --- */
        body.modo-escuro { background-color: #121212; color: #e0e0e0; }
        body.modo-escuro header { background-color: #1f1f1f; }
        body.modo-escuro #rodape-nav, body.modo-escuro #abas-principais { background-color: #1f1f1f; border-top-color: #333; }
        body.modo-escuro .btn-livro, body.modo-escuro .btn-hinario, body.modo-escuro .btn-capitulo { background-color: #2c2c2c; border-color: #444; color: #eee; }
        body.modo-escuro .aba.ativa { color: #e0e0e0; border-top-color: #e67e22; }
        body.modo-escuro #select-versao, body.modo-escuro #input-busca { background-color: #333; color: #fff; border-color: #555; }
        body.modo-escuro .resultado-item { background-color: #2c2c2c; border-color: #444; }
        body.modo-escuro .res-texto { color: #ccc; }
        body.modo-escuro .modal-conteudo { background-color: #1f1f1f; color: #eee; }
        body.modo-escuro .item-comparacao { border-color: #333; }
        body.modo-escuro .comp-versao { background-color: #444; color: #fff; }
    </style>
</head>
<body id="corpo-app">

    <header id="cabecalho-principal">
        <button id="btn-tema" onclick="alternarTema()">üåó</button>
        <h1 id="titulo-app">B√≠blia Sagrada</h1>
        
        <div id="area-versao" class="seletor-versao-container escondido">
            <span class="label-versao">Vers√£o:</span>
            <select id="select-versao" onchange="mudarVersao()">
                <option value="NVI">NVI - Nova Vers√£o Internacional</option>
                <option value="NVT">NVT - Nova Vers√£o Transformadora</option>
                <option value="ACF">ACF - Almeida Corrigida Fiel</option>
                <option value="ARA">ARA - Almeida Revista e Atualizada</option>
                <option value="ARC">ARC - Almeida Revista e Corrigida</option>
                <option value="AA">AA - Almeida Atualizada</option>
                <option value="TB">TB - Tradu√ß√£o Brasileira</option>
                <option value="KJA">KJA - King James Atualizada</option>
                <option value="NAA">NAA - Nova Almeida Atualizada</option>
                <option value="NBV">NBV - Nova B√≠blia Viva</option>
                <option value="NTLH">NTLH - Nova Tradu√ß√£o na Linguagem de Hoje</option>
                <option value="AS21">AS21 - Almeida S√©culo 21</option>
                <option value="KJF">KJF - King James Fiel</option>
            </select>
        </div>
    </header>

    <div id="loading">‚Üª Carregando...</div>

    <main id="area-principal">
        
        <div id="tab-biblia">
            <div id="tela-livros"></div>
            <div id="tela-capitulos" class="grade-capitulos escondido"></div>
            <div id="tela-leitura" class="escondido">
                <h2 id="titulo-capitulo-leitura" style="text-align:center; margin: 10px 0;"></h2>
                <div id="texto-biblico" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-hinarios" class="escondido">
            <div id="tela-escolha-hinario" class="grade-livros" style="margin-top:20px;">
                <button class="btn-hinario" onclick="abrirHinario('harpa')">üéµ Harpa Crist√£</button>
                <button class="btn-hinario" onclick="abrirHinario('cantor')">üéº Cantor Crist√£o</button>
            </div>
            <div id="tela-lista-hinos" class="escondido">
                <button class="btn-voltar-topo" onclick="voltarParaEscolhaHinario()">&#11013; Voltar</button>
                <input type="text" id="busca-hino" placeholder="N√∫mero ou nome..." 
                       style="width:90%; padding:12px; margin: 0 auto 15px auto; display:block; font-size:16px; border-radius:8px; border:1px solid #ccc;"
                       onkeyup="filtrarHinos()">
                <div id="lista-hinos-container" class="lista-hinos"></div>
            </div>
            <div id="tela-leitura-hino" class="escondido">
                <h2 id="titulo-hino-leitura" style="text-align:center; margin: 10px 0;"></h2>
                <div id="texto-hino" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-busca" class="escondido">
            <div class="container-busca">
                <div class="wrapper-input">
                    <input type="text" id="input-busca" placeholder="Ex: O Senhor √© meu pastor..." onkeyup="if(event.key === 'Enter') realizarBusca()">
                    <button id="btn-mic" onclick="ativarMicrofone()">üé§</button>
                </div>
                <button class="btn-livro" style="width:100%; padding:10px; background-color:#3498db; color:white; border:none;" onclick="realizarBusca()">üîç Pesquisar</button>
                <br><br>
                <div id="resultados-busca"></div>
            </div>
        </div>

    </main>

    <div id="modal-comparacao" class="modal-overlay escondido">
        <div class="modal-conteudo">
            <button class="btn-fechar-modal" onclick="fecharComparacao()">Fechar</button>
            <h3 id="titulo-comparacao" style="text-align:center; margin-top:0;">Comparando</h3>
            <div id="lista-comparacao"></div>
        </div>
    </div>

    <footer id="rodape-nav" class="escondido">
        <button type="button" class="btn-nav btn-voltar-menu" onclick="voltarInicioLeitura()">Menu</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(-1)">&#9664;</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(1)">&#9654;</button>
    </footer>

    <nav id="abas-principais">
        <button class="aba ativa" onclick="mudarAba('biblia')" id="btn-aba-biblia">
            <span class="icone-aba">üìñ</span> B√≠blia
        </button>
        <button class="aba" onclick="mudarAba('busca')" id="btn-aba-busca">
            <span class="icone-aba">üîç</span> Busca
        </button>
        <button class="aba" onclick="mudarAba('hinarios')" id="btn-aba-hinarios">
            <span class="icone-aba">üéµ</span> Hin√°rios
        </button>
    </nav>

    <script>
        // --- DADOS ESTRUTURAIS FIXOS (Evita erros de "Undefined" na busca) ---
        const listaLivros = ["G√™nesis","√äxodo","Lev√≠tico","N√∫meros","Deuteron√¥mio","Josu√©","Ju√≠zes","Rute","1 Samuel","2 Samuel","1 Reis","2 Reis","1 Cr√¥nicas","2 Cr√¥nicas","Esdras","Neemias","Ester","J√≥","Salmos","Prov√©rbios","Eclesiastes","C√¢nticos","Isa√≠as","Jeremias","Lamenta√ß√µes","Ezequiel","Daniel","Oseias","Joel","Am√≥s","Obadias","Jonas","Miqueias","Naum","Habacuque","Sofonias","Ageu","Zacarias","Malaquias","Mateus","Marcos","Lucas","Jo√£o","Atos","Romanos","1 Cor√≠ntios","2 Cor√≠ntios","G√°latas","Ef√©sios","Filipenses","Colossenses","1 Tessalonicenses","2 Tessalonicenses","1 Tim√≥teo","2 Tim√≥teo","Tito","Filemom","Hebreus","Tiago","1 Pedro","2 Pedro","1 Jo√£o","2 Jo√£o","3 Jo√£o","Judas","Apocalipse"];
        
        const antigoTestamento = [{ nome: "G√™nesis", caps: 50 }, { nome: "√äxodo", caps: 40 }, { nome: "Lev√≠tico", caps: 27 }, { nome: "N√∫meros", caps: 36 }, { nome: "Deuteron√¥mio", caps: 34 }, { nome: "Josu√©", caps: 24 }, { nome: "Ju√≠zes", caps: 21 }, { nome: "Rute", caps: 4 }, { nome: "1 Samuel", caps: 31 }, { nome: "2 Samuel", caps: 24 }, { nome: "1 Reis", caps: 22 }, { nome: "2 Reis", caps: 25 }, { nome: "1 Cr√¥nicas", caps: 29 }, { nome: "2 Cr√¥nicas", caps: 36 }, { nome: "Esdras", caps: 10 }, { nome: "Neemias", caps: 13 }, { nome: "Ester", caps: 10 }, { nome: "J√≥", caps: 42 }, { nome: "Salmos", caps: 150 }, { nome: "Prov√©rbios", caps: 31 }, { nome: "Eclesiastes", caps: 12 }, { nome: "C√¢nticos", caps: 8 }, { nome: "Isa√≠as", caps: 66 }, { nome: "Jeremias", caps: 52 }, { nome: "Lamenta√ß√µes", caps: 5 }, { nome: "Ezequiel", caps: 48 }, { nome: "Daniel", caps: 12 }, { nome: "Oseias", caps: 14 }, { nome: "Joel", caps: 3 }, { nome: "Am√≥s", caps: 9 }, { nome: "Obadias", caps: 1 }, { nome: "Jonas", caps: 4 }, { nome: "Miqueias", caps: 7 }, { nome: "Naum", caps: 3 }, { nome: "Habacuque", caps: 3 }, { nome: "Sofonias", caps: 3 }, { nome: "Ageu", caps: 2 }, { nome: "Zacarias", caps: 14 }, { nome: "Malaquias", caps: 4 }];
        const novoTestamento = [{ nome: "Mateus", caps: 28 }, { nome: "Marcos", caps: 16 }, { nome: "Lucas", caps: 24 }, { nome: "Jo√£o", caps: 21 }, { nome: "Atos", caps: 28 }, { nome: "Romanos", caps: 16 }, { nome: "1 Cor√≠ntios", caps: 16 }, { nome: "2 Cor√≠ntios", caps: 13 }, { nome: "G√°latas", caps: 6 }, { nome: "Ef√©sios", caps: 6 }, { nome: "Filipenses", caps: 4 }, { nome: "Colossenses", caps: 4 }, { nome: "1 Tessalonicenses", caps: 5 }, { nome: "2 Tessalonicenses", caps: 3 }, { nome: "1 Tim√≥teo", caps: 6 }, { nome: "2 Tim√≥teo", caps: 4 }, { nome: "Tito", caps: 3 }, { nome: "Filemom", caps: 1 }, { nome: "Hebreus", caps: 13 }, { nome: "Tiago", caps: 5 }, { nome: "1 Pedro", caps: 5 }, { nome: "2 Pedro", caps: 3 }, { nome: "1 Jo√£o", caps: 5 }, { nome: "2 Jo√£o", caps: 1 }, { nome: "3 Jo√£o", caps: 1 }, { nome: "Judas", caps: 1 }, { nome: "Apocalipse", caps: 22 }];

        let modoAtual = 'biblia';
        let bibliaCompleta = null;
        let versaoCarregadaNome = "";
        let livroAtualIndex = 0; 
        let livroAtualNome = "";
        let livroAtualMaxCaps = 0;
        let capituloAtual = 1;
        let dadosHinario = [];
        let hinoAtual = 1;

        const loading = document.getElementById('loading');
        const selectVersao = document.getElementById('select-versao');
        let loadingTimeout;

        // --- INICIALIZA√á√ÉO ---
        function iniciarApp() {
            carregarTemaSalvo(); 
            renderizarLivros();
            
            // Verifica se tem vers√£o salva
            const versaoSalva = localStorage.getItem('versaoBiblia');
            if (versaoSalva) selectVersao.value = versaoSalva;
            
            carregarVersaoBiblia(selectVersao.value);
            
            // O PULO DO GATO: Cache Silencioso de todas as vers√µes
            setTimeout(cachearTodasVersoes, 3000); 

            // Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(reg => {
                        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                        reg.onupdatefound = () => {
                            const installing = reg.installing;
                            installing.onstatechange = () => {
                                if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                                    window.location.reload();
                                }
                            };
                        };
                    });
                    let refreshing;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        window.location.reload();
                        refreshing = true;
                    });
                });
            }
        }

        // --- CACHE BACKGROUND (Resolve o "Processando" eterno) ---
        async function cachearTodasVersoes() {
            const todasVersoes = ["NVI", "NVT", "ACF", "ARA", "ARC", "AA", "TB", "KJA", "NAA", "NBV", "NTLH", "AS21", "KJF"];
            console.log("Iniciando cache silencioso...");
            for (const v of todasVersoes) {
                if (v !== versaoCarregadaNome) {
                    try {
                        // Faz o fetch mas n√£o salva na RAM, apenas for√ßa o navegador/SW a guardar no disco
                        await fetch(`./${v}.json`);
                    } catch (e) { console.log("Cache falhou para " + v); }
                }
            }
            console.log("Cache silencioso conclu√≠do.");
        }

        async function carregarVersaoBiblia(versao) {
            if (versaoCarregadaNome === versao && bibliaCompleta) return;
            
            // Delay para mostrar loading apenas se demorar mais que 200ms
            loadingTimeout = setTimeout(() => { loading.style.display = 'block'; }, 200);

            try {
                const resp = await fetch(`./${versao}.json`);
                if(!resp.ok) throw new Error("Erro arquivo");
                bibliaCompleta = await resp.json();
                versaoCarregadaNome = versao;
                
                // Se estiver lendo, atualiza o texto imediatamente
                if (!document.getElementById('tela-leitura').classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao carregar vers√£o. Verifique sua conex√£o.");
            } finally {
                clearTimeout(loadingTimeout);
                loading.style.display = 'none';
            }
        }

        function mudarVersao() {
            localStorage.setItem('versaoBiblia', selectVersao.value);
            carregarVersaoBiblia(selectVersao.value);
        }

        // --- MANIPULA√á√ÉO DE TEMA ---
        function alternarTema() {
            document.body.classList.toggle('modo-escuro');
            localStorage.setItem('temaEscuro', document.body.classList.contains('modo-escuro'));
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if(metaTheme) metaTheme.setAttribute('content', document.body.classList.contains('modo-escuro') ? '#1f1f1f' : '#2c3e50');
        }
        function carregarTemaSalvo() {
            if (localStorage.getItem('temaEscuro') === 'true') {
                document.body.classList.add('modo-escuro');
                let metaTheme = document.querySelector('meta[name="theme-color"]');
                if(metaTheme) metaTheme.setAttribute('content', '#1f1f1f');
            }
        }

        // --- NAVEGA√á√ÉO E UI ---
        function alternarBarras(modo) {
            document.body.classList.remove('imersivo');
            const areaVersao = document.getElementById('area-versao');
            const rodape = document.getElementById('rodape-nav');
            const abas = document.getElementById('abas-principais');

            if (modo === 'leitura') {
                document.body.classList.add('modo-leitura');
                abas.classList.add('escondido');
                rodape.classList.remove('escondido');
                if(modoAtual === 'biblia') areaVersao.classList.remove('escondido');
                else areaVersao.classList.add('escondido');
            } else { 
                document.body.classList.remove('modo-leitura');
                abas.classList.remove('escondido');
                rodape.classList.add('escondido');
                areaVersao.classList.add('escondido');
            }
        }

        function alternarImersao() {
            if (document.body.classList.contains('modo-leitura')) {
                document.body.classList.toggle('imersivo');
            }
        }

        function mudarAba(aba) {
            modoAtual = aba;
            document.querySelectorAll('.aba').forEach(btn => btn.classList.remove('ativa'));
            document.getElementById(`btn-aba-${aba}`).classList.add('ativa');
            
            document.getElementById('tab-biblia').classList.add('escondido');
            document.getElementById('tab-busca').classList.add('escondido');
            document.getElementById('tab-hinarios').classList.add('escondido');
            
            const titulo = document.getElementById('titulo-app');
            alternarBarras('navegacao');

            if (aba === 'biblia') {
                document.getElementById('tab-biblia').classList.remove('escondido');
                titulo.innerText = "B√≠blia Sagrada";
                if (!document.getElementById('tela-leitura').classList.contains('escondido')) alternarBarras('leitura');
            } else if (aba === 'busca') {
                document.getElementById('tab-busca').classList.remove('escondido');
                titulo.innerText = "Busca Inteligente";
                document.getElementById('input-busca').focus();
            } else {
                document.getElementById('tab-hinarios').classList.remove('escondido');
                titulo.innerText = "Hin√°rios";
                if (!document.getElementById('tela-leitura-hino').classList.contains('escondido')) alternarBarras('leitura');
            }
        }

        // --- L√ìGICA B√çBLIA ---
        function renderizarLivros() {
            const tela = document.getElementById('tela-livros');
            tela.innerHTML = "";
            document.getElementById('tela-capitulos').classList.add('escondido');
            document.getElementById('tela-leitura').classList.add('escondido');
            tela.classList.remove('escondido');
            alternarBarras('navegacao'); 
            document.getElementById('titulo-app').innerText = "B√≠blia Sagrada";

            function criarSecao(titulo, lista, offsetIndex) {
                const div = document.createElement('div');
                div.className = 'separador-testamento';
                div.innerText = titulo;
                tela.appendChild(div);
                const grid = document.createElement('div');
                grid.className = 'grade-livros';
                lista.forEach((livro, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-livro';
                    btn.innerText = livro.nome;
                    const idxGlobal = offsetIndex + index;
                    btn.onclick = () => abrirCapitulos(idxGlobal, livro.nome, livro.caps);
                    grid.appendChild(btn);
                });
                tela.appendChild(grid);
            }
            criarSecao("Antigo Testamento", antigoTestamento, 0);
            criarSecao("Novo Testamento", novoTestamento, 39);
        }

        function abrirCapitulos(idx, nome, qtd) {
            livroAtualIndex = idx;
            livroAtualNome = nome;
            livroAtualMaxCaps = qtd;
            document.getElementById('titulo-app').innerText = nome;
            document.getElementById('tela-livros').classList.add('escondido');
            const telaCaps = document.getElementById('tela-capitulos');
            telaCaps.classList.remove('escondido');
            telaCaps.innerHTML = "";
            
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'btn-voltar-topo';
            btnVoltar.innerHTML = "&#11013; Escolher outro livro"; 
            btnVoltar.onclick = () => renderizarLivros();
            telaCaps.appendChild(btnVoltar);

            for (let i = 1; i <= qtd; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn-capitulo';
                btn.innerText = i;
                btn.onclick = () => lerCapitulo(i);
                telaCaps.appendChild(btn);
            }
        }

        function lerCapitulo(num) {
            if (!bibliaCompleta) return;
            capituloAtual = num;
            
            try {
                // Previne crash se o JSON estiver incompleto
                if(!bibliaCompleta[livroAtualIndex] || !bibliaCompleta[livroAtualIndex].chapters) {
                   return alert("Erro no arquivo da vers√£o atual.");
                }
                
                const textoArray = bibliaCompleta[livroAtualIndex].chapters[capituloAtual - 1];
                let html = "";
                textoArray.forEach((v, i) => {
                    html += `<span class="versiculo-num">${i + 1}</span> ${v}<br><br>`;
                });
                
                document.getElementById('titulo-capitulo-leitura').innerText = `${livroAtualNome} ${capituloAtual}`;
                document.getElementById('texto-biblico').innerHTML = html;
                
                document.getElementById('tela-capitulos').classList.add('escondido');
                document.getElementById('tela-leitura').classList.remove('escondido');
                alternarBarras('leitura');
                document.getElementById('area-principal').scrollTop = 0; 
            } catch (erro) { console.error(erro); }
        }

        // --- L√ìGICA DE BUSCA ---
        function normalizar(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,;?!]/g,"");
        }

        function ativarMicrofone() {
            const btn = document.getElementById('btn-mic');
            const input = document.getElementById('input-busca');
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return alert("Microfone n√£o suportado.");

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            
            rec.onstart = () => { btn.classList.add('ouvindo'); input.placeholder = "Ouvindo..."; };
            rec.onend = () => { btn.classList.remove('ouvindo'); input.placeholder = "Digite ou fale..."; };
            rec.onresult = (e) => {
                input.value = e.results[0][0].transcript;
                realizarBusca();
            };
            rec.start();
        }

        function realizarBusca() {
            const termo = document.getElementById('input-busca').value.trim();
            if (termo.length < 3) return alert("Digite pelo menos 3 letras.");
            if (!bibliaCompleta) return alert("Aguarde o carregamento.");

            document.getElementById('input-busca').blur();
            const container = document.getElementById('resultados-busca');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Pesquisando...</div>';

            // Pequeno timeout para renderizar o "Pesquisando"
            setTimeout(() => {
                const termoNorm = normalizar(termo);
                const palavras = termoNorm.split(" ").filter(p => p.length > 2);
                let resultados = [];

                bibliaCompleta.forEach((livroObj, idxLivro) => {
                    // Prote√ß√£o contra JSON incompleto
                    if (!livroObj.chapters) return;

                    livroObj.chapters.forEach((cap, idxCap) => {
                        cap.forEach((versiculo, idxVer) => {
                            const vNorm = normalizar(versiculo);
                            let pts = 0;
                            if (vNorm.includes(termoNorm)) pts += 100;
                            else {
                                palavras.forEach(p => { if (vNorm.includes(p)) pts += 10; });
                            }

                            if (pts > 0) {
                                // CORRE√á√ÉO: Usa listaLivros[idxLivro] ao inv√©s de livroObj.nome
                                const nomeReal = listaLivros[idxLivro] || livroObj.nome; 
                                resultados.push({
                                    livro: nomeReal,
                                    cap: idxCap + 1,
                                    ver: idxVer + 1,
                                    texto: versiculo,
                                    pontos: pts,
                                    idxLivro: idxLivro
                                });
                            }
                        });
                    });
                });

                resultados.sort((a, b) => b.pontos - a.pontos);
                const top = resultados.slice(0, 50);
                
                container.innerHTML = "";
                if (top.length === 0) container.innerHTML = "<p style='text-align:center'>Nenhum resultado.</p>";
                
                top.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resultado-item';
                    div.innerHTML = `
                        <span class="res-ref">${res.livro} ${res.cap}:${res.ver}</span>
                        <div class="res-texto">${res.texto}</div>
                        <button class="btn-comparar" onclick="compararVersoes(${res.idxLivro}, ${res.cap}, ${res.ver}, '${res.livro}')">Ver em outras vers√µes</button>
                    `;
                    // Clique no card (exceto bot√£o) leva ao texto
                    div.onclick = (e) => {
                        if(e.target.className !== 'btn-comparar') {
                            livroAtualIndex = res.idxLivro;
                            livroAtualNome = res.livro;
                            // Tenta pegar qtd caps, fallback para 50 se der erro
                            livroAtualMaxCaps = (bibliaCompleta[res.idxLivro].chapters || []).length || 50;
                            lerCapitulo(res.cap);
                            mudarAba('biblia');
                        }
                    };
                    container.appendChild(div);
                });
            }, 100);
        }

        // --- COMPARADOR ---
        async function compararVersoes(idxLivro, cap, ver, nome) {
            const modal = document.getElementById('modal-comparacao');
            const lista = document.getElementById('lista-comparacao');
            modal.classList.remove('escondido');
            document.getElementById('titulo-comparacao').innerText = `${nome} ${cap}:${ver}`;
            lista.innerHTML = "Carregando...";

            const versoes = ["NVI", "NVT", "ACF", "ARA", "ARC", "TB", "KJA", "NAA", "NBV", "NTLH", "AS21", "KJF"];
            
            // Busca paralela
            const promises = versoes.map(async v => {
                try {
                    const r = await fetch(`./${v}.json`);
                    if(r.ok) {
                        const j = await r.json();
                        // Prote√ß√£o de leitura
                        if(j[idxLivro] && j[idxLivro].chapters && j[idxLivro].chapters[cap-1]) {
                            const txt = j[idxLivro].chapters[cap-1][ver-1];
                            return `<div class="item-comparacao"><span class="comp-versao">${v}</span><span class="comp-texto">${txt}</span></div>`;
                        }
                    }
                } catch(e) {}
                return "";
            });

            const htmls = await Promise.all(promises);
            lista.innerHTML = htmls.join("");
        }

        function fecharComparacao() { document.getElementById('modal-comparacao').classList.add('escondido'); }

        // --- HIN√ÅRIOS (L√≥gica Mantida e Simplificada) ---
        async function abrirHinario(tipo) {
            document.getElementById('tela-escolha-hinario').classList.add('escondido');
            loading.style.display = 'block';
            let url = (tipo === 'harpa') ? "./harpa.json" : "./cantor.json";
            document.getElementById('titulo-app').innerText = (tipo === 'harpa') ? "Harpa Crist√£" : "Cantor Crist√£o";
            
            try {
                if(dadosHinario.tipo !== tipo) {
                    const resp = await fetch(url);
                    const json = await resp.json();
                    
                    // Normaliza formato
                    let lista = [];
                    if (Array.isArray(json)) {
                         // Formato Array
                         lista = json.map(h => ({ n: h.numero || h.id, t: h.titulo || h.title, l: h.letra || h.lyrics || h.verses }));
                    } else {
                        // Formato Objeto
                        lista = Object.values(json).filter(o => o.hino).map(o => {
                            let pts = o.hino.split(" - ");
                            return { n: pts[0].trim(), t: pts.slice(1).join(" - "), l: o.verses };
                        });
                        lista.sort((a, b) => parseInt(a.n) - parseInt(b.n));
                    }
                    dadosHinario = lista;
                    dadosHinario.tipo = tipo;
                }
                filtrarHinos();
                document.getElementById('tela-lista-hinos').classList.remove('escondido');
                alternarBarras('navegacao');
            } catch(e) { 
                alert("Erro ao abrir hin√°rio."); 
                document.getElementById('tela-escolha-hinario').classList.remove('escondido');
            } finally { loading.style.display = 'none'; }
        }

        function filtrarHinos() {
            const termo = document.getElementById('busca-hino').value.toLowerCase();
            const container = document.getElementById('lista-hinos-container');
            container.innerHTML = "";
            
            dadosHinario.forEach((h, i) => {
                if(String(h.n).includes(termo) || h.t.toLowerCase().includes(termo)) {
                    const div = document.createElement('div');
                    div.className = 'btn-livro'; // Reusa estilo
                    div.style.marginBottom = '10px';
                    div.style.textAlign = 'left';
                    div.innerHTML = `<strong>${h.n}</strong> - ${h.t}`;
                    div.onclick = () => lerHino(i);
                    container.appendChild(div);
                }
            });
        }

        function lerHino(idx) {
            hinoAtual = idx;
            const h = dadosHinario[idx];
            let html = "";
            let raw = h.l;
            if(Array.isArray(raw)) raw.forEach(e => html += `<p>${(typeof e === 'string' ? e : e.text).replace(/\n/g, '<br>')}</p>`);
            else html = `<p>${String(raw).replace(/\n/g, '<br>')}</p>`;

            document.getElementById('titulo-hino-leitura').innerText = `${h.n}. ${h.t}`;
            document.getElementById('texto-hino').innerHTML = html;
            document.getElementById('tela-lista-hinos').classList.add('escondido');
            document.getElementById('tela-leitura-hino').classList.remove('escondido');
            alternarBarras('leitura');
            document.getElementById('area-principal').scrollTop = 0;
        }

        function voltarParaEscolhaHinario() {
            document.getElementById('tela-lista-hinos').classList.add('escondido');
            document.getElementById('tela-escolha-hinario').classList.remove('escondido');
            document.getElementById('titulo-app').innerText = "Hin√°rios";
        }

        function voltarInicioLeitura() {
            alternarBarras('navegacao');
            if (modoAtual === 'biblia') {
                document.getElementById('tela-leitura').classList.add('escondido');
                document.getElementById('tela-capitulos').classList.remove('escondido');
                document.getElementById('titulo-app').innerText = livroAtualNome;
            } else {
                document.getElementById('tela-leitura-hino').classList.add('escondido');
                document.getElementById('tela-lista-hinos').classList.remove('escondido');
            }
        }

        function navegarConteudo(dir) {
            if (modoAtual === 'biblia') {
                let n = capituloAtual + dir;
                if (n > 0 && n <= livroAtualMaxCaps) lerCapitulo(n);
            } else {
                let n = hinoAtual + dir;
                if (n >= 0 && n < dadosHinario.length) lerHino(n);
            }
        }

        iniciarApp();
    </script>
</body>
</html>
