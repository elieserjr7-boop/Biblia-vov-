<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>B√≠blia Sagrada</title>
    
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B√≠blia">
    <meta name="theme-color" content="#2c3e50">

    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <style>
        /* --- ESTILO GERAL --- */
        * { box-sizing: border-box; }

        body {
            font-family: 'Verdana', sans-serif;
            background-color: #fdfbf7;
            color: #111;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- CABE√áALHO --- */
        header {
            position: relative; 
            background-color: #2c3e50;
            color: white;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
            will-change: transform;
            width: 100%;
        }

        #btn-tema {
            position: absolute;
            right: 15px;
            top: max(15px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
        }

        h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px; }

        .seletor-versao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            margin: 10px auto 0 auto; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .label-versao { font-size: 14px; font-weight: normal; color: #ecf0f1; white-space: nowrap; }
        
        #select-versao {
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            width: 100%;
            flex: 1;
        }

        /* --- CORPO PRINCIPAL --- */
        main {
            flex: 1; 
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
            padding-top: 10px; 
            padding-bottom: 80px; 
            transition: padding-top 0.3s ease;
        }

        /* MODO LEITURA */
        body.modo-leitura header { position: fixed; top: 0; left: 0; right: 0; }
        body.modo-leitura main { padding-top: 140px; padding-bottom: 100px; }
        body.modo-leitura.imersivo header { transform: translateY(-100%); }
        body.modo-leitura.imersivo #rodape-nav { transform: translateY(100%); }
        body.modo-leitura.imersivo main { padding-top: calc(43px + env(safe-area-inset-top)); padding-bottom: 20px; }

        /* --- ELEMENTOS VISUAIS --- */
        .separador-testamento {
            background-color: #d35400; color: white; padding: 12px;
            font-size: 20px; font-weight: bold; text-align: center;
            border-radius: 8px; margin: 15px 15px 15px 15px;
            text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-livros { 
            display: grid; gap: 12px; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            padding: 0 15px 20px 15px;
        }

        .grade-capitulos { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }

        button { touch-action: manipulation; transition: background-color 0.3s, color 0.3s; }
        button:active { transform: scale(0.96); opacity: 0.8; }

        .btn-livro, .btn-hinario {
            background-color: #ecf0f1; border: 2px solid #bdc3c7;
            padding: 15px; font-size: 16px; text-align: center;
            border-radius: 10px; cursor: pointer; font-weight: bold; color: #2c3e50;
        }
        
        .btn-hinario { padding: 20px; font-size: 18px; }

        .btn-capitulo {
            padding: 15px; font-size: 20px; background-color: #fff;
            border: 2px solid #2c3e50; border-radius: 8px; cursor: pointer;
            color: #2c3e50; font-weight: bold;
        }

        .btn-voltar-topo {
            grid-column: 1 / -1; 
            background-color: #e74c3c; color: white; border: none;
            padding: 15px; font-size: 18px; border-radius: 12px;
            cursor: pointer; margin: 10px 15px 20px 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #texto-biblico, #texto-hino {
            font-size: 24px; line-height: 1.8; padding: 0 20px;
            text-align: left; margin-bottom: 40px; cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .versiculo-num {
            font-size: 16px; color: #e67e22; font-weight: bold;
            vertical-align: super; margin-right: 4px; user-select: none;
        }

        /* --- ABA BUSCA --- */
        .container-busca { padding: 15px; text-align: center; }
        
        .wrapper-input {
            position: relative; display: flex; gap: 10px; align-items: center; margin-bottom: 20px;
        }
        
        #input-busca {
            flex: 1; padding: 15px; border-radius: 25px; border: 2px solid #bdc3c7;
            font-size: 18px; outline: none; font-family: 'Verdana', sans-serif;
        }
        
        #btn-mic {
            background: #e67e22; border: none; color: white;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #btn-mic.ouvindo {
            background-color: #e74c3c; animation: pulsando 1.5s infinite;
        }
        
        @keyframes pulsando {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .resultado-item {
            background: white; border: 1px solid #ddd; padding: 15px;
            border-radius: 8px; margin-bottom: 15px; text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .res-ref { font-weight: bold; color: #d35400; font-size: 16px; margin-bottom: 5px; display: block; }
        .res-texto { font-size: 16px; color: #333; line-height: 1.5; }
        
        .btn-comparar {
            margin-top: 10px; background-color: #3498db; color: white; border: none;
            padding: 10px; border-radius: 5px; font-size: 14px; cursor: pointer;
            width: 100%; font-family: 'Verdana', sans-serif; font-weight: bold;
        }

        /* Modal Compara√ß√£o */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; align-items: flex-end; 
        }
        .modal-conteudo {
            background: #fff; width: 100%; height: 85vh;
            border-radius: 20px 20px 0 0; padding: 20px;
            overflow-y: auto; position: relative;
            animation: subir 0.3s ease-out;
        }
        @keyframes subir { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .item-comparacao { border-bottom: 1px solid #eee; padding: 15px 0; }
        .comp-versao { font-weight: bold; color: #2c3e50; font-size: 14px; background: #ecf0f1; padding: 2px 6px; border-radius: 4px; }
        .comp-texto { font-size: 18px; margin-top: 5px; display: block; }

        .btn-fechar-modal {
            position: sticky; top: 0; width: 100%; background: #e74c3c; color: white;
            border: none; padding: 15px; font-size: 16px; font-weight: bold;
            border-radius: 10px; margin-bottom: 15px; z-index: 10;
        }

        .lista-hinos { display: flex; flex-direction: column; gap: 10px; padding: 0 15px; }

        /* UTILIT√ÅRIOS */
        .escondido { display: none !important; }

        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #e67e22; background: rgba(255,255,255,0.95);
            padding: 20px; border-radius: 10px; z-index: 2000;
            display: none; width: 80%; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- MODO ESCURO --- */
        body.modo-escuro { background-color: #121212; color: #e0e0e0; }
        body.modo-escuro header { background-color: #1f1f1f; }
        body.modo-escuro #rodape-nav { background-color: #1f1f1f; border-top-color: #333; }
        body.modo-escuro #abas-principais { background-color: #1f1f1f; border-top-color: #333; }
        
        body.modo-escuro .btn-livro, 
        body.modo-escuro .btn-hinario {
            background-color: #2c2c2c; border-color: #444; color: #eee;
        }
        body.modo-escuro .btn-capitulo { background-color: #2c2c2c; border-color: #444; color: #eee; }
        body.modo-escuro .item-hino { background-color: #2c2c2c; border-color: #444; color: #eee; }
        
        body.modo-escuro .btn-nav { background-color: #333; }
        body.modo-escuro .btn-voltar-menu { background-color: #a04000; }
        
        body.modo-escuro .aba.ativa { background-color: #2c2c2c; color: #e0e0e0; border-top-color: #e67e22; }
        body.modo-escuro #select-versao { background-color: #333; color: #fff; }
        body.modo-escuro input#busca-hino { background-color: #333; color: #fff; border-color: #555; }
        
        body.modo-escuro #input-busca { background-color: #333; color: #fff; border-color: #555; }
        body.modo-escuro .resultado-item { background-color: #2c2c2c; border-color: #444; }
        body.modo-escuro .res-texto { color: #ccc; }
        body.modo-escuro .modal-conteudo { background-color: #1f1f1f; color: #eee; }
        body.modo-escuro .item-comparacao { border-color: #333; }
        body.modo-escuro .comp-versao { background-color: #444; color: #fff; }
        body.modo-escuro .comp-texto { color: #e0e0e0; }

    </style>
</head>
<body id="corpo-app">

    <header id="cabecalho-principal">
        <button id="btn-tema" onclick="alternarTema()">üåó</button>
        <h1 id="titulo-app">B√≠blia Sagrada</h1>
        
        <div id="area-versao" class="seletor-versao-container escondido">
            <span class="label-versao">Vers√£o:</span>
            <select id="select-versao" onchange="mudarVersao()">
                <option value="NVI">NVI - Nova Vers√£o Internacional</option>
                <option value="NVT">NVT - Nova Vers√£o Transformadora</option>
                <option value="ACF">ACF - Almeida Corrigida Fiel</option>
                <option value="ARA">ARA - Almeida Revista e Atualizada</option>
                <option value="ARC">ARC - Almeida Revista e Corrigida</option>
                <option value="JFAA">JFA - Jo√£o Ferreira de Almeida</option>
                <option value="TB">TB - Tradu√ß√£o Brasileira</option>
                <option value="KJA">KJA - King James Atualizada</option>
                <option value="NAA">NAA - Nova Almeida Atualizada</option>
                <option value="NBV">NBV - Nova B√≠blia Viva</option>
                <option value="NTLH">NTLH - Nova Tradu√ß√£o Linguagem de Hoje</option>
                <option value="AS21">A21 - Almeida S√©culo 21</option>
                <option value="KJF">KJF - King James Fiel</option>
            </select>
        </div>
    </header>

    <div id="loading">‚è≥ Carregando...</div>

    <main id="area-principal">
        
        <div id="tab-biblia">
            <div id="tela-livros"></div>
            <div id="tela-capitulos" class="grade-capitulos escondido"></div>
            
            <div id="tela-leitura" class="escondido">
                <h2 id="titulo-capitulo-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-biblico" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-hinarios" class="escondido">
            <div id="tela-escolha-hinario" class="grade-livros" style="margin-top:20px;">
                <button class="btn-hinario" onclick="abrirHinario('harpa')">üéµ Harpa Crist√£</button>
                <button class="btn-hinario" onclick="abrirHinario('cantor')">üéº Cantor Crist√£o</button>
            </div>

            <div id="tela-lista-hinos" class="escondido">
                <button class="btn-voltar-topo" onclick="voltarParaEscolhaHinario()">&#11013; Voltar aos Hin√°rios</button>
                <input type="text" id="busca-hino" placeholder="N√∫mero ou nome..." 
                       style="width:90%; padding:15px; margin: 0 auto 15px auto; display:block; font-size:18px; border-radius:8px; border:1px solid #ccc;"
                       onkeyup="filtrarHinos()">
                <div id="lista-hinos-container" class="lista-hinos"></div>
            </div>

            <div id="tela-leitura-hino" class="escondido">
                <h2 id="titulo-hino-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-hino" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-busca" class="escondido">
            <div class="container-busca">
                <div class="wrapper-input">
                    <input type="text" id="input-busca" placeholder="Digite ou fale (ex: Jesus chorou)..." onkeyup="if(event.key === 'Enter') realizarBusca()">
                    <button id="btn-mic" onclick="ativarMicrofone()">üé§</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-livro" style="flex: 1; padding:15px; background-color:#3498db; color:white; border:none;" onclick="realizarBusca()">üîç Pesquisar</button>
                    <button class="btn-livro" style="width: 70px; padding:15px; background-color:#95a5a6; color:white; border:none;" onclick="limparBusca()">üóë</button>
                </div>

                <div id="resultados-busca"></div>
            </div>
        </div>

    </main>

    <div id="modal-comparacao" class="modal-overlay escondido">
        <div class="modal-conteudo">
            <button class="btn-fechar-modal" onclick="fecharComparacao()">Fechar</button>
            <h3 id="titulo-comparacao" style="text-align:center; margin-top:0;">Comparando</h3>
            <div id="lista-comparacao"></div>
        </div>
    </div>

    <footer id="rodape-nav" class="escondido">
        <button type="button" class="btn-nav btn-voltar-menu" onclick="voltarInicioLeitura()">Voltar</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(-1)">&#9664;</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(1)">&#9654;</button>
    </footer>

    <nav id="abas-principais">
        <button class="aba ativa" onclick="mudarAba('biblia')" id="btn-aba-biblia">
            <span class="icone-aba">üìñ</span> B√≠blia
        </button>
        <button class="aba" onclick="mudarAba('busca')" id="btn-aba-busca">
            <span class="icone-aba">üîç</span> Busca
        </button>
        <button class="aba" onclick="mudarAba('hinarios')" id="btn-aba-hinarios">
            <span class="icone-aba">üéµ</span> Hin√°rios
        </button>
    </nav>

    <script>
        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    if (registration.waiting) { registration.waiting.postMessage({ type: 'SKIP_WAITING' }); }
                    // Update force reload logic
                    let refreshing;
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        window.location.reload();
                        refreshing = true;
                    });
                });
            });
        }

        const listaLivros = ["G√™nesis","√äxodo","Lev√≠tico","N√∫meros","Deuteron√¥mio","Josu√©","Ju√≠zes","Rute","1 Samuel","2 Samuel","1 Reis","2 Reis","1 Cr√¥nicas","2 Cr√¥nicas","Esdras","Neemias","Ester","J√≥","Salmos","Prov√©rbios","Eclesiastes","C√¢nticos","Isa√≠as","Jeremias","Lamenta√ß√µes","Ezequiel","Daniel","Oseias","Joel","Am√≥s","Obadias","Jonas","Miqueias","Naum","Habacuque","Sofonias","Ageu","Zacarias","Malaquias","Mateus","Marcos","Lucas","Jo√£o","Atos","Romanos","1 Cor√≠ntios","2 Cor√≠ntios","G√°latas","Ef√©sios","Filipenses","Colossenses","1 Tessalonicenses","2 Tessalonicenses","1 Tim√≥teo","2 Tim√≥teo","Tito","Filemom","Hebreus","Tiago","1 Pedro","2 Pedro","1 Jo√£o","2 Jo√£o","3 Jo√£o","Judas","Apocalipse"];
        const antigoTestamento = [{ nome: "G√™nesis", caps: 50 }, { nome: "√äxodo", caps: 40 }, { nome: "Lev√≠tico", caps: 27 }, { nome: "N√∫meros", caps: 36 }, { nome: "Deuteron√¥mio", caps: 34 }, { nome: "Josu√©", caps: 24 }, { nome: "Ju√≠zes", caps: 21 }, { nome: "Rute", caps: 4 }, { nome: "1 Samuel", caps: 31 }, { nome: "2 Samuel", caps: 24 }, { nome: "1 Reis", caps: 22 }, { nome: "2 Reis", caps: 25 }, { nome: "1 Cr√¥nicas", caps: 29 }, { nome: "2 Cr√¥nicas", caps: 36 }, { nome: "Esdras", caps: 10 }, { nome: "Neemias", caps: 13 }, { nome: "Ester", caps: 10 }, { nome: "J√≥", caps: 42 }, { nome: "Salmos", caps: 150 }, { nome: "Prov√©rbios", caps: 31 }, { nome: "Eclesiastes", caps: 12 }, { nome: "C√¢nticos", caps: 8 }, { nome: "Isa√≠as", caps: 66 }, { nome: "Jeremias", caps: 52 }, { nome: "Lamenta√ß√µes", caps: 5 }, { nome: "Ezequiel", caps: 48 }, { nome: "Daniel", caps: 12 }, { nome: "Oseias", caps: 14 }, { nome: "Joel", caps: 3 }, { nome: "Am√≥s", caps: 9 }, { nome: "Obadias", caps: 1 }, { nome: "Jonas", caps: 4 }, { nome: "Miqueias", caps: 7 }, { nome: "Naum", caps: 3 }, { nome: "Habacuque", caps: 3 }, { nome: "Sofonias", caps: 3 }, { nome: "Ageu", caps: 2 }, { nome: "Zacarias", caps: 14 }, { nome: "Malaquias", caps: 4 }];
        const novoTestamento = [{ nome: "Mateus", caps: 28 }, { nome: "Marcos", caps: 16 }, { nome: "Lucas", caps: 24 }, { nome: "Jo√£o", caps: 21 }, { nome: "Atos", caps: 28 }, { nome: "Romanos", caps: 16 }, { nome: "1 Cor√≠ntios", caps: 16 }, { nome: "2 Cor√≠ntios", caps: 13 }, { nome: "G√°latas", caps: 6 }, { nome: "Ef√©sios", caps: 6 }, { nome: "Filipenses", caps: 4 }, { nome: "Colossenses", caps: 4 }, { nome: "1 Tessalonicenses", caps: 5 }, { nome: "2 Tessalonicenses", caps: 3 }, { nome: "1 Tim√≥teo", caps: 6 }, { nome: "2 Tim√≥teo", caps: 4 }, { nome: "Tito", caps: 3 }, { nome: "Filemom", caps: 1 }, { nome: "Hebreus", caps: 13 }, { nome: "Tiago", caps: 5 }, { nome: "1 Pedro", caps: 5 }, { nome: "2 Pedro", caps: 3 }, { nome: "1 Jo√£o", caps: 5 }, { nome: "2 Jo√£o", caps: 1 }, { nome: "3 Jo√£o", caps: 1 }, { nome: "Judas", caps: 1 }, { nome: "Apocalipse", caps: 22 }];

        // VARI√ÅVEIS DE ESTADO
        let modoAtual = 'biblia';
        let bibliaCompleta = null;
        let versaoCarregadaNome = "";
        
        let livroAtualIndex = 0; 
        let livroAtualNome = "";
        let livroAtualMaxCaps = 0;
        let capituloAtual = 1;

        let dadosHinario = [];
        let hinoAtual = 1;

        // ELEMENTOS DOM
        const corpoApp = document.getElementById('corpo-app');
        const loading = document.getElementById('loading');
        const areaVersao = document.getElementById('area-versao');
        const rodape = document.getElementById('rodape-nav');
        const abasPrincipais = document.getElementById('abas-principais');
        const selectVersao = document.getElementById('select-versao');
        const tituloApp = document.getElementById('titulo-app');
        const areaPrincipal = document.getElementById('area-principal');

        const tabBiblia = document.getElementById('tab-biblia');
        const tabBusca = document.getElementById('tab-busca');
        const tabHinarios = document.getElementById('tab-hinarios');
        
        const telaLivros = document.getElementById('tela-livros');
        const telaCapitulos = document.getElementById('tela-capitulos');
        const telaLeitura = document.getElementById('tela-leitura');
        const textoBiblico = document.getElementById('texto-biblico');
        
        const telaEscolhaHinario = document.getElementById('tela-escolha-hinario');
        const telaListaHinos = document.getElementById('tela-lista-hinos');
        const telaLeituraHino = document.getElementById('tela-leitura-hino');

        // --- INICIALIZA√á√ÉO ---
        function iniciarApp() {
            carregarTemaSalvo(); 
            renderizarLivros();
            
            const versaoSalva = localStorage.getItem('versaoBiblia') || "NVI";
            selectVersao.value = versaoSalva;
            carregarVersaoBiblia(versaoSalva);

            // CACHE SILENCIOSO
            setTimeout(cachearTodasVersoes, 2000);
        }

        async function cachearTodasVersoes() {
            const todas = ["NVI", "NVT", "ACF", "ARA", "ARC", "AA", "TB", "KJA", "NAA", "NBV", "NTLH", "AS21", "KJF"];
            for (const v of todas) {
                if (v !== versaoCarregadaNome) {
                    // Fetch simples sem timestamp para usar/criar cache
                    try { await fetch(`./${v}.json`); } catch (e) {}
                }
            }
        }

        // --- GEST√ÉO DE TEMAS ---
        function alternarTema() {
            document.body.classList.toggle('modo-escuro');
            localStorage.setItem('temaEscuro', document.body.classList.contains('modo-escuro'));
        }

        function carregarTemaSalvo() {
            if (localStorage.getItem('temaEscuro') === 'true') {
                document.body.classList.add('modo-escuro');
            }
        }

        // --- CARREGAMENTO DE VERS√ÉO (CORRIGIDO: SEM LOADER VISUAL, SEM TIMESTAMP) ---
        async function carregarVersaoBiblia(versao) {
            if (versaoCarregadaNome === versao && bibliaCompleta) return;

            // N√ÉO mostramos loading visualmente na troca, como solicitado.
            // loading.style.display = 'block'; <--- Removido

            try {
                // Sem timestamp (?t=...) para usar o cache do navegador
                const resp = await fetch(`./${versao}.json`);
                
                if(!resp.ok) throw new Error("Erro");
                
                bibliaCompleta = await resp.json();
                versaoCarregadaNome = versao;

                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }

            } catch (e) {
                // S√≥ avisa se der erro grave, sem travar loading
                console.error(e);
            }
        }

        function mudarVersao() {
            localStorage.setItem('versaoBiblia', selectVersao.value);
            carregarVersaoBiblia(selectVersao.value);
        }

        // --- L√ìGICA DE INTERFACE ---
        function alternarBarras(modo) {
            corpoApp.classList.remove('imersivo');

            if (modo === 'leitura') {
                corpoApp.classList.add('modo-leitura');
                abasPrincipais.classList.add('escondido');
                rodape.classList.remove('escondido');
                if(modoAtual === 'biblia') areaVersao.classList.remove('escondido');
                else areaVersao.classList.add('escondido');
            } else { 
                corpoApp.classList.remove('modo-leitura');
                abasPrincipais.classList.remove('escondido');
                rodape.classList.add('escondido');
                areaVersao.classList.add('escondido');
            }
        }

        function alternarImersao() {
            if (corpoApp.classList.contains('modo-leitura')) {
                corpoApp.classList.toggle('imersivo');
            }
        }

        function mudarAba(aba) {
            modoAtual = aba;
            document.querySelectorAll('.aba').forEach(btn => btn.classList.remove('ativa'));
            document.getElementById(`btn-aba-${aba}`).classList.add('ativa');
            
            tabBiblia.classList.add('escondido');
            tabBusca.classList.add('escondido');
            tabHinarios.classList.add('escondido');
            
            const titulo = document.getElementById('titulo-app');
            alternarBarras('navegacao');

            if (aba === 'biblia') {
                tabBiblia.classList.remove('escondido');
                titulo.innerText = "B√≠blia Sagrada";
                if (!telaLeitura.classList.contains('escondido')) alternarBarras('leitura');
            } else if (aba === 'busca') {
                tabBusca.classList.remove('escondido');
                titulo.innerText = "Busca Inteligente";
                document.getElementById('input-busca').focus();
            } else {
                tabHinarios.classList.remove('escondido');
                titulo.innerText = "Hin√°rios";
                if (!telaLeituraHino.classList.contains('escondido')) alternarBarras('leitura');
            }
        }

        // --- B√çBLIA ---
        function renderizarLivros() {
            telaLivros.innerHTML = "";
            telaCapitulos.classList.add('escondido');
            telaLeitura.classList.add('escondido');
            telaLivros.classList.remove('escondido');
            alternarBarras('navegacao'); 
            tituloApp.innerText = "B√≠blia Sagrada";

            function criarSecao(titulo, lista, offsetIndex) {
                const divTitulo = document.createElement('div');
                divTitulo.className = 'separador-testamento';
                divTitulo.innerText = titulo;
                telaLivros.appendChild(divTitulo);
                const grid = document.createElement('div');
                grid.className = 'grade-livros';
                lista.forEach((livro, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-livro';
                    btn.innerText = livro.nome;
                    const indiceGlobal = offsetIndex + index;
                    btn.onclick = () => abrirCapitulos(indiceGlobal, livro.nome, livro.caps);
                    grid.appendChild(btn);
                });
                telaLivros.appendChild(grid);
            }
            criarSecao("Antigo Testamento", antigoTestamento, 0);
            criarSecao("Novo Testamento", novoTestamento, 39);
        }

        function abrirCapitulos(indexGlobal, nome, totalCaps) {
            livroAtualIndex = indexGlobal;
            livroAtualNome = nome;
            livroAtualMaxCaps = totalCaps;
            tituloApp.innerText = nome;
            telaLivros.classList.add('escondido');
            telaCapitulos.classList.remove('escondido');
            telaCapitulos.innerHTML = "";
            
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'btn-voltar-topo';
            btnVoltar.innerHTML = "&#11013; Escolher outro livro"; 
            btnVoltar.onclick = () => { renderizarLivros(); };
            telaCapitulos.appendChild(btnVoltar);

            for (let i = 1; i <= totalCaps; i++) {
                const btn = document.createElement('button');
                btn.className = 'btn-capitulo';
                btn.innerText = i;
                btn.onclick = () => lerCapitulo(i);
                telaCapitulos.appendChild(btn);
            }
        }

        function lerCapitulo(numero) {
            if (!bibliaCompleta) return;
            capituloAtual = numero;
            
            try {
                if (!bibliaCompleta[livroAtualIndex] || !bibliaCompleta[livroAtualIndex].chapters) return;
                const capituloTextoArray = bibliaCompleta[livroAtualIndex].chapters[capituloAtual - 1];
                let html = "";
                capituloTextoArray.forEach((versiculo, idx) => {
                    html += `<span class="versiculo-num">${idx + 1}</span> ${versiculo}<br><br>`;
                });
                document.getElementById('titulo-capitulo-leitura').innerText = `${livroAtualNome} ${capituloAtual}`;
                textoBiblico.innerHTML = html;
                telaCapitulos.classList.add('escondido');
                telaLeitura.classList.remove('escondido');
                alternarBarras('leitura');
                areaPrincipal.scrollTop = 0; 
                window.scrollTo(0,0);
            } catch (erro) { console.error(erro); }
        }

        // --- BUSCA INTELIGENTE ---
        function normalizar(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,;?!]/g,"");
        }

        function ativarMicrofone() {
            const btn = document.getElementById('btn-mic');
            const input = document.getElementById('input-busca');
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return alert("Microfone n√£o suportado.");

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            
            rec.onstart = () => { btn.classList.add('ouvindo'); input.placeholder = "Ouvindo..."; };
            rec.onend = () => { btn.classList.remove('ouvindo'); input.placeholder = "Digite ou fale..."; };
            rec.onresult = (e) => {
                input.value = e.results[0][0].transcript;
                realizarBusca();
            };
            rec.start();
        }

        function realizarBusca() {
            const termo = document.getElementById('input-busca').value.trim();
            if (termo.length < 3) return alert("Digite pelo menos 3 letras.");
            if (!bibliaCompleta) return alert("Aguarde o carregamento.");

            document.getElementById('input-busca').blur();
            const container = document.getElementById('resultados-busca');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Pesquisando...</div>';

            setTimeout(() => {
                const termoNorm = normalizar(termo);
                const palavras = termoNorm.split(" ").filter(p => p.length > 2);
                let resultados = [];

                bibliaCompleta.forEach((livroObj, idxLivro) => {
                    if (!livroObj.chapters) return;
                    livroObj.chapters.forEach((cap, idxCap) => {
                        cap.forEach((versiculo, idxVer) => {
                            const vNorm = normalizar(versiculo);
                            let pts = 0;
                            if (vNorm.includes(termoNorm)) pts += 100;
                            else {
                                palavras.forEach(p => { if (vNorm.includes(p)) pts += 10; });
                            }
                            if (pts > 0) {
                                const nomeReal = listaLivros[idxLivro] || livroObj.nome; 
                                resultados.push({ livro: nomeReal, cap: idxCap + 1, ver: idxVer + 1, texto: versiculo, pontos: pts, idxLivro: idxLivro });
                            }
                        });
                    });
                });

                resultados.sort((a, b) => b.pontos - a.pontos);
                const top = resultados.slice(0, 50);
                
                container.innerHTML = "";
                if (top.length === 0) container.innerHTML = "<p style='text-align:center'>Nenhum resultado.</p>";
                
                top.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resultado-item';
                    div.innerHTML = `
                        <span class="res-ref">${res.livro} ${res.cap}:${res.ver}</span>
                        <div class="res-texto">${res.texto}</div>
                        <button class="btn-comparar" onclick="compararVersoes(${res.idxLivro}, ${res.cap}, ${res.ver}, '${res.livro}')">Ver em outras vers√µes</button>
                    `;
                    div.onclick = (e) => {
                        if(e.target.className !== 'btn-comparar') {
                            livroAtualIndex = res.idxLivro;
                            livroAtualNome = res.livro;
                            livroAtualMaxCaps = (bibliaCompleta[res.idxLivro].chapters || []).length || 50;
                            lerCapitulo(res.cap);
                            mudarAba('biblia');
                        }
                    };
                    container.appendChild(div);
                });
            }, 100);
        }

        // --- FUN√á√ÉO LIMPAR BUSCA ---
        function limparBusca() {
            document.getElementById('input-busca').value = ""; 
            document.getElementById('resultados-busca').innerHTML = ""; 
            document.getElementById('input-busca').focus(); 
        }

        // --- COMPARADOR ---
        async function compararVersoes(idxLivro, cap, ver, nome) {
            const modal = document.getElementById('modal-comparacao');
            const lista = document.getElementById('lista-comparacao');
            modal.classList.remove('escondido');
            document.getElementById('titulo-comparacao').innerText = `${nome} ${cap}:${ver}`;
            lista.innerHTML = "Carregando...";

            const versoes = ["NVI", "NVT", "ACF", "ARA", "ARC", "AA", "TB", "KJA", "NAA", "NBV", "NTLH", "AS21", "KJF"];
            
            const promises = versoes.map(async v => {
                try {
                    const r = await fetch(`./${v}.json`);
                    if(r.ok) {
                        const j = await r.json();
                        if(j[idxLivro] && j[idxLivro].chapters && j[idxLivro].chapters[cap-1]) {
                            const txt = j[idxLivro].chapters[cap-1][ver-1];
                            return `<div class="item-comparacao"><span class="comp-versao">${v}</span><span class="comp-texto">${txt}</span></div>`;
                        }
                    }
                } catch(e) {}
                return "";
            });
            const htmls = await Promise.all(promises);
            lista.innerHTML = htmls.join("");
        }

        function fecharComparacao() { document.getElementById('modal-comparacao').classList.add('escondido'); }

        // --- HIN√ÅRIOS ---
        async function abrirHinario(tipo) {
            document.getElementById('tela-escolha-hinario').classList.add('escondido');
            loading.style.display = 'block';
            let url = (tipo === 'harpa') ? "./harpa.json" : "./cantor.json";
            document.getElementById('titulo-app').innerText = (tipo === 'harpa') ? "Harpa Crist√£" : "Cantor Crist√£o";

            try {
                if(dadosHinario.length === 0 || dadosHinario.tipo !== tipo) {
                    const resp = await fetch(url);
                    if(!resp.ok) throw new Error("Erro de rede");
                    
                    let json = await resp.json();
                    let listaFinal = [];

                    if (Array.isArray(json)) {
                        listaFinal = json.map(h => ({
                            numero: h.numero || h.number || h.id, 
                            titulo: h.titulo || h.title,
                            letra: h.letra || h.text || h.verses || h.lyrics
                        }));
                    } else {
                        listaFinal = Object.values(json)
                            .filter(obj => obj.hino)
                            .map(obj => {
                                let partes = obj.hino.split(" - ");
                                let num = partes[0].trim();
                                let tit = partes.length > 1 ? partes.slice(1).join(" - ").trim() : "Sem t√≠tulo";
                                let letraArr = (obj.verses && typeof obj.verses === 'object') ? Object.values(obj.verses) : obj.verses;
                                return { numero: num, titulo: tit, letra: letraArr };
                            });
                        listaFinal.sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
                    }
                    dadosHinario = listaFinal;
                    dadosHinario.tipo = tipo; 
                }
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao');
            } catch(e) {
                alert("Erro ao abrir Hin√°rio. Verifique se o arquivo JSON existe.");
                telaEscolhaHinario.classList.remove('escondido');
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderizarListaHinos(filtro = "") {
            const container = document.getElementById('lista-hinos-container');
            container.innerHTML = "";
            const termo = filtro.toLowerCase();
            dadosHinario.forEach((hino, index) => {
                if(String(hino.titulo).toLowerCase().includes(termo) || String(hino.numero).includes(termo)) {
                    const div = document.createElement('div');
                    div.className = 'item-hino';
                    div.innerHTML = `<strong>${hino.numero}.</strong> ${hino.titulo}`;
                    div.onclick = () => lerHino(index);
                    container.appendChild(div);
                }
            });
        }

        function filtrarHinos() { 
            renderizarListaHinos(document.getElementById('busca-hino').value); 
        }

        function lerHino(index) {
            hinoAtual = index;
            const hino = dadosHinario[index];
            let letraRaw = hino.letra;
            let letraHTML = "";

            if (!letraRaw) {
                letraHTML = "<p>Letra indispon√≠vel.</p>";
            } else if (Array.isArray(letraRaw)) {
                letraRaw.forEach(estrofe => {
                     let texto = (typeof estrofe === 'string') ? estrofe : (estrofe.verse || estrofe.text || "");
                     letraHTML += `<div class="estrofe-hino">${texto.replace(/\n/g, '<br>')}</div>`;
                });
            } else {
                letraHTML = `<div class="estrofe-hino">${String(letraRaw).replace(/\n/g, '<br>')}</div>`;
            }

            document.getElementById('titulo-hino-leitura').innerText = `${hino.numero}. ${hino.titulo}`;
            document.getElementById('texto-hino').innerHTML = letraHTML;
            
            telaListaHinos.classList.add('escondido');
            telaLeituraHino.classList.remove('escondido');
            
            alternarBarras('leitura');
            
            areaPrincipal.scrollTop = 0; 
            window.scrollTo(0,0);
        }

        function voltarParaEscolhaHinario() {
            telaListaHinos.classList.add('escondido');
            telaEscolhaHinario.classList.remove('escondido');
            tituloApp.innerText = "Hin√°rios";
            alternarBarras('navegacao');
        }

        function voltarInicioLeitura() {
            alternarBarras('navegacao');
            
            if (modoAtual === 'biblia') {
                telaLeitura.classList.add('escondido');
                telaCapitulos.classList.remove('escondido');
                tituloApp.innerText = livroAtualNome;
            } else {
                telaLeituraHino.classList.add('escondido');
                telaListaHinos.classList.remove('escondido');
            }
        }

        function navegarConteudo(direcao) {
            if (modoAtual === 'biblia') {
                const novoCap = capituloAtual + direcao;
                if (novoCap < 1 || novoCap > livroAtualMaxCaps) return alert("Fim do livro.");
                lerCapitulo(novoCap);
            } else {
                const novoIndex = hinoAtual + direcao;
                if (novoIndex < 0 || novoIndex >= dadosHinario.length) return alert("Fim do hin√°rio.");
                lerHino(novoIndex);
            }
        }

        iniciarApp();
    </script>
</body>
</html>
