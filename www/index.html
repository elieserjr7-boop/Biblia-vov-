<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>B√≠blia Sagrada</title>
    
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B√≠blia">
    <meta name="theme-color" content="#2c3e50">

    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <style>
        /* --- ESTILO GERAL (MANTIDO DO SEU ARQUIVO FAVORITO) --- */
        * { box-sizing: border-box; }

           /* --- CSS BLINDADO CONTRA LISTRAS --- */
        html {
            /* CORRE√á√ÉO DA LISTRA (CAMUFLAGEM): */
            /* Define a cor de fundo padr√£o (Modo Claro) no elemento raiz */
            background-color: #fdfbf7; 
            
            width: 100%;
            height: 100%;
            overflow: hidden; /* Quem rola √© o body, n√£o o html */
        }
    
        body {
            font-family: 'Verdana', sans-serif;
            margin: 0;
            padding: 0;
            
            /* A SOLU√á√ÉO M√ÅGICA: 100dvh se adapta √†s barras do Android/iOS */
            height: 100vh; /* Fallback para navegadores antigos */
            height: 100dvh; 
            
            width: 100%;
            
            /* Impede rolagem no corpo (quem rola √© a area-principal) */
            overflow: hidden; 
            position: fixed; /* Trava na tela */
            top: 0;
            left: 0;
            
            display: flex;
            flex-direction: column;
            
            background-color: #fdfbf7;
            color: #111;
            transition: background-color 0.3s, color 0.3s;
            
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- CABE√áALHO --- */
        header {
            position: relative; 
            background-color: #2c3e50;
            color: white;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
            will-change: transform;
            width: 100%;
        }

        #btn-tema {
            position: absolute;
            right: 15px;
            top: max(15px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
        }

        h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px; }

        .seletor-versao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            margin: 10px auto 0 auto; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .label-versao { font-size: 14px; font-weight: normal; color: #ecf0f1; white-space: nowrap; }
        
        #select-versao {
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            width: 100%;
            flex: 1;
        }

        /* --- CORPO PRINCIPAL --- */
        main {
            flex: 1; 
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
            padding-top: calc(10px + env(safe-area-inset-top));
            padding-bottom: 80px; 
            transition: padding-top 0.3s ease;
        }

        /* MODO LEITURA */
        body.modo-leitura header { position: fixed; top: 0; left: 0; right: 0; }
        body.modo-leitura main { padding-top: calc(140px + env(safe-area-inset-top)); padding-bottom: 100px; }
        body.modo-leitura.imersivo header { transform: translateY(-100%); }
        body.modo-leitura.imersivo #rodape-nav { transform: translateY(100%); }
        body.modo-leitura.imersivo main { padding-top: calc(43px + env(safe-area-inset-top)); padding-bottom: 20px; }

        /* --- ELEMENTOS VISUAIS --- */
        .separador-testamento {
            background-color: #d35400; color: white; padding: 12px;
            font-size: 20px; font-weight: bold; text-align: center;
            border-radius: 8px; margin: 15px 15px 15px 15px;
            text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-livros { 
            display: grid; gap: 12px; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            padding: 0 15px 20px 15px;
        }

        .grade-capitulos { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }

        button { touch-action: manipulation; transition: background-color 0.3s, color 0.3s; }
        button:active { transform: scale(0.96); opacity: 0.8; }

        .btn-livro, .btn-hinario {
            background-color: #ecf0f1; border: 2px solid #bdc3c7;
            padding: 15px; font-size: 16px; text-align: center;
            border-radius: 10px; cursor: pointer; font-weight: bold; color: #2c3e50;
        }
        
        .btn-hinario { padding: 20px; font-size: 18px; }

        .btn-capitulo {
            padding: 15px; font-size: 20px; background-color: #fff;
            border: 2px solid #2c3e50; border-radius: 8px; cursor: pointer;
            color: #2c3e50; font-weight: bold;
        }

        /* Estilo para cap√≠tulo lido na grade */
        .btn-capitulo.lido {
            background-color: #dbfce1; /* Fundo verde bem clarinho */
            border-color: #2ecc71;     /* Borda verde */
            color: #27ae60;            /* Texto verde escuro */
            font-weight: bold;
        }
        
        /* O pequeno "check" ao lado do n√∫mero */
        .check-lido {
            font-size: 10px;
            margin-left: 2px;
            vertical-align: top;
        }

        .btn-voltar-topo {
            grid-column: 1 / -1; 
            background-color: #e74c3c; color: white; border: none;
            padding: 15px; font-size: 18px; border-radius: 12px;
            cursor: pointer; margin: 10px 15px 20px 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #texto-biblico, #texto-hino {
            font-size: 24px; line-height: 1.8; padding: 0 20px;
            text-align: left; margin-bottom: 40px; cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .versiculo-num {
            font-size: 16px; color: #e67e22; font-weight: bold;
            vertical-align: super; margin-right: 4px; user-select: none;
        }

        .lista-hinos { display: flex; flex-direction: column; gap: 10px; padding: 0 15px; }
        .item-hino {
            background: white; border: 1px solid #bdc3c7; padding: 15px;
            border-radius: 8px; font-size: 18px; color: #2c3e50; text-align: left; cursor: pointer;
        }
        .estrofe-hino { margin-bottom: 25px; }

        /* --- BARRA DE NAVEGA√á√ÉO --- */
        #rodape-nav {
            background-color: #ecf0f1; padding: 10px; display: flex; gap: 15px;
            border-top: 3px solid #bdc3c7; position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
        }

        .btn-nav {
            flex: 1; padding: 15px 0; font-size: 24px;
            background-color: #2c3e50; color: white;
            border: none; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-voltar-menu { background-color: #d35400; font-size: 16px; flex: 1; }

        /* --- MENU PRINCIPAL (ABAS) --- */
        #abas-principais {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 70px; background-color: #fff;
            display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 900; padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.3s;
        }
        .aba {
            flex: 1; border: none; background: transparent;
            font-size: 14px; font-weight: bold; color: #95a5a6;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .aba.ativa { color: #2c3e50; background-color: #ecf0f1; border-top: 3px solid #e67e22; }
        .icone-aba { font-size: 24px; margin-bottom: 2px; }

        /* --- ABA BUSCA --- */
        .container-busca { padding: 15px; text-align: center; }
        
        .wrapper-input {
            position: relative; display: flex; gap: 10px; align-items: center; margin-bottom: 20px;
        }
        
        #input-busca {
            flex: 1; padding: 15px; border-radius: 25px; border: 2px solid #bdc3c7;
            font-size: 18px; outline: none; font-family: 'Verdana', sans-serif;
        }
        
        #btn-mic {
            background: #e67e22; border: none; color: white;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #btn-mic.ouvindo {
            background-color: #e74c3c; animation: pulsando 1.5s infinite;
        }
        
        @keyframes pulsando {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .resultado-item {
            background: white; border: 1px solid #ddd; padding: 15px;
            border-radius: 8px; margin-bottom: 15px; text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .res-ref { font-weight: bold; color: #d35400; font-size: 16px; margin-bottom: 5px; display: block; }
        .res-texto { font-size: 16px; color: #333; line-height: 1.5; }
        
        .btn-comparar {
            margin-top: 10px; background-color: #3498db; color: white; border: none;
            padding: 10px; border-radius: 5px; font-size: 14px; cursor: pointer;
            width: 100%; font-family: 'Verdana', sans-serif; font-weight: bold;
        }

        /* Modal Compara√ß√£o */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; align-items: flex-end; 
        }
        .modal-conteudo {
            background: #fff; width: 100%; height: 85vh;
            border-radius: 20px 20px 0 0; padding: 20px;
            overflow-y: auto; position: relative;
            animation: subir 0.3s ease-out;
        }
        @keyframes subir { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .item-comparacao { border-bottom: 1px solid #eee; padding: 15px 0; }
        .comp-versao { font-weight: bold; color: #2c3e50; font-size: 14px; background: #ecf0f1; padding: 2px 6px; border-radius: 4px; }
        .comp-texto { font-size: 18px; margin-top: 5px; display: block; }

        .btn-fechar-modal {
            position: sticky; top: 0; width: 100%; background: #e74c3c; color: white;
            border: none; padding: 15px; font-size: 16px; font-weight: bold;
            border-radius: 10px; margin-bottom: 15px; z-index: 10;
        }

        .escondido { display: none !important; }

        /* Loading */
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #e67e22; background: rgba(255,255,255,0.95);
            padding: 20px; border-radius: 10px; z-index: 2000;
            display: none; width: 80%; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- MODO ESCURO --- */
        body.modo-escuro { background-color: #121212; color: #e0e0e0; }
        body.modo-escuro header { background-color: #1f1f1f; }
        body.modo-escuro #rodape-nav { background-color: #1f1f1f; border-top-color: #333; }
        body.modo-escuro #abas-principais { background-color: #1f1f1f; border-top-color: #333; }
        
        body.modo-escuro .btn-livro, 
        body.modo-escuro .btn-hinario {
            background-color: #2c2c2c; border-color: #444; color: #eee;
        }
        body.modo-escuro .btn-capitulo { background-color: #2c2c2c; border-color: #444; color: #eee; }
        body.modo-escuro .item-hino { background-color: #2c2c2c; border-color: #444; color: #eee; }
        
        body.modo-escuro .btn-nav { background-color: #333; }
        body.modo-escuro .btn-voltar-menu { background-color: #a04000; }
        
        body.modo-escuro .aba.ativa { background-color: #2c2c2c; color: #e0e0e0; border-top-color: #e67e22; }
        body.modo-escuro #select-versao { background-color: #333; color: #fff; }
        body.modo-escuro input#busca-hino { background-color: #333; color: #fff; border-color: #555; }
        
        body.modo-escuro #input-busca { background-color: #333; color: #fff; border-color: #555; }
        body.modo-escuro .resultado-item { background-color: #2c2c2c; border-color: #444; }
        body.modo-escuro .res-texto { color: #ccc; }
        body.modo-escuro .modal-conteudo { background-color: #1f1f1f; color: #eee; }
        body.modo-escuro .item-comparacao { border-color: #333; }
        body.modo-escuro .comp-versao { background-color: #444; color: #fff; }
        body.modo-escuro .comp-texto { color: #e0e0e0; }

        /* --- LAYOUT PARA PC: TELA CHEIA, PROPORCIONAL E CABE√áALHO CORRIGIDO --- */
        @media screen and (min-width: 768px) {
            
            /* 1. Configura√ß√£o Padr√£o (Modo Claro) */
            body, #corpo-app {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                background-color: #fdfbf7; 
            }

            /* 2. CORRE√á√ÉO DO MODO ESCURO NO PC */
            body.modo-escuro, 
            body.modo-escuro #corpo-app {
                background-color: #121212 !important; 
                color: #e0e0e0 !important;
            }

            /* 3. CABE√áALHO PROFISSIONAL (Lado a Lado) */
            header {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important; /* Espalha os itens */
                align-items: center !important; /* Centraliza verticalmente */
                padding: 0 40px !important;
                height: 80px !important;
            }

            /* T√≠tulo √† esquerda */
            #titulo-app {
                font-size: 1.8rem !important;
                margin: 0 !important;
                text-align: left !important;
                flex-grow: 1; /* Empurra o resto para a direita */
            }

            /* Bot√£o de tema (Lua) */
            #btn-tema {
                position: static !important; /* Remove posi√ß√£o absoluta */
                margin-right: 20px;
                font-size: 1.5rem;
            }

            /* Container da Vers√£o (Removemos o fundo "apagado") */
            .seletor-versao-container {
                width: auto !important;
                max-width: none !important;
                margin: 0 !important;
                background: transparent !important; /* Tira o fundo transparente feio */
                backdrop-filter: none !important;
                box-shadow: none !important;
                order: 2; /* Garante que fica √† direita */
            }

            /* O Seletor em si (Design Limpo) */
            #select-versao {
                padding: 10px 20px !important;
                font-size: 1rem !important;
                border-radius: 8px !important;
                cursor: pointer;
                background-color: #fff;
                color: #2c3e50;
                border: 1px solid #ccc;
            }

            /* Ajuste do Seletor no Modo Escuro */
            body.modo-escuro #select-versao {
                background-color: #333;
                color: #fff;
                border-color: #555;
            }

            /* 4. Grade de Livros Inteligente */
            .grade-livros {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
                gap: 20px; 
                padding: 40px; 
            }

            .btn-livro, .btn-capitulo {
                height: 70px; 
                font-size: 1.1rem; 
                border-radius: 12px;
            }

            /* 5. Lista de Hinos e Leitura */
            #lista-hinos-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                gap: 15px;
                padding: 20px;
            }
            
            .item-hino {
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 8px;
                background-color: rgba(0,0,0,0.03); 
            }
            
            body.modo-escuro .item-hino {
                background-color: #2c2c2c;
                border-color: #444;
            }

            #texto-biblico, #texto-hino {
                max-width: 900px; 
                margin: 0 auto;   
                font-size: 1.3rem; 
                line-height: 1.8;  
                padding-bottom: 100px;
            }
           
            #texto-hino {
                text-align: center;
            }

            /* 6. Rodap√© e Scroll */
            #rodape-nav { height: 70px; }
            .aba { flex-direction: row; gap: 10px; font-size: 1rem; }
            
            ::-webkit-scrollbar { width: 10px; }
            ::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 5px; }
            body.modo-escuro ::-webkit-scrollbar-thumb { background-color: #444; }
        }
        
        /* --- ESTILO DO SELETOR CUSTOMIZADO --- */
        .dropdown-container {
            position: relative;
            display: inline-block;
            z-index: 1000; /* Garante que fica acima do texto */
        }
        
        /* O Bot√£o que mostra a vers√£o atual */
        #btn-versao-selecionada {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: bold;
            color: inherit; /* Pega a cor do texto do tema */
            cursor: pointer;
            min-width: 80px;
            text-align: center;
        }
        
        /* A Lista Flutuante (O Menu) */
        .dropdown-menu {
            position: absolute;
            top: 110%; /* Fica logo abaixo do bot√£o */
            right: 0;  /* Alinhado √† direita */
            background-color: #fff;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 5px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        /* Itens da lista */
        .item-versao {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            font-size: 0.95rem;
            text-align: center;
            color: #333; /* Cor padr√£o no modo claro */
        }
        
        .item-versao:hover {
            background-color: #f0f0f0;
        }
        
        .item-versao.selecionado {
            background-color: #e3f2fd; /* Azulzinho claro para o selecionado */
            font-weight: bold;
            color: #1a73e8;
        }
        
        /* --- AJUSTES DO MODO ESCURO --- */
        body.modo-escuro #btn-versao-selecionada {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        
        body.modo-escuro .dropdown-menu {
            background-color: #222;
            border-color: #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        body.modo-escuro .item-versao {
            color: #e0e0e0;
        }
        
        body.modo-escuro .item-versao:hover {
            background-color: #333;
        }
        
        body.modo-escuro .item-versao.selecionado {
            background-color: #444;
            color: #8ab4f8;
        }

        /* Aumenta o espa√ßo entre o cabe√ßalho e o t√≠tulo do cap√≠tulo */
        #titulo-texto, #titulo-hino {
            margin-top: 30px !important;  /* Empurra o t√≠tulo para baixo */
            padding-bottom: 10px;         /* Espa√ßo extra embaixo do t√≠tulo */
            display: block;
        }

       /* --- CORRE√á√ÉO FINAL (TIRO E QUEDA) --- */

        /* 1. Remove qualquer margem interna do container de livros */
        /* Obs: Tirei o ".tela-conteudo" do seletor para garantir que pegue pelo ID */
        #tela-livros {
            padding-top: 0px !important;
            margin-top: -5px !important; /* Truque: Puxa a tela um pouquinho para cima para comer o espa√ßo do <main> */
        }

        /* 2. Zera a margem do bot√£o laranja "ANTIGO TESTAMENTO" */
        /* Isso √© o que estava criando aquele buraco grande */
        #tela-livros .separador-testamento {
            margin-top: -15px !important;
            margin-bottom: 10px !important;
        }

        /* 3. Se houver algum h3 perdido, zera tamb√©m */
        #tela-livros h3 {
            margin-top: 0px !important;
            margin-bottom: 0px !important;
            padding-top: 0px !important;
        }
        /* --- ESTILO DA ABA DADOS --- */

        /* Painel dos n√∫meros grandes */
        .painel-resumo {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .card-dado {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            border: 1px solid #eee;
        }
        
        .dado-valor {
            display: block;
            font-size: 28px;
            font-weight: 800;
            color: #2c3e50;
        }
        
        .dado-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Item da Lista (Cada livro) */
        .item-progresso {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .cabecalho-progresso {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #34495e;
        }
        
        /* O Trilho da Barra (Fundo cinza) */
        .barra-trilho {
            width: 100%;
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            overflow: hidden; /* Corta o que passar */
        }
        
        /* A Barra Neon (O preenchimento) */
        .barra-preenchida {
            height: 100%;
            background-color: #00ff41; /* Verde Matrix/Neon */
            width: 0%; /* Come√ßa zerado */
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.6); /* O Brilho Neon */
        }
        
        /* Bot√£o Marcar Lido (Bot√£oz√£o no final do texto) */
        .btn-marcar-lido {
            width: 100%;
            padding: 18px;
            margin-top: 40px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* Estado: N√£o lido (Verde convite) */
        .btn-marcar-lido.nao-lido {
            background-color: #27ae60;
            color: white;
            box-shadow: 0 4px 0 #219150;
        }
        
        /* Estado: J√° Lido (Cinza discreto) */
        .btn-marcar-lido.lido {
            background-color: #ecf0f1;
            color: #7f8c8d;
            border: 2px solid #bdc3c7;
        }
        
        .btn-marcar-lido:active { transform: scale(0.98); }
        
        /* Indicador ‚úî na lista de cap√≠tulos */
        .check-lido {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 10px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .btn-resetar {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background: transparent;
            color: #c0392b;
            border: 1px dashed #c0392b;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* Ajustes Modo Escuro */
        body.modo-escuro .card-dado, 
        body.modo-escuro .item-progresso {
            background-color: #2c2c2c;
            border-color: #444;
        }
        body.modo-escuro .dado-valor { color: #ecf0f1; }
        body.modo-escuro .cabecalho-progresso { color: #bdc3c7; }
        body.modo-escuro .barra-trilho { background-color: #444; }
        body.modo-escuro .barra-preenchida { background-color: #00e676; box-shadow: 0 0 12px rgba(0, 230, 118, 0.4); }
        /* --- ESTILO DO NOVO MENU PERFIL --- */
        
        .lista-opcoes-perfil {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        
        .btn-opcao-perfil {
            display: flex;
            align-items: center;
            background: white;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            text-align: left;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .btn-opcao-perfil:active { transform: scale(0.98); }
        
        .icone-grande { font-size: 28px; margin-right: 15px; }
        
        .texto-opcao { flex: 1; }
        
        .titulo-opcao { 
            display: block; 
            font-size: 18px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        .desc-opcao { 
            display: block; 
            font-size: 13px; 
            color: #7f8c8d; 
            margin-top: 4px; 
        }
        
        .seta-opcao { font-size: 20px; color: #bdc3c7; }
        
        /* Sub-telas */
        .cabecalho-subtela {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .cabecalho-subtela h3 { margin: 0; color: #2c3e50; }
        
        .btn-voltar-perfil {
            background: none;
            border: 1px solid #bdc3c7;
            padding: 8px 15px;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Modo Escuro */
        body.modo-escuro .btn-opcao-perfil { background: #2c2c2c; border-color: #444; }
        body.modo-escuro .titulo-opcao { color: #ecf0f1; }
        body.modo-escuro .cabecalho-subtela { background: #1f1f1f; border-color: #333; }
        body.modo-escuro .cabecalho-subtela h3 { color: #ecf0f1; }
        body.modo-escuro .btn-voltar-perfil { color: #ecf0f1; border-color: #555; }
               
        /* --- AJUSTE DOS CAP√çTULOS LIDOS NO MODO ESCURO --- */
        body.modo-escuro .btn-capitulo.lido {
            background-color: #064e3b; /* Fundo Verde Escuro Profundo */
            border-color: #27ae60;     /* Borda Verde */
            color: #e8f5e9;            /* Texto quase branco */
        }
        
        /* Opcional: Efeito Hover no escuro */
        body.modo-escuro .btn-capitulo.lido:hover {
            background-color: #0a6b4a;
        }
        
        /* --- ESTILO DAS MARCA√á√ïES E MODAL --- */
        
        /* Classes de Cores (Marca Texto) */
        .grifo-azul { background-color: rgba(66, 165, 245, 0.4); border-bottom: 2px solid #2196f3; }
        .grifo-amarelo { background-color: rgba(255, 238, 88, 0.4); border-bottom: 2px solid #fbc02d; }
        .grifo-rosa { background-color: rgba(255, 64, 129, 0.35); border-bottom: 2px solid #ff4081; }
        .grifo-verde { background-color: rgba(102, 187, 106, 0.4); border-bottom: 2px solid #43a047; }
        .grifo-vermelho { background-color: rgba(255, 82, 82, 0.3); border-bottom: 2px solid #d32f2f; }
        
        /* √çcone de nota no texto */
        .icone-nota { font-size: 14px; vertical-align: middle; margin-left: 5px; cursor: pointer; }
        
        /* O Vers√≠culo clic√°vel */
        .verso-clicavel {
            padding: 2px 0;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .verso-clicavel:active { background-color: rgba(0,0,0,0.05); }
        
        /* Modal Bottom Sheet (Sobe de baixo) */
        /* ATUALIZE ESTA CLASSE NO SEU CSS */
        .modal-bottom-sheet {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
            
            /* --- AJUSTE PARA CABER TUDO SEM SCROLL --- */
            height: auto;          /* A altura se ajusta ao tamanho do conte√∫do */
            max-height: 100vh;     /* Permite usar at√© 100% da tela se precisar */
            overflow: visible;     /* Desativa qualquer barra de rolagem */
            
            padding-bottom: 40px;  /* Margem de seguran√ßa no fundo */
            z-index: 10001; 
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* Bot√µes de Cores */
        .opcoes-cores { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .btn-cor { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #eee; cursor: pointer; }
        
        .cor-azul { background-color: #42a5f5; }
        .cor-amarelo { background-color: #ffee58; }
        .cor-rosa { background-color: #ff4081; border: 2px solid #f50057; }
        .cor-verde { background-color: #66bb6a; }
        .cor-vermelho { background-color: #d32f2f; }
        .cor-limpar { background-color: white; color: #555; font-weight: bold; font-size: 16px; }
        
        .btn-modal-acao {
            width: 100%;
            padding: 15px;
            background: #f1f2f6;
            border: none;
            border-radius: 10px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* Item da Lista de Favoritos/Coment√°rios */
        .item-ref {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .item-ref.azul { border-left-color: #2196f3; }
        .item-ref.amarelo { border-left-color: #fbc02d; }
        .item-ref.rosa { border-left-color: #ff4081; }
        .item-ref.verde { border-left-color: #43a047; }
        .item-ref.vermelho { border-left-color: #d32f2f; }
        .caixa-editor {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        #texto-nota-input {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: sans-serif;
            resize: none; /* Impede puxar o tamanho */
            margin-bottom: 15px;
            background-color: #f9f9f9;
            color: #333;
        }
        #texto-nota-input:focus { outline: 2px solid #3498db; background-color: #fff; }
        .botoes-editor { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-salvar {
            background: #27ae60; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-cancelar {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        
        /* Modo Escuro do Editor */
        body.modo-escuro .caixa-editor { background: #2c2c2c; color: #ecf0f1; }
        body.modo-escuro #titulo-editor { color: #ecf0f1; }
        body.modo-escuro #texto-nota-input { background: #333; border-color: #444; color: #ecf0f1; }
        body.modo-escuro #texto-nota-input:focus { outline-color: #27ae60; }
        
        /* Anima√ß√£o de Zoom */
        .zoom-in { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .texto-ref-b { font-size: 14px; color: #555; margin-top: 5px; font-style: italic; }
        .nota-usuario { background: #fff3cd; padding: 8px; margin-top: 8px; border-radius: 5px; font-size: 14px; color: #555; }
        
        /* Ajuste Modo Escuro */
        body.modo-escuro .modal-bottom-sheet { background: #1f1f1f; }
        body.modo-escuro #titulo-modal-verso { color: #ccc; }
        body.modo-escuro .btn-modal-acao { background: #333; color: #fff; }
        body.modo-escuro .item-ref { background: #2c2c2c; }
        body.modo-escuro .texto-ref-b { color: #aaa; }
        body.modo-escuro .nota-usuario { background: #3e3825; color: #ddd; }

        /* --- MODO IMERSIVO (EFEITO DE SLIDE) --- */
        .barra-topo {
            transition: transform 0.3s ease; /* Anima√ß√£o suave */
        }
        .barra-navegacao {
            transition: transform 0.3s ease;
        }
        
        /* Quando estiver escondido, move para fora da tela */
        .escondido-topo {
            transform: translateY(-100%); /* Sobe tudo */
        }
        .escondido-nav {
            transform: translateY(100%); /* Desce tudo */
        }
        
        /* Ajuste para o texto do preview no modo escuro */
        body.modo-escuro #texto-verso-preview {
            background: #333 !important;
            color: #ccc !important;
            border-left-color: #27ae60 !important;
        }
    </style>
</head>
<body id="corpo-app">

    <header id="cabecalho-principal">
        <button id="btn-tema" onclick="alternarTema()">üåó</button>
        <h1 id="titulo-app">B√≠blia Sagrada</h1>
        
        <div id="area-versao" class="dropdown-container seletor-versao-container escondido">
            
            <button id="btn-versao-selecionada" onclick="alternarMenuVersoes()">NVI</button>

            <div id="lista-versoes-custom" class="dropdown-menu escondido" 
                 style="max-height: 50vh; overflow-y: auto; border: 1px solid #ccc;">
            </div>
        </div>
    </header>

    <div id="loading">‚è≥ Carregando...</div>

    <main id="area-principal">
        
        <div id="tab-biblia">
            <div id="tela-livros"></div>
            <div id="tela-capitulos" class="grade-capitulos escondido"></div>
            
            <div id="tela-leitura" class="escondido">
                <h2 id="titulo-capitulo-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-biblico" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-hinarios" class="escondido">
            <div id="tela-escolha-hinario" class="grade-livros" style="margin-top:20px;">
                <button class="btn-hinario" onclick="abrirHinario('harpa')">üéµ Harpa Crist√£</button>
                <button class="btn-hinario" onclick="abrirHinario('cantor')">üéº Cantor Crist√£o</button>
            </div>

            <div id="tela-lista-hinos" class="escondido">
                <button class="btn-voltar-topo" onclick="voltarParaEscolhaHinario()">&#11013; Voltar aos Hin√°rios</button>
                <input type="text" id="busca-hino" placeholder="N√∫mero ou nome..." 
                       style="width:90%; padding:15px; margin: 0 auto 15px auto; display:block; font-size:18px; border-radius:8px; border:1px solid #ccc;"
                       onkeyup="filtrarHinos()">
                <div id="lista-hinos-container" class="lista-hinos"></div>
            </div>

            <div id="tela-leitura-hino" class="escondido">
                <h2 id="titulo-hino-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-hino" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-busca" class="escondido">
            <div class="container-busca">
                <div class="wrapper-input">
                    <input type="text" id="input-busca" placeholder="Digite ou fale (ex: Jesus chorou)..." onkeyup="if(event.key === 'Enter') realizarBusca()">
                    <button id="btn-mic" onclick="ativarMicrofone()">üé§</button>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-livro" style="flex: 1; padding:15px; background-color:#3498db; color:white; border:none;" onclick="realizarBusca()">üîç Pesquisar</button>
                    <button class="btn-livro" style="width: 70px; padding:15px; background-color:#95a5a6; color:white; border:none;" onclick="limparBusca()">üóë</button>
                </div>
                
                <div id="resultados-busca"></div>
            </div>
        </div>
        
        <div id="tela-meus-dados" class="tela-conteudo escondido">
        
            <div id="menu-perfil-principal" class="anime-fade">
                <h2 style="text-align: center; color: #2c3e50; margin: 20px 0;">Meu Perfil</h2>
                
                <div class="lista-opcoes-perfil">
                    <button class="btn-opcao-perfil" onclick="abrirTelaProgressao()">
                        <span class="icone-grande">üìä</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Progress√£o de Leitura</span>
                            <span class="desc-opcao">Estat√≠sticas e livros lidos</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
    
                    <button class="btn-opcao-perfil" onclick="abrirTelaFavoritos()">
                        <span class="icone-grande">‚≠ê</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Vers√≠culos Favoritos</span>
                            <span class="desc-opcao">Seus textos marcados</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
    
                    <button class="btn-opcao-perfil" onclick="abrirTelaComentarios()">
                        <span class="icone-grande">üìù</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Meus Coment√°rios</span>
                            <span class="desc-opcao">Reflex√µes e anota√ß√µes</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
                </div>
            </div>
    
            <div id="view-progressao" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Estat√≠sticas</h3>
                </div>
                <div class="painel-resumo">
                    <div class="card-dado"> <span class="dado-valor" id="total-lido-pct">0%</span> <span class="dado-label">B√≠blia</span> </div>
                    <div class="card-dado"> <span class="dado-valor" id="total-caps-lidos">0</span> <span class="dado-label">Cap√≠tulos</span> </div>
                </div>
                <div id="lista-progresso-livros"></div>
                <button onclick="resetarProgresso()" class="btn-resetar">üóëÔ∏è Zerar Leitura</button>
                <div style="height: 100px;"></div>
            </div>
    
            <div id="view-favoritos" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Favoritos</h3>
                </div>
                <div id="lista-favoritos-container" style="padding: 15px;"></div>
                <button onclick="resetarFavoritos()" class="btn-resetar">üóëÔ∏è Apagar Favoritos</button>
                <div style="height: 100px;"></div>
            </div>
    
            <div id="view-comentarios" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Anota√ß√µes</h3>
                </div>
                <div id="lista-comentarios-container" style="padding: 15px;"></div>
                <button onclick="resetarComentarios()" class="btn-resetar">üóëÔ∏è Apagar Coment√°rios</button>
                <div style="height: 100px;"></div>
            </div>
        </div>
    
        <div id="modal-verso" class="modal-overlay escondido" onclick="fecharModalVerso(event)">
            <div class="modal-bottom-sheet" onclick="event.stopPropagation()">
                
                <div class="modal-header">
                    <span id="titulo-modal-verso" style="font-weight:bold; color:#555; font-size: 18px;">G√™nesis 1:1</span>
                    <button onclick="fecharModalVerso()" style="border:none; background:none; font-size:20px; padding: 10px;">‚úï</button>
                </div>
                
                <div id="texto-verso-preview" style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-style: italic; color: #444; border-left: 3px solid #666;">
                    "No princ√≠pio criou Deus os c√©us e a terra..."
                </div>
    
                <button class="btn-modal-acao" onclick="copiarVersoSelecionado()" style="margin-bottom: 10px; background-color: #34495e; color: white;">
                    üìã Copiar Vers√≠culo
                </button>
                
                <p style="font-size:14px; color:#777; margin: 10px 0; text-align: center;">Marcar cor:</p>
                
                <div class="opcoes-cores">
                    <button class="btn-cor cor-azul" onclick="aplicarCor('azul')"></button>
                    <button class="btn-cor cor-amarelo" onclick="aplicarCor('amarelo')"></button>
                    <button class="btn-cor cor-rosa" onclick="aplicarCor('rosa')"></button>
                    <button class="btn-cor cor-verde" onclick="aplicarCor('verde')"></button>
                    <button class="btn-cor cor-vermelho" onclick="aplicarCor('vermelho')"></button>
                    <button class="btn-cor cor-limpar" onclick="aplicarCor('limpar')">‚úï</button>
                </div>
    
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
    
                <button class="btn-modal-acao" onclick="iniciarComentario()">
                    üìù Adicionar / Editar Nota
                </button>
            </div>
        </div>
            
        <div id="modal-editor-nota" class="modal-overlay escondido">
            <div class="caixa-editor zoom-in">
                <h3 id="titulo-editor" style="margin-top:0; color:#2c3e50;">Minha Anota√ß√£o</h3>
                <p id="ref-editor" style="color:#7f8c8d; font-size: 14px; margin-bottom: 10px;">G√™nesis 1:1</p>
                
                <textarea id="texto-nota-input" placeholder="Escreva sua reflex√£o aqui..."></textarea>
                
                <div class="botoes-editor">
                    <button class="btn-cancelar" onclick="fecharEditorNota()">Cancelar</button>
                    <button class="btn-salvar" onclick="salvarNotaPeloModal()">Salvar</button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-comparacao" class="modal-overlay escondido">
        <div class="modal-conteudo">
            <button class="btn-fechar-modal" onclick="fecharComparacao()">Fechar</button>
            <h3 id="titulo-comparacao" style="text-align:center; margin-top:0;">Comparando</h3>
            <div id="lista-comparacao"></div>
        </div>
    </div>

    <footer id="rodape-nav" class="escondido">
        <button type="button" class="btn-nav btn-voltar-menu" onclick="voltarInicioLeitura()">Voltar</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(-1)">&#9664;</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(1)">&#9654;</button>
    </footer>

    <nav id="abas-principais">
        <button class="aba ativa" onclick="mudarAba('biblia')" id="btn-aba-biblia">
            <span class="icone-aba">üìñ</span> B√≠blia
        </button>
        <button class="aba" onclick="mudarAba('busca')" id="btn-aba-busca">
            <span class="icone-aba">üîç</span> Busca
        </button>
        <button class="aba" onclick="mudarAba('hinarios')" id="btn-aba-hinarios">
            <span class="icone-aba">üéµ</span> Hin√°rios
        </button> <button class="aba" onclick="mudarAba('dados')" id="btn-aba-dados">
            <span class="icone-aba">üë§</span> Perfil
        </button>
    </nav>

    <script>
        // --- SERVICE WORKER ---
        // --- SERVICE WORKER COM ATUALIZA√á√ÉO AUTOM√ÅTICA ---
        if ('serviceWorker' in navigator) {
            
            // Vari√°vel de controle para impedir recarregamentos infinitos
            let refreshing = false;
    
            // 1. O PULO DO GATO: Escuta quando o novo SW assume o controle
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload(); // Recarrega a p√°gina sozinho!
                }
            });
    
            // 2. Registro padr√£o ao carregar a p√°gina
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    // For√ßa o navegador a verificar se existe uma vers√£o nova (v37, v38...)
                    registration.update();
                    console.log('Service Worker registrado com sucesso:', registration.scope);
                }).catch(err => {
                    console.log('Falha ao registrar Service Worker:', err);
                });
            });
        }

        // --- O "C√ìDIGO DE CHOQUE" (Simula o efeito do teclado) ---
        document.addEventListener("visibilitychange", function() {
            if (document.visibilityState === "visible") {
                
                // Tenta 3 vezes em tempos diferentes para garantir que pegou o navegador "acordado"
                [50, 150, 300].forEach(tempo => {
                    setTimeout(() => {
                        
                        // 1. Simula que a tela mudou de tamanho (engana o navegador)
                        window.dispatchEvent(new Event('resize'));
        
                        // 2. A "Tremidinha": Rola 1px e volta (for√ßa a GPU a redesenhar)
                        window.scrollBy(0, 1);
                        window.scrollBy(0, -1);
        
                        // 3. Reafirma a altura correta (o c√≥digo que j√° t√≠nhamos)
                        let alturaReal = window.innerHeight;
                        document.body.style.height = alturaReal + "px";
                        window.scrollTo(0, 0); // Garante topo
        
                    }, tempo);
                });
            }
        });

        const listaLivros = ["G√™nesis","√äxodo","Lev√≠tico","N√∫meros","Deuteron√¥mio","Josu√©","Ju√≠zes","Rute","1 Samuel","2 Samuel","1 Reis","2 Reis","1 Cr√¥nicas","2 Cr√¥nicas","Esdras","Neemias","Ester","J√≥","Salmos","Prov√©rbios","Eclesiastes","C√¢nticos","Isa√≠as","Jeremias","Lamenta√ß√µes","Ezequiel","Daniel","Oseias","Joel","Am√≥s","Obadias","Jonas","Miqueias","Naum","Habacuque","Sofonias","Ageu","Zacarias","Malaquias","Mateus","Marcos","Lucas","Jo√£o","Atos","Romanos","1 Cor√≠ntios","2 Cor√≠ntios","G√°latas","Ef√©sios","Filipenses","Colossenses","1 Tessalonicenses","2 Tessalonicenses","1 Tim√≥teo","2 Tim√≥teo","Tito","Filemom","Hebreus","Tiago","1 Pedro","2 Pedro","1 Jo√£o","2 Jo√£o","3 Jo√£o","Judas","Apocalipse"];
        const antigoTestamento = [{ nome: "G√™nesis", caps: 50 }, { nome: "√äxodo", caps: 40 }, { nome: "Lev√≠tico", caps: 27 }, { nome: "N√∫meros", caps: 36 }, { nome: "Deuteron√¥mio", caps: 34 }, { nome: "Josu√©", caps: 24 }, { nome: "Ju√≠zes", caps: 21 }, { nome: "Rute", caps: 4 }, { nome: "1 Samuel", caps: 31 }, { nome: "2 Samuel", caps: 24 }, { nome: "1 Reis", caps: 22 }, { nome: "2 Reis", caps: 25 }, { nome: "1 Cr√¥nicas", caps: 29 }, { nome: "2 Cr√¥nicas", caps: 36 }, { nome: "Esdras", caps: 10 }, { nome: "Neemias", caps: 13 }, { nome: "Ester", caps: 10 }, { nome: "J√≥", caps: 42 }, { nome: "Salmos", caps: 150 }, { nome: "Prov√©rbios", caps: 31 }, { nome: "Eclesiastes", caps: 12 }, { nome: "C√¢nticos", caps: 8 }, { nome: "Isa√≠as", caps: 66 }, { nome: "Jeremias", caps: 52 }, { nome: "Lamenta√ß√µes", caps: 5 }, { nome: "Ezequiel", caps: 48 }, { nome: "Daniel", caps: 12 }, { nome: "Oseias", caps: 14 }, { nome: "Joel", caps: 3 }, { nome: "Am√≥s", caps: 9 }, { nome: "Obadias", caps: 1 }, { nome: "Jonas", caps: 4 }, { nome: "Miqueias", caps: 7 }, { nome: "Naum", caps: 3 }, { nome: "Habacuque", caps: 3 }, { nome: "Sofonias", caps: 3 }, { nome: "Ageu", caps: 2 }, { nome: "Zacarias", caps: 14 }, { nome: "Malaquias", caps: 4 }];
        const novoTestamento = [{ nome: "Mateus", caps: 28 }, { nome: "Marcos", caps: 16 }, { nome: "Lucas", caps: 24 }, { nome: "Jo√£o", caps: 21 }, { nome: "Atos", caps: 28 }, { nome: "Romanos", caps: 16 }, { nome: "1 Cor√≠ntios", caps: 16 }, { nome: "2 Cor√≠ntios", caps: 13 }, { nome: "G√°latas", caps: 6 }, { nome: "Ef√©sios", caps: 6 }, { nome: "Filipenses", caps: 4 }, { nome: "Colossenses", caps: 4 }, { nome: "1 Tessalonicenses", caps: 5 }, { nome: "2 Tessalonicenses", caps: 3 }, { nome: "1 Tim√≥teo", caps: 6 }, { nome: "2 Tim√≥teo", caps: 4 }, { nome: "Tito", caps: 3 }, { nome: "Filemom", caps: 1 }, { nome: "Hebreus", caps: 13 }, { nome: "Tiago", caps: 5 }, { nome: "1 Pedro", caps: 5 }, { nome: "2 Pedro", caps: 3 }, { nome: "1 Jo√£o", caps: 5 }, { nome: "2 Jo√£o", caps: 1 }, { nome: "3 Jo√£o", caps: 1 }, { nome: "Judas", caps: 1 }, { nome: "Apocalipse", caps: 22 }];
        
        // Lista INTELIGENTE (Sigla para o sistema, Nome para o visual)
        const listaVersoesDisponiveis = [
            { sigla: "NVI",  nome: "NVI - Nova Vers√£o Internacional" },
            { sigla: "NVT",  nome: "NVT - Nova Vers√£o Transformadora" },
            { sigla: "ACF",  nome: "ACF - Almeida Corrigida Fiel" },
            { sigla: "ARA",  nome: "ARA - Almeida Revista e Atualizada" },
            { sigla: "ARC",  nome: "ARC - Almeida Revista e Corrigida" },
            { sigla: "JFA", nome: "JFA - Jo√£o Ferreira de Almeida" },
            { sigla: "TB",   nome: "TB - Tradu√ß√£o Brasileira" },
            { sigla: "KJA",  nome: "KJA - King James Atualizada" },
            { sigla: "NAA",  nome: "NAA - Nova Almeida Atualizada" },
            { sigla: "NBV",  nome: "NBV - Nova B√≠blia Viva" },
            { sigla: "NTLH", nome: "NTLH - Nova Tradu√ß√£o Linguagem de Hoje" },
            { sigla: "AS21", nome: "A21 - Almeida S√©culo 21" },
            { sigla: "KJF",  nome: "KJF - King James Fiel" }
        ];
        
        // --- VARI√ÅVEIS DE DADOS DO USU√ÅRIO (Restaure isso!) ---
        let dadosUsuario = JSON.parse(localStorage.getItem('biblia_dados_v1')) || { 
            progresso: {},
            favoritos: [],
            anotacoes: {} 
        };

        if (!dadosUsuario.grifos) dadosUsuario.grifos = {};
        if (!dadosUsuario.notas) dadosUsuario.notas = {};
        if (!dadosUsuario.progresso) dadosUsuario.progresso = {};
        
        // --- VARI√ÅVEIS DE ESTADO ---
        let modoAtual = 'biblia';
        let bibliaCompleta = null;
        let versaoCarregadaNome = "";
        
        // CACHES EM MEM√ìRIA RAM (Para velocidade instant√¢nea)
        const cacheVersoes = {}; 
        const cacheHinarios = {}; 
        
        let livroAtualIndex = 0; 
        let livroAtualNome = "";
        let livroAtualMaxCaps = 0;
        let capituloAtual = 1;
        
        let dadosHinario = [];
        let hinoAtual = 1;
        
        // ELEMENTOS DOM
        const corpoApp = document.getElementById('corpo-app');
        const loading = document.getElementById('loading');
        const areaVersao = document.getElementById('area-versao');
        const rodape = document.getElementById('rodape-nav');
        const abasPrincipais = document.getElementById('abas-principais');
        const selectVersao = document.getElementById('select-versao');
        const tituloApp = document.getElementById('titulo-app');
        const areaPrincipal = document.getElementById('area-principal');
        
        const tabBiblia = document.getElementById('tab-biblia');
        const tabBusca = document.getElementById('tab-busca');
        const tabHinarios = document.getElementById('tab-hinarios');
        // Adicione junto das outras declara√ß√µes l√° no topo:
        const tabDados = document.getElementById('tela-meus-dados');
        
        const telaLivros = document.getElementById('tela-livros');
        const telaCapitulos = document.getElementById('tela-capitulos');
        const telaLeitura = document.getElementById('tela-leitura');
        const textoBiblico = document.getElementById('texto-biblico');
        
        const telaEscolhaHinario = document.getElementById('tela-escolha-hinario');
        const telaListaHinos = document.getElementById('tela-lista-hinos');
        const telaLeituraHino = document.getElementById('tela-leitura-hino');
        const btnVersao = document.getElementById('btn-versao-selecionada');
        const menuVersoes = document.getElementById('lista-versoes-custom');
        
        function limparBusca() {
            document.getElementById('input-busca').value = ""; 
            document.getElementById('resultados-busca').innerHTML = ""; 
            document.getElementById('input-busca').focus(); 
        }
        
        function gerarMenuVersoes(versaoAtual) {
            menuVersoes.innerHTML = ''; // Limpa lista antiga
            
            listaVersoesDisponiveis.forEach(itemInfo => {
                const item = document.createElement('div');
                item.className = 'item-versao';
                
                // AQUI √â A M√ÅGICA: Mostra o nome comprido na lista
                item.innerText = itemInfo.nome; 
                
                // Compara usando a sigla (ex: "NVI")
                if(itemInfo.sigla === versaoAtual) item.classList.add('selecionado');
    
                // Ao clicar, envia apenas a sigla para carregar o arquivo certo
                item.onclick = () => {
                    mudarVersaoCustom(itemInfo.sigla);
                };
    
                menuVersoes.appendChild(item);
            });
        }
        
        function alternarMenuVersoes() {
            menuVersoes.classList.toggle('escondido');
        }
        
        // Fecha o menu se clicar fora dele
        window.onclick = function(event) {
            if (!event.target.matches('#btn-versao-selecionada')) {
                if (!menuVersoes.classList.contains('escondido')) {
                    menuVersoes.classList.add('escondido');
                }
            }
        } 
        
        async function mudarVersaoCustom(novaVersao) {
            // 1. C√ÅLCULO DA PORCENTAGEM: Grava quanto % da tela voc√™ j√° desceu
            // Ex: Se leu metade, grava 0.5 (50%)
            const totalAntigo = areaPrincipal.scrollHeight - areaPrincipal.clientHeight;
            const posicaoAntiga = areaPrincipal.scrollTop;
            
            let porcentagemLida = 0;
            if (totalAntigo > 0) {
                porcentagemLida = posicaoAntiga / totalAntigo;
            }
    
            const scrollJanela = window.scrollY; // Backup para garantir
    
            // --- L√≥gica Padr√£o de Troca ---
            btnVersao.innerText = novaVersao; 
            localStorage.setItem('versaoBiblia', novaVersao);
            menuVersoes.classList.add('escondido');
            
            await carregarVersaoBiblia(novaVersao);
            
            if (modoAtual === 'biblia' && !telaLeitura.classList.contains('escondido')) {
                lerCapitulo(capituloAtual);
                
                // 2. RESTAURA√á√ÉO PROPORCIONAL
                // Aplica a mesma porcentagem ao tamanho do NOVO texto
                setTimeout(() => {
                    const novoTotal = areaPrincipal.scrollHeight - areaPrincipal.clientHeight;
                    const novaPosicao = porcentagemLida * novoTotal;
                    
                    areaPrincipal.scrollTop = novaPosicao;
                    window.scrollTo(0, scrollJanela);
                }, 50); // Aumentei para 50ms para dar tempo do texto renderizar
            }
            
            gerarMenuVersoes(novaVersao);
        }

        // Fun√ß√£o que corrige a altura em celulares
        function forcarAlturaReal() {
            // Pega a altura exata da janela vis√≠vel
            const alturaReal = window.innerHeight;
            // For√ßa o corpo do app a ter exatamente essa altura
            document.body.style.height = `${alturaReal}px`;
            
            // Refor√ßa a cor do fundo (para garantir que n√£o falhou)
            const corAtual = document.body.classList.contains('modo-escuro') ? "#1f1f1f" : "#fdfbf7";
            document.documentElement.style.backgroundColor = corAtual;
        }

        // Adiciona um "ouvinte" para corrigir sempre que a tela girar ou mudar
        window.addEventListener('resize', forcarAlturaReal);
           
        // --- INICIALIZA√á√ÉO ---
        function iniciarApp() {
            // 1. CORRE√á√ÉO DE TELA (O Segredo!)
            // Executa imediatamente para tirar a listra branca
            forcarAlturaReal();
            
            // Executa novamente ap√≥s meio segundo para garantir (caso a barra do navegador se mova)
            setTimeout(forcarAlturaReal, 500);

            // 2. TEMA: Carrega as cores e o fundo correto
            carregarTemaSalvo(); 
            
            // 3. INTERFACE: Renderiza os livros
            renderizarLivros();
            
            // 4. VERS√ÉO: Recupera qual b√≠blia o usu√°rio estava lendo
            const versaoSalva = localStorage.getItem('versaoBiblia') || "NVI";
            
            btnVersao.innerText = versaoSalva;
            gerarMenuVersoes(versaoSalva);
            
            // 5. CARREGAMENTO: Busca o texto da B√≠blia
            carregarVersaoBiblia(versaoSalva).then(() => {
                // Inicia o download silencioso do resto ap√≥s 2 segundos
                setTimeout(preCarregarTudoSilenciosamente, 2000);
            });
        }
        
        // --- PR√â-CARREGAMENTO UNIVERSAL (B√≠blias e Hin√°rios) ---
        // --- PR√â-CARREGAMENTO UNIVERSAL (CORRIGIDO) ---
        async function preCarregarTudoSilenciosamente() {
            console.log("Iniciando pr√©-carregamento total...");
        
            // A. Baixar Hin√°rios
            const hinarios = ["harpa", "cantor"];
            for (const h of hinarios) {
                if (!cacheHinarios[h]) {
                    try {
                        const r = await fetch(`./${h}.json`);
                        if(r.ok) {
                            const json = await r.json();
                            processarJsonHinario(json, h);
                        }
                    } catch(e) { console.warn("Falha pre-load hinario: " + h); }
                }
            }
        
            // B. Baixar Outras Vers√µes da B√≠blia (CORRE√á√ÉO AQUI)
            // Agora percorremos a lista de objetos e usamos 'versao.sigla'
            for (const item of listaVersoesDisponiveis) {
                const sigla = item.sigla; // Pegamos s√≥ a sigla (ex: "NVI")
                
                if (!cacheVersoes[sigla]) {
                    try {
                        const resp = await fetch(`./${sigla}.json`);
                        if (resp.ok) {
                            cacheVersoes[sigla] = await resp.json();
                            // console.log(`Vers√£o ${sigla} pr√©-carregada!`);
                        }
                    } catch (e) { console.warn(`Falha pre-load ${sigla}`); }
                }
            }
        }
        
        // Auxiliar para preparar o JSON do hin√°rio assim que baixar
        function processarJsonHinario(json, tipo) {
            let listaFinal = [];
            if (Array.isArray(json)) {
                listaFinal = json.map(h => ({
                    numero: h.numero || h.number || h.id, 
                    titulo: h.titulo || h.title,
                    letra: h.letra || h.text || h.verses || h.lyrics
                }));
            } else {
                listaFinal = Object.values(json)
                    .filter(obj => obj.hino)
                    .map(obj => {
                        let partes = obj.hino.split(" - ");
                        let num = partes[0].trim();
                        let tit = partes.length > 1 ? partes.slice(1).join(" - ").trim() : "Sem t√≠tulo";
                        let letraArr = (obj.verses && typeof obj.verses === 'object') ? Object.values(obj.verses) : obj.verses;
                        return { numero: num, titulo: tit, letra: letraArr };
                    });
                listaFinal.sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
            }
            // Salva no Cache de Hin√°rios com uma propriedade extra "tipo"
            listaFinal.tipo = tipo;
            cacheHinarios[tipo] = listaFinal;
        }
        
        function atualizarMetaColor(escuro) {
            // --- DEFINI√á√ÉO DAS CORES ---
            // Aqui definimos as cores para Modo Escuro e Claro
            
            // Cor do Fundo (e da Listra de baixo)
            const corFundo = escuro ? "#1f1f1f" : "#fdfbf7"; 
            
            // Cor da Barra de Status (L√° no topo, onde fica a bateria)
            // DICA: Se a listra aparecer no topo, mude esta cor para igual a 'corFundo' tamb√©m!
            const corBarraTopo = escuro ? "#1f1f1f" : "#2c3e50"; 
    
            // 1. Pinta a Barra de Notifica√ß√µes (Android/Chrome)
            const metaThemeColor = document.querySelector("meta[name='theme-color']");
            if (metaThemeColor) {
                metaThemeColor.setAttribute("content", corBarraTopo);
            }
    
            // 2. A M√ÅGICA DA CAMUFLAGEM:
            // Pinta o elemento <html> (que √© a listra de fundo)
            document.documentElement.style.backgroundColor = corFundo;
            
            // Pinta o corpo do site
            document.body.style.backgroundColor = corFundo;
        }
        
        function alternarTema() {
            document.body.classList.toggle('modo-escuro');
            const escuroAtivo = document.body.classList.contains('modo-escuro');
            localStorage.setItem('temaEscuro', escuroAtivo);
            atualizarMetaColor(escuroAtivo);
        }
        
        function carregarTemaSalvo() {
            const escuroSalvo = localStorage.getItem('temaEscuro') === 'true';
            if (escuroSalvo) {
                document.body.classList.add('modo-escuro');
            }
            atualizarMetaColor(escuroSalvo);
        }
        
        // --- CARREGAMENTO DE B√çBLIA ---
        async function carregarVersaoBiblia(versao) {
            if (cacheVersoes[versao]) {
                bibliaCompleta = cacheVersoes[versao];
                versaoCarregadaNome = versao;
                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }
                return;
            }
        
            if (versaoCarregadaNome === versao && bibliaCompleta) return;
        
            loading.style.display = 'block';
            try {
                const resp = await fetch(`./${versao}.json`);
                if(!resp.ok) throw new Error("Erro");
                const dados = await resp.json();
                cacheVersoes[versao] = dados;
                bibliaCompleta = dados;
                versaoCarregadaNome = versao;
                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao carregar vers√£o.");
            } finally {
                loading.style.display = 'none';
            }
        }
        
        /* --- SISTEMA DE PROGRESSO --- */

        function salvarDados() {
            localStorage.setItem('biblia_dados_v1', JSON.stringify(dadosUsuario));
        }
        
        // Chamada quando clica no bot√£o "Marcar como Lido" no fim do cap√≠tulo
        function alternarStatusCapitulo(livro, capitulo) {
            if (!dadosUsuario.progresso[livro]) dadosUsuario.progresso[livro] = [];
            
            const lista = dadosUsuario.progresso[livro];
            const index = lista.indexOf(capitulo);
            
            // Elemento do bot√£o
            const btn = document.getElementById('btn-leitura-final');
            
            if (index === -1) {
                // Marca
                lista.push(capitulo);
                if (btn) {
                    btn.className = "btn-marcar-lido lido";
                    btn.innerText = "‚úÖ Leitura Conclu√≠da (Desmarcar)";
                }
                // Feedback visual simples
                // alert("Cap√≠tulo salvo!"); 
            } else {
                // Desmarca
                lista.splice(index, 1);
                if (btn) {
                    btn.className = "btn-marcar-lido nao-lido";
                    btn.innerText = "Marcar Leitura como Conclu√≠da";
                }
            }
            
            salvarDados();
        }
        
        function esconderTodasSubTelas() {
            document.getElementById('view-progressao').classList.add('escondido');
            document.getElementById('view-favoritos').classList.add('escondido');
            document.getElementById('view-comentarios').classList.add('escondido');
        }
        
        function abrirTelaProgressao() {
            document.getElementById('menu-perfil-principal').classList.add('escondido');
            esconderTodasSubTelas(); // Garante que n√£o tem sujeira
            document.getElementById('view-progressao').classList.remove('escondido');
            renderizarProgressoCompleto();
        }
        
        function voltarMenuPerfil() {
            esconderTodasSubTelas();
            document.getElementById('menu-perfil-principal').classList.remove('escondido');
        }

        /* --- NAVEGA√á√ÉO ENTRE TELAS --- */
        function irParaVersiculo(livroNome, capNumero, versoNumero) {
            // 1. Acha o √≠ndice do livro no array da b√≠blia
            const index = bibliaCompleta.findIndex(b => b.name === livroNome);
            if (index === -1) return;
        
            // 2. Atualiza as vari√°veis globais
            livroAtualIndex = index;
            livroAtualNome = livroNome;
            
            // 3. Renderiza o cap√≠tulo
            lerCapitulo(parseInt(capNumero)); // Converte para n√∫mero por garantia
        
            // 4. Rola at√© o vers√≠culo (com um pequeno delay para dar tempo de desenhar a tela)
            setTimeout(() => {
                const elementoVerso = document.getElementById(`verso-${versoNumero}`);
                if (elementoVerso) {
                    elementoVerso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Efeito visual: piscar o vers√≠culo para destacar
                    elementoVerso.style.transition = "background 0.5s";
                    const corOriginal = elementoVerso.style.backgroundColor;
                    elementoVerso.style.backgroundColor = "rgba(255, 215, 0, 0.3)"; // Amarelo suave
                    setTimeout(() => {
                        elementoVerso.style.backgroundColor = corOriginal;
                    }, 1500);
                }
            }, 300); // 300ms de espera
        }
        
        // 2. Renderiza√ß√£o das Barras (Garante que mostra TODOS os livros)
        function renderizarProgressoCompleto() {
            const container = document.getElementById('lista-progresso-livros');
            container.innerHTML = '';
            
            let totalCapsBibia = 0;
            let totalLidosGeral = 0;
        
            // Concatena as listas que j√° existem no seu c√≥digo para garantir a ordem certa
            // (G√™nesis...Malaquias -> Mateus...Apocalipse)
            const todosLivros = [...antigoTestamento, ...novoTestamento];
        
            todosLivros.forEach(livroObj => {
                const nomeLivro = livroObj.nome;
                const totalCaps = livroObj.caps;
                
                // Verifica o progresso (se n√£o tiver nada, assume array vazio [])
                const lidosArray = dadosUsuario.progresso[nomeLivro] || [];
                const qtdLidos = lidosArray.length;
                
                // Calcula porcentagem (Evita divis√£o por zero se houver erro nos dados)
                const pct = totalCaps > 0 ? Math.round((qtdLidos / totalCaps) * 100) : 0;
        
                // Soma para o cabe√ßalho geral
                totalCapsBibia += totalCaps;
                totalLidosGeral += qtdLidos;
        
                // Cor da barra: Verde Escuro se completou (100%), Verde Neon se est√° lendo
                const corBarra = pct === 100 ? '#27ae60' : '#39ff14'; 
        
                const html = `
                    <div class="item-progresso">
                        <div class="cabecalho-progresso">
                            <span>${nomeLivro}</span>
                            <span>${pct}% <small style="color:#95a5a6">(${qtdLidos}/${totalCaps})</small></span>
                        </div>
                        <div class="barra-trilho">
                            <div class="barra-preenchida" style="width: ${pct}%; background-color: ${corBarra}"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        
            // Atualiza os n√∫meros grandes l√° no topo (Resumo Geral)
            const pctGeral = totalCapsBibia > 0 ? Math.round((totalLidosGeral / totalCapsBibia) * 100) : 0;
            document.getElementById('total-lido-pct').innerText = pctGeral + "%";
            document.getElementById('total-caps-lidos').innerText = totalLidosGeral;
        }

        let timerClique = null; // Controla o tempo entre cliques
        
        // Essa fun√ß√£o decide se foi 1 clique ou 2 cliques
        function gerenciarCliqueVerso(livro, cap, num, textoCodificado) {
            if (timerClique) {
                // --- DUPLO CLIQUE DETECTADO ---
                clearTimeout(timerClique);
                timerClique = null;
                
                // Abre o menu de op√ß√µes (sua fun√ß√£o antiga atualizada)
                abrirMenuVersiculo(livro, cap, num, textoCodificado);
                
            } else {
                // --- PRIMEIRO CLIQUE (ESPERANDO O SEGUNDO...) ---
                timerClique = setTimeout(() => {
                    // Se passar 300ms e ningu√©m clicar de novo, √© clique simples
                    alternarModoImersivo(); 
                    timerClique = null;
                }, 300); // 300 milissegundos de espera
            }
        }

        function alternarModoImersivo() {
            const topo = document.querySelector('.barra-topo');
            const nav = document.querySelector('.barra-navegacao');
            
            // Verifica se j√° est√° escondido
            const estaImersivo = topo.classList.contains('escondido-topo'); // Vamos criar essa classe no CSS
            
            if (estaImersivo) {
                // MOSTRAR TUDO
                topo.classList.remove('escondido-topo');
                nav.classList.remove('escondido-nav');
            } else {
                // ESCONDER TUDO
                topo.classList.add('escondido-topo');
                nav.classList.add('escondido-nav');
            }
        }
        
        // 3. Fun√ß√£o de Resetar (Atualizada para o novo sistema)
        function resetarProgresso() {
            if(confirm("Tem certeza que deseja apagar todo o seu hist√≥rico de leitura? Essa a√ß√£o n√£o pode ser desfeita.")) {
                dadosUsuario.progresso = {}; // Zera o objeto
                salvarDados(); // Salva no celular
                renderizarProgressoCompleto(); // Atualiza a tela na hora (tudo volta pra 0%)
            }
        }
        
        function mudarVersao() {
            const novaVersao = selectVersao.value;
            localStorage.setItem('versaoBiblia', novaVersao);
            carregarVersaoBiblia(novaVersao);
        }
        
        // --- INTERFACE ---
        function alternarBarras(modo) {
            corpoApp.classList.remove('imersivo');
            if (modo === 'leitura') {
                corpoApp.classList.add('modo-leitura');
                abasPrincipais.classList.add('escondido');
                rodape.classList.remove('escondido');
                if(modoAtual === 'biblia') areaVersao.classList.remove('escondido');
                else areaVersao.classList.add('escondido');
            } else { 
                corpoApp.classList.remove('modo-leitura');
                abasPrincipais.classList.remove('escondido');
                rodape.classList.add('escondido');
                areaVersao.classList.add('escondido');
            }
        }
        
        function alternarImersao() {
            if (corpoApp.classList.contains('modo-leitura')) {
                corpoApp.classList.toggle('imersivo');
            }
        }
        
        function mudarAba(aba) {
            modoAtual = aba;
            
            // Atualiza os bot√µes do menu
            document.querySelectorAll('.aba').forEach(btn => btn.classList.remove('ativa'));
            const btnAlvo = document.getElementById(`btn-aba-${aba}`);
            if (btnAlvo) btnAlvo.classList.add('ativa');
            
            // Esconde TODAS as telas (incluindo a nova tabDados)
            tabBiblia.classList.add('escondido');
            tabBusca.classList.add('escondido');
            tabHinarios.classList.add('escondido');
            if(tabDados) tabDados.classList.add('escondido'); 
            
            const titulo = document.getElementById('titulo-app');
            alternarBarras('navegacao');
        
            // L√≥gica de qual mostrar
            if (aba === 'biblia') {
                tabBiblia.classList.remove('escondido');
                titulo.innerText = "B√≠blia Sagrada";
                // Se estava lendo, restaura a barra de leitura
                if (!telaLeitura.classList.contains('escondido')) alternarBarras('leitura');
        
            } else if (aba === 'busca') {
                tabBusca.classList.remove('escondido');
                titulo.innerText = "Busca Inteligente";
                setTimeout(() => document.getElementById('input-busca').focus(), 50);
        
            } else if (aba === 'hinarios') { 
                // ATEN√á√ÉO: Mudei de 'else' para 'else if' aqui
                tabHinarios.classList.remove('escondido');
                titulo.innerText = "Hin√°rios";
                if (!telaLeituraHino.classList.contains('escondido')) alternarBarras('leitura');
        
            } else if (aba === 'dados') {
                if(tabDados) tabDados.classList.remove('escondido');
                titulo.innerText = "Meu Perfil";
                // Garante que come√ßa no menu, n√£o na progress√£o antiga
                voltarMenuPerfil(); 
            }
            
        }
        
        // --- RENDERIZA√á√ÉO B√çBLIA ---
        function renderizarLivros() {
            telaLivros.innerHTML = "";
            telaCapitulos.classList.add('escondido');
            telaLeitura.classList.add('escondido');
            telaLivros.classList.remove('escondido');
            alternarBarras('navegacao'); 
            tituloApp.innerText = "B√≠blia Sagrada";
        
            function criarSecao(titulo, lista, offsetIndex) {
                const divTitulo = document.createElement('div');
                divTitulo.className = 'separador-testamento';
                divTitulo.innerText = titulo;
                telaLivros.appendChild(divTitulo);
                const grid = document.createElement('div');
                grid.className = 'grade-livros';
                lista.forEach((livro, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-livro';
                    btn.innerText = livro.nome;
                    const indiceGlobal = offsetIndex + index;
                    btn.onclick = () => abrirCapitulos(indiceGlobal, livro.nome, livro.caps);
                    grid.appendChild(btn);
                });
                telaLivros.appendChild(grid);
            }
            criarSecao("Antigo Testamento", antigoTestamento, 0);
            criarSecao("Novo Testamento", novoTestamento, 39);
        }
        
        function abrirCapitulos(indexGlobal, nome, totalCaps) {
            // 1. Configura as vari√°veis globais
            livroAtualIndex = indexGlobal;
            livroAtualNome = nome;
            livroAtualMaxCaps = totalCaps;
            tituloApp.innerText = nome;
            
            // 2. Troca as telas
            telaLivros.classList.add('escondido');
            telaCapitulos.classList.remove('escondido');
            telaCapitulos.innerHTML = "";
            
            // 3. Bot√£o de Voltar
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'btn-voltar-topo';
            btnVoltar.innerHTML = "&#11013; Escolher outro livro"; 
            btnVoltar.onclick = () => { renderizarLivros(); };
            telaCapitulos.appendChild(btnVoltar);
        
            // --- AQUI EST√Å A MUDAN√áA (RECUPERA OS DADOS) ---
            // Pega a lista de cap√≠tulos lidos deste livro (ex: [1, 5, 10])
            // Se n√£o tiver nada, retorna array vazio []
            const lidos = dadosUsuario.progresso[nome] || [];

            // 4. Cria os bot√µes num√©ricos
            for (let i = 1; i <= totalCaps; i++) {
                const btn = document.createElement('button');
                
                // Verifica se 'i' (o n√∫mero do cap√≠tulo) est√° na lista de lidos
                if (lidos.includes(i)) {
                    // SE LEU: Classe especial + Check
                    btn.className = 'btn-capitulo lido';
                    btn.innerHTML = `${i} <span class="check-lido">‚úì</span>`;
                } else {
                    // SE N√ÉO LEU: Bot√£o normal
                    btn.className = 'btn-capitulo';
                    btn.innerText = i;
                }

                btn.onclick = () => lerCapitulo(i);
                telaCapitulos.appendChild(btn);
            }
            
            // Rola para o topo para garantir
            window.scrollTo(0, 0);
        }
        
        function lerCapitulo(numero) {
            if (!bibliaCompleta) return;
            capituloAtual = numero;
            
            try {
                if (!bibliaCompleta[livroAtualIndex] || !bibliaCompleta[livroAtualIndex].chapters) return;
                
                const capituloTextoArray = bibliaCompleta[livroAtualIndex].chapters[capituloAtual - 1];
                let html = "";
                
                // GERA√á√ÉO DOS VERS√çCULOS
                capituloTextoArray.forEach((versiculo, idx) => {
                    const numVerso = idx + 1;
                    
                    // Configura√ß√µes de Cor e Nota
                    const chave = `${livroAtualNome}_${capituloAtual}_${numVerso}`;
                    const dadosGrifo = dadosUsuario.grifos[chave]; 
                    const classeCor = dadosGrifo ? `grifo-${dadosGrifo.cor}` : "";
                    const temNota = dadosUsuario.notas[chave] ? "üìù" : "";
                    const textoSafe = encodeURIComponent(versiculo);
                    
                    // --- AQUI EST√Å A MUDAN√áA DOS CLIQUES ---
                    // onclick -> Alterna as barras (Modo Imersivo)
                    // oncontextmenu -> Segurar o clique abre o Menu de Vers√≠culo
                    html += `
                        <div id="verso-${numVerso}" class="verso-clicavel ${classeCor}" 
                             onclick="alternarModoImersivo()"
                             oncontextmenu="event.preventDefault(); abrirMenuVersiculo('${livroAtualNome}', ${capituloAtual}, ${numVerso}, '${textoSafe}'); return false;">
                             
                            <span class="versiculo-num">${numVerso}</span> 
                            ${versiculo} 
                            <span class="icone-nota">${temNota}</span>
                        </div>
                        <br>
                    `;
                });
                
                document.getElementById('titulo-capitulo-leitura').innerText = `${livroAtualNome} ${capituloAtual}`;
                textoBiblico.innerHTML = html;
        
                // BOT√ÉO DE LEITURA CONCLU√çDA
                const lidos = dadosUsuario.progresso[livroAtualNome] || [];
                const jaLeu = lidos.includes(capituloAtual);
                const btnHTML = `
                    <button id="btn-leitura-final" 
                            class="btn-marcar-lido ${jaLeu ? 'lido' : 'nao-lido'}" 
                            onclick="alternarStatusCapitulo('${livroAtualNome}', ${capituloAtual})">
                        ${jaLeu ? '‚úÖ Leitura Conclu√≠da (Desmarcar)' : 'Marcar Leitura como Conclu√≠da'}
                    </button>
                `;
                textoBiblico.innerHTML += btnHTML;
                
                // Transi√ß√£o de telas
                telaCapitulos.classList.add('escondido');
                telaLeitura.classList.remove('escondido');
                alternarBarras('leitura');
                
                // Se N√ÉO foi chamado pela fun√ß√£o irParaVersiculo (que usa scroll), rola pro topo
                // (Detectamos isso de forma simples: se n√£o tiver hash na URL ou delay)
                // Mas para simplificar, o irParaVersiculo roda 300ms depois, ent√£o ele ganha dessa linha aqui:
                window.scrollTo(0,0);
                
            } catch (erro) { console.error(erro); }
        }
        
        // --- BUSCA ---
        function normalizar(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,;?!]/g,"");
        }
        
        function ativarMicrofone() {
            const btn = document.getElementById('btn-mic');
            const input = document.getElementById('input-busca');
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return alert("Microfone n√£o suportado.");
        
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            
            rec.onstart = () => { btn.classList.add('ouvindo'); input.placeholder = "Ouvindo..."; };
            rec.onend = () => { btn.classList.remove('ouvindo'); input.placeholder = "Digite ou fale..."; };
            rec.onresult = (e) => {
                input.value = e.results[0][0].transcript;
                realizarBusca();
            };
            rec.start();
        }
        
        function realizarBusca() {
            const termo = document.getElementById('input-busca').value.trim();
            if (termo.length < 3) return alert("Digite pelo menos 3 letras.");
            if (!bibliaCompleta) return alert("Aguarde o carregamento.");
        
            document.getElementById('input-busca').blur();
            const container = document.getElementById('resultados-busca');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Pesquisando...</div>';
        
            setTimeout(() => {
                const termoNorm = normalizar(termo);
                const palavras = termoNorm.split(" ").filter(p => p.length > 2);
                let resultados = [];
        
                bibliaCompleta.forEach((livroObj, idxLivro) => {
                    if (!livroObj.chapters) return;
                    livroObj.chapters.forEach((cap, idxCap) => {
                        cap.forEach((versiculo, idxVer) => {
                            const vNorm = normalizar(versiculo);
                            let pts = 0;
                            if (vNorm.includes(termoNorm)) pts += 100;
                            else {
                                palavras.forEach(p => { if (vNorm.includes(p)) pts += 10; });
                            }
                            if (pts > 0) {
                                const nomeReal = listaLivros[idxLivro] || livroObj.nome; 
                                resultados.push({ livro: nomeReal, cap: idxCap + 1, ver: idxVer + 1, texto: versiculo, pontos: pts, idxLivro: idxLivro });
                            }
                        });
                    });
                });
        
                resultados.sort((a, b) => b.pontos - a.pontos);
                const top = resultados.slice(0, 50);
                
                container.innerHTML = "";
                if (top.length === 0) container.innerHTML = "<p style='text-align:center'>Nenhum resultado.</p>";
                
                top.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resultado-item';
                    div.innerHTML = `
                        <span class="res-ref">${res.livro} ${res.cap}:${res.ver}</span>
                        <div class="res-texto">${res.texto}</div>
                        <button class="btn-comparar" onclick="compararVersoes(${res.idxLivro}, ${res.cap}, ${res.ver}, '${res.livro}')">Ver em outras vers√µes</button>
                    `;
                    div.onclick = (e) => {
                        if(e.target.className !== 'btn-comparar') {
                            livroAtualIndex = res.idxLivro;
                            livroAtualNome = res.livro;
                            livroAtualMaxCaps = (bibliaCompleta[res.idxLivro].chapters || []).length || 50;
                            lerCapitulo(res.cap);
                            mudarAba('biblia');
                        }
                    };
                    container.appendChild(div);
                });
            }, 100);
        }
        
        // --- COMPARADOR ---
        // --- COMPARADOR (CORRIGIDO) ---
        async function compararVersoes(idxLivro, cap, ver, nome) {
            const modal = document.getElementById('modal-comparacao');
            const lista = document.getElementById('lista-comparacao');
            modal.classList.remove('escondido');
            document.getElementById('titulo-comparacao').innerText = `${nome} ${cap}:${ver}`;
            lista.innerHTML = "Carregando...";
        
            const promises = listaVersoesDisponiveis.map(async item => {
                const v = item.sigla; // Usamos a sigla do objeto
                try {
                    let dadosVersao;
                    if (cacheVersoes[v]) {
                        dadosVersao = cacheVersoes[v];
                    } else {
                        const r = await fetch(`./${v}.json`);
                        if(r.ok) {
                            dadosVersao = await r.json();
                            cacheVersoes[v] = dadosVersao;
                        }
                    }
        
                    if(dadosVersao && dadosVersao[idxLivro] && dadosVersao[idxLivro].chapters && dadosVersao[idxLivro].chapters[cap-1]) {
                        const txt = dadosVersao[idxLivro].chapters[cap-1][ver-1];
                        return `<div class="item-comparacao"><span class="comp-versao">${v}</span><span class="comp-texto">${txt}</span></div>`;
                    }
                } catch(e) {}
                return "";
            });
            
            const htmls = await Promise.all(promises);
            lista.innerHTML = htmls.join("");
        }
        
        function fecharComparacao() { document.getElementById('modal-comparacao').classList.add('escondido'); }
        
        // --- HIN√ÅRIOS (AGORA ULTRA-R√ÅPIDOS) ---
        async function abrirHinario(tipo) {
            document.getElementById('tela-escolha-hinario').classList.add('escondido');
            document.getElementById('titulo-app').innerText = (tipo === 'harpa') ? "Harpa Crist√£" : "Cantor Crist√£o";
        
            // 1. Tenta pegar do Cache RAM (Instant√¢neo)
            if (cacheHinarios[tipo]) {
                dadosHinario = cacheHinarios[tipo];
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao');
                return; // Sucesso, nem mostra loading
            }
        
            // 2. Se por acaso ainda n√£o baixou (muito raro), baixa agora
            let url = (tipo === 'harpa') ? "./harpa.json" : "./cantor.json";
            loading.style.display = 'block';
        
            try {
                const resp = await fetch(url);
                if(!resp.ok) throw new Error("Erro de rede");
                let json = await resp.json();
                
                processarJsonHinario(json, tipo); // Salva no cache
                dadosHinario = cacheHinarios[tipo]; // Usa o cache processado
        
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao');
        
            } catch(e) {
                alert("Erro ao abrir Hin√°rio.");
                telaEscolhaHinario.classList.remove('escondido');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function renderizarListaHinos(filtro = "") {
            const container = document.getElementById('lista-hinos-container');
            container.innerHTML = "";
            const termo = filtro.toLowerCase();
            dadosHinario.forEach((hino, index) => {
                if(String(hino.titulo).toLowerCase().includes(termo) || String(hino.numero).includes(termo)) {
                    const div = document.createElement('div');
                    div.className = 'item-hino';
                    div.innerHTML = `<strong>${hino.numero}.</strong> ${hino.titulo}`;
                    div.onclick = () => lerHino(index);
                    container.appendChild(div);
                }
            });
        }
        
        function filtrarHinos() { 
            renderizarListaHinos(document.getElementById('busca-hino').value); 
        }
        
        function lerHino(index) {
            hinoAtual = index;
            const hino = dadosHinario[index];
            let letraRaw = hino.letra;
            let letraHTML = "";
        
            if (!letraRaw) {
                letraHTML = "<p>Letra indispon√≠vel.</p>";
            } else if (Array.isArray(letraRaw)) {
                letraRaw.forEach(estrofe => {
                     let texto = (typeof estrofe === 'string') ? estrofe : (estrofe.verse || estrofe.text || "");
                     letraHTML += `<div class="estrofe-hino">${texto.replace(/\n/g, '<br>')}</div>`;
                });
            } else {
                letraHTML = `<div class="estrofe-hino">${String(letraRaw).replace(/\n/g, '<br>')}</div>`;
            }
        
            document.getElementById('titulo-hino-leitura').innerText = `${hino.numero}. ${hino.titulo}`;
            document.getElementById('texto-hino').innerHTML = letraHTML;
            
            telaListaHinos.classList.add('escondido');
            telaLeituraHino.classList.remove('escondido');
            alternarBarras('leitura');
            areaPrincipal.scrollTop = 0; 
            window.scrollTo(0,0);
        }
        
        function voltarParaEscolhaHinario() {
            telaListaHinos.classList.add('escondido');
            telaEscolhaHinario.classList.remove('escondido');
            tituloApp.innerText = "Hin√°rios";
            alternarBarras('navegacao');
        }
        
        function voltarInicioLeitura() {
            alternarBarras('navegacao');
            
            if (modoAtual === 'biblia') {
                telaLeitura.classList.add('escondido');
                abrirCapitulos(livroAtualIndex, livroAtualNome, livroAtualMaxCaps);
                
            } else {
                telaLeituraHino.classList.add('escondido');
                telaListaHinos.classList.remove('escondido');
            }
        }
        
        function navegarConteudo(direcao) {
            if (modoAtual === 'biblia') {
                const novoCap = capituloAtual + direcao;
                if (novoCap < 1 || novoCap > livroAtualMaxCaps) return alert("Fim do livro.");
                lerCapitulo(novoCap);
            } else {
                const novoIndex = hinoAtual + direcao;
                if (novoIndex < 0 || novoIndex >= dadosHinario.length) return alert("Fim do hin√°rio.");
                lerHino(novoIndex);
            }
        }
        /* --- SISTEMA DE GRIFOS E COMENT√ÅRIOS --- */

        // Vari√°veis tempor√°rias para saber qual vers√≠culo foi clicado
        let versoSelecionado = { livro: "", cap: 0, num: 0, texto: "" };

        function abrirMenuVersiculo(livro, cap, num, textoCodificado) {
            // 1. For√ßa esconder o cabe√ßalho e rodap√© para focar no menu
            const topo = document.querySelector('.barra-topo');
            const nav = document.querySelector('.barra-navegacao');
            topo.classList.add('escondido-topo');
            nav.classList.add('escondido-nav');
        
            // 2. Prepara os dados
            const texto = decodeURIComponent(textoCodificado);
            versoSelecionado = { livro, cap, num, texto };
            
            // 3. Preenche e mostra o Modal
            document.getElementById('titulo-modal-verso').innerText = `${livro} ${cap}:${num}`;
            document.getElementById('texto-verso-preview').innerText = `"${texto}"`;
            document.getElementById('modal-verso').classList.remove('escondido');
            
            // Pequena vibra√ß√£o no celular (se suportado) para indicar o clique longo
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function copiarVersoSelecionado() {
            const textoFinal = `${versoSelecionado.texto} \n(${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num})`;
            
            navigator.clipboard.writeText(textoFinal).then(() => {
                alert("Vers√≠culo copiado!");
                fecharModalVerso();
            }).catch(err => {
                console.error('Erro ao copiar', err);
                alert("Erro ao copiar. Tente selecionar manualmente.");
            });
        }
        
        function fecharModalVerso(e) {
            if (e && e.target !== e.currentTarget) return; // S√≥ fecha se clicar no fundo escuro
            document.getElementById('modal-verso').classList.add('escondido');
        }
        
        // 2. Salvar Cor (Grifo)
        function aplicarCor(cor) {
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            
            if (cor === 'limpar') {
                delete dadosUsuario.grifos[chave];
            } else {
                dadosUsuario.grifos[chave] = { cor: cor, texto: versoSelecionado.texto, timestamp: Date.now() };
            }
            
            salvarDados();
            fecharModalVerso();
            
            // Atualiza a tela de leitura imediatamente (sem recarregar tudo)
            lerCapitulo(capituloAtual); 
        }
        
        // 3. Salvar Coment√°rio
        function iniciarComentario() {
            fecharModalVerso(); // Fecha o menu de baixo
            
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            const notaSalva = dadosUsuario.notas[chave] ? dadosUsuario.notas[chave].texto : "";
            
            // Preenche o Modal
            document.getElementById('titulo-editor').innerText = "Editar Anota√ß√£o";
            document.getElementById('ref-editor').innerText = `${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num}`;
            document.getElementById('texto-nota-input').value = notaSalva;
            
            // Abre o Modal
            document.getElementById('modal-editor-nota').classList.remove('escondido');
            document.getElementById('texto-nota-input').focus();
        }

        function fecharEditorNota() {
            document.getElementById('modal-editor-nota').classList.add('escondido');
        }

        function salvarNotaPeloModal() {
            const textoDigitado = document.getElementById('texto-nota-input').value;
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            
            if (textoDigitado.trim() === "") {
                delete dadosUsuario.notas[chave]; // Se deixar vazio, apaga
            } else {
                dadosUsuario.notas[chave] = { 
                    texto: textoDigitado, 
                    ref: `${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num}`, 
                    timestamp: Date.now() 
                };
            }
            
            salvarDados();
            fecharEditorNota();
            lerCapitulo(capituloAtual); // Atualiza a tela para aparecer o √≠cone üìù
        }
        
        // 4. Renderizar Tela de Favoritos
        function abrirTelaFavoritos() {
            document.getElementById('menu-perfil-principal').classList.add('escondido');
            esconderTodasSubTelas();
            document.getElementById('view-favoritos').classList.remove('escondido');
            
            // L√≥gica de renderizar
            const container = document.getElementById('lista-favoritos-container');
            container.innerHTML = "";
            
            // Pega a lista de grifos
            const lista = Object.entries(dadosUsuario.grifos || {}).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            if (lista.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Nenhum vers√≠culo marcado ainda.</p>";
                return;
            }
            
            lista.forEach(([chave, dados]) => {
                // Separa a chave "G√™nesis_1_1" em vari√°veis
                const [livro, cap, num] = chave.split("_");
                
                const div = document.createElement('div');
                div.className = `item-ref ${dados.cor}`; 
                div.innerHTML = `<strong>${livro} ${cap}:${num}</strong><div class="texto-ref-b">"${dados.texto}..."</div>`;
                
                // --- AQUI √â A MUDAN√áA IMPORTANT√çSSIMA: ---
                // Adicionamos o 'num' (vers√≠culo) para a fun√ß√£o de navega√ß√£o saber onde rolar
                div.onclick = () => irParaVersiculo(livro, cap, num);
                // ------------------------------------------
                
                container.appendChild(div);
            });
        }
        
        // 5. Renderizar Tela de Coment√°rios
        function abrirTelaComentarios() {
            document.getElementById('menu-perfil-principal').classList.add('escondido');
            esconderTodasSubTelas();
            document.getElementById('view-comentarios').classList.remove('escondido');
            
            // L√≥gica de renderizar
            const container = document.getElementById('lista-comentarios-container');
            container.innerHTML = "";
            
            // Pega a lista de notas/coment√°rios
            const lista = Object.entries(dadosUsuario.notas || {}).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            if (lista.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Nenhuma anota√ß√£o feita.</p>";
                return;
            }
            
            lista.forEach(([chave, dados]) => {
                // Separa a chave em Livro, Cap√≠tulo e Vers√≠culo
                const [livro, cap, num] = chave.split("_");
                
                const div = document.createElement('div');
                div.className = "item-ref";
                div.innerHTML = `<strong>${livro} ${cap}:${num}</strong><div class="nota-usuario">üìù ${dados.texto}</div>`;
                
                // --- AQUI EST√Å A CORRE√á√ÉO ---
                // Adicionamos o 'num' para ele rolar at√© o coment√°rio
                div.onclick = () => irParaVersiculo(livro, cap, num);
                // -----------------------------
                
                container.appendChild(div);
            });
        }
        
        // Fun√ß√µes de Resetar
        function resetarFavoritos() {
            if(confirm("Apagar todos os destaques coloridos?")) {
                dadosUsuario.grifos = {};
                salvarDados();
                abrirTelaFavoritos();
            }
        }
        function resetarComentarios() {
            if(confirm("Apagar todas as suas anota√ß√µes?")) {
                dadosUsuario.notas = {};
                salvarDados();
                abrirTelaComentarios();
            }
        }
        iniciarApp();
    </script>
</body>
</html>
