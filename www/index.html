<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>B√≠blia Sagrada</title>
    
    <link rel="manifest" href="./manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B√≠blia">
    <meta name="theme-color" content="#2c3e50">

    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
        console.log("Console Eruda inicializado com sucesso! üöÄ");
    </script>

    <style>
        /* --- ESTILO GERAL (MANTIDO DO SEU ARQUIVO FAVORITO) --- */
        * { box-sizing: border-box; }

           /* --- CSS BLINDADO CONTRA LISTRAS --- */
        html {
            /* CORRE√á√ÉO DA LISTRA (CAMUFLAGEM): */
            /* Define a cor de fundo padr√£o (Modo Claro) no elemento raiz */
            background-color: #fdfbf7; 
            
            width: 100%;
            height: 100%;
            overflow: hidden; /* Quem rola √© o body, n√£o o html */
        }
    
        body {
            font-family: 'Verdana', sans-serif;
            margin: 0;
            padding: 0;
            
            /* A SOLU√á√ÉO M√ÅGICA: 100dvh se adapta √†s barras do Android/iOS */
            height: 100vh; /* Fallback para navegadores antigos */
            height: 100dvh; 
            
            width: 100%;
            
            /* Impede rolagem no corpo (quem rola √© a area-principal) */
            overflow: hidden; 
            position: fixed; /* Trava na tela */
            top: 0;
            left: 0;
            
            display: flex;
            flex-direction: column;
            
            background-color: #fdfbf7;
            color: #111;
            transition: background-color 0.3s, color 0.3s;
            
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- CABE√áALHO --- */
        header {
            position: relative; 
            background-color: #2c3e50;
            color: white;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
            will-change: transform;
            width: 100%;
        }

        #btn-tema {
            position: absolute;
            right: 15px;
            top: max(15px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
        }

        h1 { margin: 0; font-size: 22px; letter-spacing: 0.5px; }

        .seletor-versao-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 6px 12px;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            margin: 10px auto 0 auto; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .label-versao { font-size: 14px; font-weight: normal; color: #ecf0f1; white-space: nowrap; }
        
        #select-versao {
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            background-color: #fff;
            width: 100%;
            flex: 1;
        }

        /* --- CORPO PRINCIPAL --- */
        main {
            flex: 1; 
            width: 100%;
            height: 100%;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            position: relative;
            z-index: 1;
            padding-top: calc(10px + env(safe-area-inset-top));
            padding-bottom: 80px; 
            transition: padding-top 0.3s ease;
        }

        /* MODO LEITURA */
        body.modo-leitura header { position: fixed; top: 0; left: 0; right: 0; }
        body.modo-leitura main { padding-top: calc(140px + env(safe-area-inset-top)); padding-bottom: 100px; }
        body.modo-leitura.imersivo header { transform: translateY(-100%); }
        body.modo-leitura.imersivo #rodape-nav { transform: translateY(100%); }
        body.modo-leitura.imersivo main { padding-top: calc(43px + env(safe-area-inset-top)); padding-bottom: 20px; }

        /* --- ELEMENTOS VISUAIS --- */
        .separador-testamento {
            background-color: #d35400; color: white; padding: 12px;
            font-size: 20px; font-weight: bold; text-align: center;
            border-radius: 8px; margin: 15px 15px 15px 15px;
            text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .grade-livros { 
            display: grid; gap: 12px; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            padding: 0 15px 20px 15px;
        }

        .grade-capitulos { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; }

        button { touch-action: manipulation; transition: background-color 0.3s, color 0.3s; }
        button:active { transform: scale(0.96); opacity: 0.8; }

        .btn-livro, .btn-hinario {
            background-color: #ecf0f1; border: 2px solid #bdc3c7;
            padding: 15px; font-size: 16px; text-align: center;
            border-radius: 10px; cursor: pointer; font-weight: bold; color: #2c3e50;
        }
        
        .btn-hinario { padding: 20px; font-size: 18px; }

        .btn-capitulo {
            padding: 15px; font-size: 20px; background-color: #fff;
            border: 2px solid #2c3e50; border-radius: 8px; cursor: pointer;
            color: #2c3e50; font-weight: bold;
        }

        /* Estilo para cap√≠tulo lido na grade */
        .btn-capitulo.lido {
            background-color: #dbfce1; /* Fundo verde bem clarinho */
            border-color: #2ecc71;     /* Borda verde */
            color: #27ae60;            /* Texto verde escuro */
            font-weight: bold;
        }
        
        /* O pequeno "check" ao lado do n√∫mero */
        .check-lido {
            font-size: 10px;
            margin-left: 2px;
            vertical-align: top;
        }

        .btn-voltar-topo {
            grid-column: 1 / -1; 
            background-color: #e74c3c; color: white; border: none;
            padding: 15px; font-size: 18px; border-radius: 12px;
            cursor: pointer; margin: 10px 15px 20px 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        #texto-biblico, #texto-hino {
            font-size: 24px; line-height: 1.8; padding: 0 20px;
            text-align: left; margin-bottom: 40px; cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .versiculo-num {
            font-size: 16px; color: #e67e22; font-weight: bold;
            vertical-align: super; margin-right: 4px; user-select: none;
        }

        .lista-hinos { display: flex; flex-direction: column; gap: 10px; padding: 0 15px; }
        .item-hino {
            background: white; border: 1px solid #bdc3c7; padding: 15px;
            border-radius: 8px; font-size: 18px; color: #2c3e50; text-align: left; cursor: pointer;
        }
        .estrofe-hino { margin-bottom: 25px; }

        /* --- BARRA DE NAVEGA√á√ÉO --- */
        #rodape-nav {
            background-color: #ecf0f1; padding: 10px; display: flex; gap: 15px;
            border-top: 3px solid #bdc3c7; position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.3s;
        }

        .btn-nav {
            flex: 1; padding: 15px 0; font-size: 24px;
            background-color: #2c3e50; color: white;
            border: none; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-voltar-menu { background-color: #d35400; font-size: 16px; flex: 1; }

        /* --- MENU PRINCIPAL (ABAS) --- */
        #abas-principais {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 70px; background-color: #fff;
            display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 900; padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.3s;
        }
        .aba {
            flex: 1; border: none; background: transparent;
            font-size: 14px; font-weight: bold; color: #95a5a6;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .aba.ativa { color: #2c3e50; background-color: #ecf0f1; border-top: 3px solid #e67e22; }
        .icone-aba { font-size: 24px; margin-bottom: 2px; }

        /* --- ABA BUSCA --- */
        .container-busca { padding: 15px; text-align: center; }
        
        .wrapper-input {
            position: relative; display: flex; gap: 10px; align-items: center; margin-bottom: 20px;
        }
        
        #input-busca {
            flex: 1; padding: 15px; border-radius: 25px; border: 2px solid #bdc3c7;
            font-size: 18px; outline: none; font-family: 'Verdana', sans-serif;
        }
        
        #btn-mic {
            background: #e67e22; border: none; color: white;
            width: 50px; height: 50px; border-radius: 50%;
            font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #btn-mic.ouvindo {
            background-color: #e74c3c; animation: pulsando 1.5s infinite;
        }
        
        @keyframes pulsando {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .resultado-item {
            background: white; border: 1px solid #ddd; padding: 15px;
            border-radius: 8px; margin-bottom: 15px; text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .res-ref { font-weight: bold; color: #d35400; font-size: 16px; margin-bottom: 5px; display: block; }
        .res-texto { font-size: 16px; color: #333; line-height: 1.5; }
        
        .btn-comparar {
            margin-top: 10px; background-color: #3498db; color: white; border: none;
            padding: 10px; border-radius: 5px; font-size: 14px; cursor: pointer;
            width: 100%; font-family: 'Verdana', sans-serif; font-weight: bold;
        }

        /* Modal Compara√ß√£o */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; align-items: flex-end; 
        }
        .modal-conteudo {
            background: #fff; width: 100%; height: 85vh;
            border-radius: 20px 20px 0 0; padding: 20px;
            overflow-y: auto; position: relative;
            animation: subir 0.3s ease-out;
        }
        @keyframes subir { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .item-comparacao { border-bottom: 1px solid #eee; padding: 15px 0; }
        .comp-versao { font-weight: bold; color: #2c3e50; font-size: 14px; background: #ecf0f1; padding: 2px 6px; border-radius: 4px; }
        .comp-texto { font-size: 18px; margin-top: 5px; display: block; }

        .btn-fechar-modal {
            position: sticky; top: 0; width: 100%; background: #e74c3c; color: white;
            border: none; padding: 15px; font-size: 16px; font-weight: bold;
            border-radius: 10px; margin-bottom: 15px; z-index: 10;
        }

        .escondido { display: none !important; }

        /* Loading */
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #e67e22; background: rgba(255,255,255,0.95);
            padding: 20px; border-radius: 10px; z-index: 2000;
            display: none; width: 80%; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- MODO ESCURO --- */
        body.modo-escuro { background-color: #121212; color: #e0e0e0; }
        body.modo-escuro header { background-color: #1f1f1f; }
        body.modo-escuro #rodape-nav { background-color: #1f1f1f; border-top-color: #333; }
        body.modo-escuro #abas-principais { background-color: #1f1f1f; border-top-color: #333; }
        
        body.modo-escuro .btn-livro, 
        body.modo-escuro .btn-hinario {
            background-color: #2c2c2c; border-color: #444; color: #eee;
        }
        body.modo-escuro .btn-capitulo { background-color: #2c2c2c; border-color: #444; color: #eee; }
        body.modo-escuro .item-hino { background-color: #2c2c2c; border-color: #444; color: #eee; }
        
        body.modo-escuro .btn-nav { background-color: #333; }
        body.modo-escuro .btn-voltar-menu { background-color: #a04000; }
        
        body.modo-escuro .aba.ativa { background-color: #2c2c2c; color: #e0e0e0; border-top-color: #e67e22; }
        body.modo-escuro #select-versao { background-color: #333; color: #fff; }
        body.modo-escuro input#busca-hino { background-color: #333; color: #fff; border-color: #555; }
        
        body.modo-escuro #input-busca { background-color: #333; color: #fff; border-color: #555; }
        body.modo-escuro .resultado-item { background-color: #2c2c2c; border-color: #444; }
        body.modo-escuro .res-texto { color: #ccc; }
        body.modo-escuro .modal-conteudo { background-color: #1f1f1f; color: #eee; }
        body.modo-escuro .item-comparacao { border-color: #333; }
        body.modo-escuro .comp-versao { background-color: #444; color: #fff; }
        body.modo-escuro .comp-texto { color: #e0e0e0; }

        /* --- LAYOUT PARA PC: TELA CHEIA, PROPORCIONAL E CABE√áALHO CORRIGIDO --- */
        @media screen and (min-width: 768px) {
            
            /* 1. Configura√ß√£o Padr√£o (Modo Claro) */
            body, #corpo-app {
                width: 100% !important;
                max-width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                border: none !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                background-color: #fdfbf7; 
            }

            /* 2. CORRE√á√ÉO DO MODO ESCURO NO PC */
            body.modo-escuro, 
            body.modo-escuro #corpo-app {
                background-color: #121212 !important; 
                color: #e0e0e0 !important;
            }

            /* 3. CABE√áALHO PROFISSIONAL (Lado a Lado) */
            header {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-between !important; /* Espalha os itens */
                align-items: center !important; /* Centraliza verticalmente */
                padding: 0 40px !important;
                height: 80px !important;
            }

            /* T√≠tulo √† esquerda */
            #titulo-app {
                font-size: 1.8rem !important;
                margin: 0 !important;
                text-align: left !important;
                flex-grow: 1; /* Empurra o resto para a direita */
            }

            /* Bot√£o de tema (Lua) */
            #btn-tema {
                position: static !important; /* Remove posi√ß√£o absoluta */
                margin-right: 20px;
                font-size: 1.5rem;
            }

            /* Container da Vers√£o (Removemos o fundo "apagado") */
            .seletor-versao-container {
                width: auto !important;
                max-width: none !important;
                margin: 0 !important;
                background: transparent !important; /* Tira o fundo transparente feio */
                backdrop-filter: none !important;
                box-shadow: none !important;
                order: 2; /* Garante que fica √† direita */
            }

            /* O Seletor em si (Design Limpo) */
            #select-versao {
                padding: 10px 20px !important;
                font-size: 1rem !important;
                border-radius: 8px !important;
                cursor: pointer;
                background-color: #fff;
                color: #2c3e50;
                border: 1px solid #ccc;
            }

            /* Ajuste do Seletor no Modo Escuro */
            body.modo-escuro #select-versao {
                background-color: #333;
                color: #fff;
                border-color: #555;
            }

            /* 4. Grade de Livros Inteligente */
            .grade-livros {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
                gap: 20px; 
                padding: 40px; 
            }

            .btn-livro, .btn-capitulo {
                height: 70px; 
                font-size: 1.1rem; 
                border-radius: 12px;
            }

            /* 5. Lista de Hinos e Leitura */
            #lista-hinos-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                gap: 15px;
                padding: 20px;
            }
            
            .item-hino {
                border: 1px solid rgba(0,0,0,0.1);
                border-radius: 8px;
                background-color: rgba(0,0,0,0.03); 
            }
            
            body.modo-escuro .item-hino {
                background-color: #2c2c2c;
                border-color: #444;
            }

            #texto-biblico, #texto-hino {
                max-width: 900px; 
                margin: 0 auto;   
                font-size: 1.3rem; 
                line-height: 1.8;  
                padding-bottom: 100px;
            }
           
            #texto-hino {
                text-align: center;
            }

            /* 6. Rodap√© e Scroll */
            #rodape-nav { height: 70px; }
            .aba { flex-direction: row; gap: 10px; font-size: 1rem; }
            
            ::-webkit-scrollbar { width: 10px; }
            ::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 5px; }
            body.modo-escuro ::-webkit-scrollbar-thumb { background-color: #444; }
        }
        
        /* --- ESTILO DO SELETOR CUSTOMIZADO --- */
        .dropdown-container {
            position: relative;
            display: inline-block;
            z-index: 1000; /* Garante que fica acima do texto */
        }
        
        /* O Bot√£o que mostra a vers√£o atual */
        #btn-versao-selecionada {
            background-color: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: bold;
            color: inherit; /* Pega a cor do texto do tema */
            cursor: pointer;
            min-width: 80px;
            text-align: center;
        }
        
        /* A Lista Flutuante (O Menu) */
        .dropdown-menu {
            position: absolute;
            top: 110%; /* Fica logo abaixo do bot√£o */
            right: 0;  /* Alinhado √† direita */
            background-color: #fff;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 5px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        /* Itens da lista */
        .item-versao {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            font-size: 0.95rem;
            text-align: center;
            color: #333; /* Cor padr√£o no modo claro */
        }
        
        .item-versao:hover {
            background-color: #f0f0f0;
        }
        
        .item-versao.selecionado {
            background-color: #e3f2fd; /* Azulzinho claro para o selecionado */
            font-weight: bold;
            color: #1a73e8;
        }
        
        /* --- AJUSTES DO MODO ESCURO --- */
        body.modo-escuro #btn-versao-selecionada {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        
        body.modo-escuro .dropdown-menu {
            background-color: #222;
            border-color: #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        body.modo-escuro .item-versao {
            color: #e0e0e0;
        }
        
        body.modo-escuro .item-versao:hover {
            background-color: #333;
        }
        
        body.modo-escuro .item-versao.selecionado {
            background-color: #444;
            color: #8ab4f8;
        }

        /* Aumenta o espa√ßo entre o cabe√ßalho e o t√≠tulo do cap√≠tulo */
        #titulo-texto, #titulo-hino {
            margin-top: 30px !important;  /* Empurra o t√≠tulo para baixo */
            padding-bottom: 10px;         /* Espa√ßo extra embaixo do t√≠tulo */
            display: block;
        }

       /* --- CORRE√á√ÉO FINAL (TIRO E QUEDA) --- */

        /* 1. Remove qualquer margem interna do container de livros */
        /* Obs: Tirei o ".tela-conteudo" do seletor para garantir que pegue pelo ID */
        #tela-livros {
            padding-top: 0px !important;
            margin-top: -5px !important; /* Truque: Puxa a tela um pouquinho para cima para comer o espa√ßo do <main> */
        }

        /* 2. Zera a margem do bot√£o laranja "ANTIGO TESTAMENTO" */
        /* Isso √© o que estava criando aquele buraco grande */
        #tela-livros .separador-testamento {
            margin-top: -15px !important;
            margin-bottom: 10px !important;
        }

        /* 3. Se houver algum h3 perdido, zera tamb√©m */
        #tela-livros h3 {
            margin-top: 0px !important;
            margin-bottom: 0px !important;
            padding-top: 0px !important;
        }
        /* --- ESTILO DA ABA DADOS --- */

        /* Painel dos n√∫meros grandes */
        .painel-resumo {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .card-dado {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            border: 1px solid #eee;
        }
        
        .dado-valor {
            display: block;
            font-size: 28px;
            font-weight: 800;
            color: #2c3e50;
        }
        
        .dado-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Item da Lista (Cada livro) */
        .item-progresso {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .cabecalho-progresso {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #34495e;
        }
        
        /* O Trilho da Barra (Fundo cinza) */
        .barra-trilho {
            width: 100%;
            height: 12px;
            background-color: #ecf0f1;
            border-radius: 6px;
            overflow: hidden; /* Corta o que passar */
        }
        
        /* A Barra Neon (O preenchimento) */
        .barra-preenchida {
            height: 100%;
            background-color: #00ff41; /* Verde Matrix/Neon */
            width: 0%; /* Come√ßa zerado */
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.6); /* O Brilho Neon */
        }
        
        /* Bot√£o Marcar Lido (Bot√£oz√£o no final do texto) */
        .btn-marcar-lido {
            width: 100%;
            padding: 18px;
            margin-top: 40px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* Estado: N√£o lido (Verde convite) */
        .btn-marcar-lido.nao-lido {
            background-color: #27ae60;
            color: white;
            box-shadow: 0 4px 0 #219150;
        }
        
        /* Estado: J√° Lido (Cinza discreto) */
        .btn-marcar-lido.lido {
            background-color: #ecf0f1;
            color: #7f8c8d;
            border: 2px solid #bdc3c7;
        }
        
        .btn-marcar-lido:active { transform: scale(0.98); }
        
        /* Indicador ‚úî na lista de cap√≠tulos */
        .check-lido {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 10px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .btn-resetar {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background: transparent;
            color: #c0392b;
            border: 1px dashed #c0392b;
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* Ajustes Modo Escuro */
        body.modo-escuro .card-dado, 
        body.modo-escuro .item-progresso {
            background-color: #2c2c2c;
            border-color: #444;
        }
        body.modo-escuro .dado-valor { color: #ecf0f1; }
        body.modo-escuro .cabecalho-progresso { color: #bdc3c7; }
        body.modo-escuro .barra-trilho { background-color: #444; }
        body.modo-escuro .barra-preenchida { background-color: #00e676; box-shadow: 0 0 12px rgba(0, 230, 118, 0.4); }
        /* --- ESTILO DO NOVO MENU PERFIL --- */
        
        .lista-opcoes-perfil {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 20px;
        }
        
        .btn-opcao-perfil {
            display: flex;
            align-items: center;
            background: white;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            text-align: left;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .btn-opcao-perfil:active { transform: scale(0.98); }
        
        .icone-grande { font-size: 28px; margin-right: 15px; }
        
        .texto-opcao { flex: 1; }
        
        .titulo-opcao { 
            display: block; 
            font-size: 18px; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        .desc-opcao { 
            display: block; 
            font-size: 13px; 
            color: #7f8c8d; 
            margin-top: 4px; 
        }
        
        .seta-opcao { font-size: 20px; color: #bdc3c7; }
        
        /* Sub-telas */
        .cabecalho-subtela {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        
        .cabecalho-subtela h3 { margin: 0; color: #2c3e50; }
        
        .btn-voltar-perfil {
            background: none;
            border: 1px solid #bdc3c7;
            padding: 8px 15px;
            border-radius: 8px;
            color: #2c3e50;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Modo Escuro */
        body.modo-escuro .btn-opcao-perfil { background: #2c2c2c; border-color: #444; }
        body.modo-escuro .titulo-opcao { color: #ecf0f1; }
        body.modo-escuro .cabecalho-subtela { background: #1f1f1f; border-color: #333; }
        body.modo-escuro .cabecalho-subtela h3 { color: #ecf0f1; }
        body.modo-escuro .btn-voltar-perfil { color: #ecf0f1; border-color: #555; }
               
        /* --- AJUSTE DOS CAP√çTULOS LIDOS NO MODO ESCURO --- */
        body.modo-escuro .btn-capitulo.lido {
            background-color: #064e3b; /* Fundo Verde Escuro Profundo */
            border-color: #27ae60;     /* Borda Verde */
            color: #e8f5e9;            /* Texto quase branco */
        }
        
        /* Opcional: Efeito Hover no escuro */
        body.modo-escuro .btn-capitulo.lido:hover {
            background-color: #0a6b4a;
        }
        
        /* --- ESTILO DAS MARCA√á√ïES E MODAL --- */
        
        /* Classes de Cores (Marca Texto) */
        .grifo-azul { background-color: rgba(66, 165, 245, 0.4); border-bottom: 2px solid #2196f3; }
        .grifo-amarelo { background-color: rgba(255, 238, 88, 0.4); border-bottom: 2px solid #fbc02d; }
        .grifo-rosa { background-color: rgba(255, 64, 129, 0.35); border-bottom: 2px solid #ff4081; }
        .grifo-verde { background-color: rgba(102, 187, 106, 0.4); border-bottom: 2px solid #43a047; }
        .grifo-vermelho { background-color: rgba(255, 82, 82, 0.3); border-bottom: 2px solid #d32f2f; }
        
        /* √çcone de nota no texto */
        .icone-nota { font-size: 14px; vertical-align: middle; margin-left: 5px; cursor: pointer; }
        
        /* O Vers√≠culo clic√°vel */
        .verso-clicavel {
            padding: 2px 0;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .verso-clicavel:active { background-color: rgba(0,0,0,0.05); }
        
        /* Modal Bottom Sheet (Sobe de baixo) */
        /* ATUALIZE ESTA CLASSE NO SEU CSS */
        .modal-bottom-sheet {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
            
            /* --- AJUSTE PARA CABER TUDO SEM SCROLL --- */
            height: auto;          /* A altura se ajusta ao tamanho do conte√∫do */
            max-height: 100vh;     /* Permite usar at√© 100% da tela se precisar */
            overflow: visible;     /* Desativa qualquer barra de rolagem */
            
            padding-bottom: 40px;  /* Margem de seguran√ßa no fundo */
            z-index: 10001; 
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* Bot√µes de Cores */
        .opcoes-cores { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .btn-cor { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #eee; cursor: pointer; }
        
        .cor-azul { background-color: #42a5f5; }
        .cor-amarelo { background-color: #ffee58; }
        .cor-rosa { background-color: #ff4081; border: 2px solid #f50057; }
        .cor-verde { background-color: #66bb6a; }
        .cor-vermelho { background-color: #d32f2f; }
        .cor-limpar { background-color: white; color: #555; font-weight: bold; font-size: 16px; }
        
        .btn-modal-acao {
            width: 100%;
            padding: 15px;
            background: #f1f2f6;
            border: none;
            border-radius: 10px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* Item da Lista de Favoritos/Coment√°rios */
        /* --- ESTILOS DOS ITENS (Favoritos, Coment√°rios, etc) --- */
        .item-ref {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .item-ref.azul { border-left-color: #2196f3; }
        .item-ref.amarelo { border-left-color: #fbc02d; }
        .item-ref.rosa { border-left-color: #ff4081; }
        .item-ref.verde { border-left-color: #43a047; }
        .item-ref.vermelho { border-left-color: #d32f2f; }
        
        /* --- EDITOR DE NOTAS --- */
        .caixa-editor {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        #texto-nota-input {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: sans-serif;
            resize: none;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            color: #333;
        }
        #texto-nota-input:focus { outline: 2px solid #3498db; background-color: #fff; }
        
        .botoes-editor { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-salvar {
            background: #27ae60; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        .btn-cancelar {
            background: #e74c3c; color: white; border: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        
        /* --- LEITURA E VERS√çCULOS (AQUI EST√Å A M√ÅGICA) --- */
        
        .verso-clicavel {
            padding: 8px 5px; /* Mais espa√ßo para o toque */
            border-radius: 4px;
            cursor: pointer; 
            line-height: 1.6; /* Altura da linha para n√£o grudar */
            
            /* Impede sele√ß√£o de texto (tela azul) */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
        }
        .verso-clicavel:hover {
            background-color: rgba(0,0,0,0.03);
        }
        
        /* O BOT√ÉO DO N√öMERO DO VERS√çCULO */
        .versiculo-num {
            display: inline-block;
            font-weight: bold;
            font-size: 14px;
            color: #555;
            margin-right: 8px;
            
            /* Apar√™ncia de bot√£o */
            background-color: #eee;
            padding: 2px 8px;
            border-radius: 12px; /* Arredondado (Pill shape) */
            cursor: pointer;
            transition: background 0.2s;
            
            /* Alinhamento */
            vertical-align: middle;
        }
        
        /* Efeito ao tocar/passar mouse no n√∫mero */
        .versiculo-num:hover, .versiculo-num:active {
            background-color: #ccc;
            color: #000;
            transform: scale(1.05); /* Leve zoom */
        }
        
        
        /* --- MODO ESCURO E ADAPTA√á√ïES --- */
        body.modo-escuro .caixa-editor { background: #2c2c2c; color: #ecf0f1; }
        body.modo-escuro #titulo-editor { color: #ecf0f1; }
        body.modo-escuro #texto-nota-input { background: #333; border-color: #444; color: #ecf0f1; }
        body.modo-escuro #texto-nota-input:focus { outline-color: #27ae60; }
        
        body.modo-escuro .modal-bottom-sheet { background: #1f1f1f; }
        body.modo-escuro #titulo-modal-verso { color: #ccc; }
        body.modo-escuro .btn-modal-acao { background: #333; color: #fff; }
        body.modo-escuro .item-ref { background: #2c2c2c; }
        body.modo-escuro .texto-ref-b { color: #aaa; }
        body.modo-escuro .nota-usuario { background: #3e3825; color: #ddd; }
        
        /* Adapta√ß√£o do N√öMERO no modo escuro */
        body.modo-escuro .versiculo-num {
            background-color: #444;
            color: #ddd;
        }
        body.modo-escuro .versiculo-num:hover {
            background-color: #666;
            color: #fff;
        }
        
        /* Preview do texto no modal */
        body.modo-escuro #texto-verso-preview {
            background: #333 !important;
            color: #ccc !important;
            border-left-color: #27ae60 !important;
        }
        
        /* --- ANIMA√á√ïES E BARRA --- */
        .zoom-in { animation: zoomIn 0.2s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .texto-ref-b { font-size: 14px; color: #555; margin-top: 5px; font-style: italic; }
        .nota-usuario { background: #fff3cd; padding: 8px; margin-top: 8px; border-radius: 5px; font-size: 14px; color: #555; }
        
        .barra-topo, .barra-navegacao { transition: transform 0.3s ease; }
        .escondido-topo { transform: translateY(-100%); }
        .escondido-nav { transform: translateY(100%); }

        /* --- CORRE√á√ÉO DE PRIORIDADE DO MENU VERS√çCULO --- */
        .modal-bottom-sheet, #menu-verso {
            /* Mudar de absolute para fixed √© o segredo para sair de dentro do 'main' */
            position: fixed !important; 
            
            /* Um z-index absurdo para garantir que ganha do cabe√ßalho (1000) e setas */
            z-index: 99999 !important; 
            
            /* Garante que cola no fundo e nas laterais da tela */
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            
            /* Garante a visibilidade e cor */
            background: white !important;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3) !important;
        }
        
        /* Ajuste para o Modo Escuro, se necess√°rio */
        body.modo-escuro .modal-bottom-sheet, 
        body.modo-escuro #menu-verso {
            background: #1f1f1f !important;
            border-top: 1px solid #333;
        }

        /* Adicione ou atualize isto no seu CSS */
        /* --- CORRE√á√ÉO DO FUNDO SUMIDO --- */
        #modal-verso {
            /* 1. Solta o menu do topo da tela */
            top: auto !important; 
            
            /* 2. Diz que a altura √© apenas o tamanho dos bot√µes */
            height: auto !important; 
            min-height: 0 !important;
            max-height: 80vh !important; /* No m√°ximo 80% da tela */
            
            /* 3. Cola no ch√£o */
            bottom: 0 !important;
            position: fixed !important;
            
            /* 4. Garante largura total */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            margin: 0 !important;
            
            /* 5. Visual */
            z-index: 999999 !important;
            background-color: white !important; /* Fundo s√≥ na √°rea dos bot√µes */
            box-shadow: 0 -5px 50px rgba(0,0,0,0.2) !important;
            
            /* Remove transforma√ß√µes estranhas */
            transform: none !important; 
        }
        
        /* Garante a cor no modo escuro */
        body.modo-escuro #modal-verso {
            background-color: #1f1f1f !important;
        }
        
        /* Opcional: Se existir uma div "overlay" ou "fundo", ela deve ser transparente */
        .modal-overlay, #overlay-verso {
            background-color: rgba(0,0,0,0.5) !important; /* Preto transparente */
            backdrop-filter: blur(2px); /* Efeito de vidro opcional */
        }

        /* --- EDITOR DE NOTA (O MAIS ALTO DE TODOS) --- */
        #modal-editor-nota {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            
            /* Ganha do Menu de Vers√≠culos (que √© 999999) */
            z-index: 2000000 !important; 
            
            background-color: rgba(0,0,0,0.8) !important; /* Fundo escuro para foco */
            backdrop-filter: blur(5px); /* Efeito bonito de desfoque */
            
            /* Centralizar o conte√∫do */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Opcional: Estilo para a caixinha branca dentro dele, caso n√£o tenha */
        #modal-editor-nota > div {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        /* --- MODO ESCURO: EDITOR DE NOTA --- */

        /* 1. Fundo da Janela de Nota (Mant√©m cinza escuro) */
        body.modo-escuro #modal-editor-nota > div {
            background: #222 !important;
            color: white !important;
            border: 1px solid #444 !important;
        }
        
        /* 2. Bot√µes de A√ß√£o (CORES FIXAS: Verde e Vermelho) */
        /* Aplicamos tanto no modo claro quanto no escuro para garantir o padr√£o */
        .btn-salvar,
        body.modo-escuro .btn-salvar,
        button[onclick*="salvar"] {
            background-color: #27ae60 !important; /* Verde Esmeralda */
            color: white !important;              /* Texto Branco */
            border: none !important;
            font-weight: bold !important;
        }
        
        .btn-cancelar,
        body.modo-escuro .btn-cancelar,
        button[onclick*="cancelar"] {
            background-color: #e74c3c !important; /* Vermelho */
            color: white !important;              /* Texto Branco */
            border: none !important;
        }
        
        /* 3. O "X" de fechar o menu de baixo (Branco Puro) */
        body.modo-escuro button[onclick="fecharModalVerso()"] {
            color: #ffffff !important;
            background: transparent !important;
        }
        
        /* 4. Bot√£o "Adicionar/Editar Nota" (Branco Gelo no Modo Escuro) */
        /* Muda a cor do √≠cone/texto de nota no menu inferior */
        body.modo-escuro #modal-verso div[onclick*="notaVerso"], 
        body.modo-escuro #modal-verso div[onclick*="iniciarComentario"] {
            color: #f0f8ff !important; /* Branco Gelo */
        }
        
        /* 5. Texto do Vers√≠culo Selecionado (Branco Gelo no Modo Escuro) */
        /* Aquele texto de pr√©-visualiza√ß√£o no menu inferior que estava cinza */
        body.modo-escuro #modal-verso p,
        body.modo-escuro #texto-verso-preview {
            color: #f0f8ff !important; /* Branco Gelo */
            opacity: 1 !important;
        }
        
        /* --- 1. Cores Padr√£o (Modo Claro) --- */
        /* Estas s√£o as cores que estavam originalmente no teu HTML inline */
        
        #titulo-editor {
            color: #2c3e50; /* Azul escuro original */
        }
        
        #ref-editor {
            color: #7f8c8d; /* Cinzento original */
        }
        
        
        /* --- 2. Cores do Modo Escuro --- */
        
        /* Muda o t√≠tulo para Branco Gelo no modo escuro */
        body.dark-mode #titulo-editor {
            color: #f8f9fa;
        }
        
        /* Muda a refer√™ncia para Branco Gelo no modo escuro */
        body.dark-mode #ref-editor {
            color: #f8f9fa;
            /* Opcional: Podes querer a refer√™ncia ligeiramente mais escura que o t√≠tulo para hierarquia */
            /* color: #ecf0f1; */
        }
        
        /* --- B√ìNUS: Adapta√ß√£o do fundo do modal --- */
        /* Se o texto ficar branco, o fundo da caixa precisa de ser escuro para haver contraste */
        body.dark-mode .caixa-editor {
            background-color: #34495e; /* Um tom de azul acinzentado escuro */
            color: #ecf0f1; /* Garante que qualquer outro texto na caixa tamb√©m fique claro */
        }
        
        /* Adapta√ß√£o da √°rea de texto (textarea) no modo escuro */
        body.dark-mode #texto-nota-input {
            background-color: #2c3e50; /* Fundo mais escuro para a √°rea de texto */
            color: #f8f9fa;            /* Texto claro ao digitar */
            border: 1px solid #7f8c8d; /* Borda mais subtil */
        }
        
        /* --- 1. Estilo Padr√£o (Modo Claro) --- */
        /* Repliquei aqui exatamente o que estava no style inline */
        #texto-verso-preview {
            background: #f5f5f5;          /* Fundo cinza claro */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-style: italic;
            color: #444;                  /* Texto cinza escuro */
            border-left: 3px solid #666;  /* Borda esquerda cinza m√©dia */
        }
        
        /* --- 2. Adapta√ß√£o para Modo Escuro --- */
        body.dark-mode #texto-verso-preview {
            /* Cor do texto: Branco Gelo (O que pediste) */
            color: #f8f9fa;
        
            /* Fundo: Precisamos escurecer, sen√£o o branco n√£o aparece.
               Usei um tom cinza escuro suave */
            background: #3e4c59; 
        
            /* Borda: Clarear um pouco a borda para destacar no fundo escuro */
            border-left: 3px solid #bdc3c7;
        }

        
        /* --- 1. Estilo Padr√£o (Modo Claro) --- */
        #titulo-modal-verso {
            font-weight: bold;  /* Estava no inline */
            font-size: 18px;    /* Estava no inline */
            color: #555;        /* Cor cinza original */
        }
        
        /* --- 2. Adapta√ß√£o para Modo Escuro --- */
        body.dark-mode #titulo-modal-verso {
            color: #f8f9fa; /* Branco Gelo */
        }
        
        /* ==========================================================================
           MODAL DE CONFIRMA√á√ÉO (VERS√ÉO BLINDADA & CORRIGIDA)
           ========================================================================== */
        
        /* 1. ESTRUTURA E POSICIONAMENTO (N√£o muda com o tema) */
        #modal-confirmacao {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background-color: rgba(0,0,0,0.5);
        }
        
        /* Regra para esconder */
        #modal-confirmacao.escondido {
            display: none !important;
        }
        
        /* 2. CAIXA - APAR√äNCIA PADR√ÉO (MODO CLARO) */
        /* Usamos o ID aqui para garantir que pegamos o elemento certo */
        #modal-confirmacao .caixa-confirmacao {
            background: #fff;       /* Fundo Branco */
            width: 90%;
            max-width: 350px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
            margin: 0;
            border: 1px solid transparent; /* Reserva espa√ßo para borda */
        }
        
        /* Textos (Modo Claro) */
        #modal-confirmacao #titulo-confirmacao {
            margin-top: 0;
            color: #2c3e50;         /* Azul Escuro */
        }
        
        #modal-confirmacao #texto-confirmacao {
            color: #555;            /* Cinza */
            margin-bottom: 25px;
            font-size: 16px;
            line-height: 1.4;
        }
        
        /* 3. BOT√ïES (Estrutura) */
        #modal-confirmacao .botoes-editor {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            width: 100%;
        }
        
        #modal-confirmacao .btn-cancelar,
        #modal-confirmacao .btn-salvar {
            flex: 1;
            padding: 10px 0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* Bot√£o Cancelar (Modo Claro) */
        #modal-confirmacao .btn-cancelar {
            background: #eee;
            color: #333;
            border: 1px solid #ccc;
        }
        
        /* ==========================================================================
           4. MODO ESCURO (CORRIGIDO PARA .modo-escuro)
           ========================================================================== */
        
        /* Caixa no Modo Escuro */
        body.modo-escuro #modal-confirmacao .caixa-confirmacao {
            /* Mudei de azul (#34495e) para Cinza Escuro Neutro (#1e1e1e) */
            background-color: #1e1e1e !important; 
            
            /* Borda mais suave para combinar com cinza */
            border: 1px solid #333 !important; 
            
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        
        /* T√≠tulo no Modo Escuro */
        body.modo-escuro #modal-confirmacao #titulo-confirmacao {
            color: #f8f9fa !important; /* Branco Gelo */
        }
        
        /* Texto no Modo Escuro */
        body.modo-escuro #modal-confirmacao #texto-confirmacao {
            color: #ccc !important; /* Cinza claro para leitura */
        }
        
        /* Bot√£o Cancelar no Modo Escuro */
        body.modo-escuro #modal-confirmacao .btn-cancelar {
            background-color: transparent !important;
            border: 1px solid #444 !important;     /* Borda cinza escuro sutil */
            color: #f8f9fa !important;             /* Texto Branco */
        }
        
        /* Bot√£o Confirmar no Modo Escuro */
        body.modo-escuro #modal-confirmacao .btn-salvar {
            border: none !important;
            color: #fff !important;
            /* Mant√©m a cor original do bot√£o (provavelmente verde ou azul) */
        }
        
        /* Estilo para o item que cont√©m a lixeira */
        .item-ref {
            position: relative; /* Permite posicionar a lixeira absolutamente dentro dele */
            padding-right: 45px !important; /* Espa√ßo para a lixeira n√£o ficar em cima do texto */
            cursor: pointer;
        }
        
        /* Bot√£o da Lixeira Individual */
        .btn-deletar-individual {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(231, 76, 60, 0.1);
            border: none;
            color: #e74c3c;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10; /* Garante que fica acima do clique da div */
        }
        
        .btn-deletar-individual:hover {
            background: #e74c3c;
            color: #fff;
        }
        
        /* Ajuste no modo escuro */
        body.modo-escuro .btn-deletar-individual {
            background: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }

        /* --- ESTILO DO MODAL DE LEITURA R√ÅPIDA --- */

        /* A Janela Flutuante */
        .janela-leitura-perfil {
            background: #fff;
            width: 90%;
            max-width: 600px;
            height: 80vh; /* Ocupa 80% da altura da tela */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Modo Tela Cheia (Aplicado via JS) */
        .janela-leitura-perfil.tela-cheia {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
            border-radius: 0 !important;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            z-index: 2005;
        }
        
        /* Cabe√ßalho */
        .cabecalho-leitura-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        
        .cabecalho-leitura-modal h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .acoes-leitura-modal button {
            background: transparent;
            border: none;
            font-size: 20px;
            color: #7f8c8d;
            cursor: pointer;
            margin-left: 15px;
            padding: 5px;
        }
        .acoes-leitura-modal button:hover { color: #2c3e50; }
        
        /* Corpo do Texto (Com Scroll) */
        #conteudo-leitura-modal {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            scroll-behavior: smooth;
        }
        
        /* Vers√≠culo dentro do Modal */
        .verso-modal {
            padding: 5px 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        /* O Vers√≠culo Destacado (Foco) */
        .verso-destaque-foco {
            background-color: rgba(255, 235, 59, 0.4); /* Amarelo Marca-texto */
            border-left: 4px solid #fbc02d;
            font-weight: bold;
            animation: piscarFoco 2s infinite;
        }
        
        @keyframes piscarFoco {
            0% { background-color: rgba(255, 235, 59, 0.4); }
            50% { background-color: rgba(255, 235, 59, 0.7); }
            100% { background-color: rgba(255, 235, 59, 0.4); }
        }
        
        /* N√∫mero do verso */
        .num-verso-modal {
            font-size: 12px;
            color: #999;
            vertical-align: super;
            margin-right: 5px;
            font-weight: bold;
        }
        
        /* --- MODO ESCURO --- */
        body.modo-escuro .janela-leitura-perfil {
            background: #1f1f1f;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        }
        body.modo-escuro .cabecalho-leitura-modal {
            background: #2c2c2c;
            border-bottom-color: #444;
        }
        body.modo-escuro .cabecalho-leitura-modal h3 { color: #ecf0f1; }
        body.modo-escuro .acoes-leitura-modal button { color: #bdc3c7; }
        body.modo-escuro #conteudo-leitura-modal { color: #dcdcdc; }
        body.modo-escuro .verso-destaque-foco {
            background-color: rgba(251, 192, 45, 0.2); /* Amarelo mais suave no escuro */
            border-left-color: #fbc02d;
            color: #fff;
        }

        /* Ajuste espec√≠fico para dispositivos m√≥veis */
        @media (max-width: 768px) {
            #modal-leitura-perfil {
                /* Adiciona um recuo no topo. 
                   O '20px' √© o valor fixo e o 'env' √© para notch de celulares modernos */
                top: calc(50px + env(safe-area-inset-top)) !important;
                
                /* Opcional: ajustar a altura m√°xima para n√£o cortar o fundo */
                max-height: 85vh; 
                overflow-y: auto;
            }
        }

        /* --- CSS PARA O MODAL DE COMPARA√á√ÉO --- */

        /* O Container principal do conte√∫do do modal */
        .modal-flex-container {
            display: flex;           /* Ativa o modo flex√≠vel */
            flex-direction: column;  /* Organiza um item embaixo do outro */
            height: 100%;           /* Ocupa toda a altura dispon√≠vel do modal */
            max-height: 80vh;       /* Limite de altura (80% da tela) */
            overflow: hidden;       /* Impede que o container todo role */
        }
        
        /* A parte de cima (Cabe√ßalho fixo) */
        .modal-header-fixo {
            flex-shrink: 0;         /* N√£o deixa encolher */
            background-color: var(--cor-fundo, #fdfbf7); /* Mesma cor do fundo */
            border-bottom: 1px solid #ccc;
            padding: 15px;
            z-index: 10;
            /* Garante que fique acima visualmente */
            position: relative; 
        }
        
        /* A parte de baixo (Lista que rola) */
        .modal-corpo-rolavel {
            flex-grow: 1;           /* Ocupa todo o espa√ßo que sobrar */
            overflow-y: auto;       /* CRUCIAL: S√≥ essa parte vai ter rolagem */
            padding: 15px;
            -webkit-overflow-scrolling: touch; /* Rolagem suave no iPhone */
        }
        
        /* Ajuste para modo noturno (se tiver) */
        @media (prefers-color-scheme: dark) {
            .modal-header-fixo {
                background-color: #1a1a1a; /* Cor de fundo escura */
                border-bottom: 1px solid #444;
            }
        }
        
        @media (max-width: 768px) {
            #modal-comparacao .modal-conteudo {
                width: 95%;
                max-height: 90vh; /* Aumenta um pouco a altura no celular */
                margin: 10px auto;
            }
        }
        
        /* 1. Estilo padr√£o (Geral e PC) */
        #lista-comparacao {
            /* No PC, um padding pequeno de 20px √© o suficiente */
            padding-bottom: 50px !important; 
            
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            
            /* Preven√ß√£o para laterais */
            padding-left: calc(15px + env(safe-area-inset-left));
            padding-right: calc(15px + env(safe-area-inset-right));
        }
        
        /* 2. Ajuste exclusivo para Celulares (telas at√© 768px) */
        @media (max-width: 768px) {
            #lista-comparacao {
                /* No celular, ativamos o espa√ßo para as abas + iPhone */
                padding-bottom: calc(130px + env(safe-area-inset-bottom)) !important;
            }
        }

        /* --- BOT√ïES DA BUSCA (CSS BLINDADO) --- */

        /* 1. Estilo Padr√£o (Modo Claro) */
        /* Mantemos exatamente as cores que tinhas no inline */
        .btn-pesquisar-principal {
            flex: 1;
            padding: 15px;
            background-color: #3498db; /* Azul Original */
            color: white;
            border: none;
            transition: background-color 0.3s; /* Suavidade na troca */
        }
        
        .btn-limpar-busca {
            width: 70px;
            padding: 15px;
            background-color: #95a5a6; /* Cinza Claro Original */
            color: white;
            border: none;
            transition: background-color 0.3s;
        }
        
        /* 2. Estilo Modo Escuro (Cinza Fosco) */
        /* Aqui aplicamos a cor "Cinza Fosco" quando o body tiver a classe modo-escuro */
        body.modo-escuro .btn-pesquisar-principal,
        body.modo-escuro .btn-limpar-busca {
            background-color: #2c2c2c; /* Cinza Fosco (Matte) */
            border: 1px solid #444;    /* Uma borda sutil para defini√ß√£o */
            color: #ecf0f1;            /* Texto quase branco */
        }
        
        /* Opcional: Efeito ao passar o mouse no modo escuro */
        body.modo-escuro .btn-pesquisar-principal:active,
        body.modo-escuro .btn-limpar-busca:active {
            background-color: #1a1a1a; /* Escurece levemente ao clicar */
        }
        
        body.modo-escuro .btn-comparar {
            background-color: #2c2c2c; /* O mesmo Cinza Fosco dos outros bot√µes */
            border: 1px solid #444;    /* Borda discreta */
            color: #ecf0f1;            /* Texto Branco Gelo */
            transition: background-color 0.3s;
        }
        
        /* Efeito ao clicar (fica um pouco mais escuro) */
        body.modo-escuro .btn-comparar:active {
            background-color: #1a1a1a;
            transform: scale(0.98);
        }
        
        /* Estilo para garantir que a subtela ocupe o espa√ßo correto */
        .tela-cheia-container {
            padding: 15px;
            padding-bottom: 60px; /* Espa√ßo extra no final para rolar */
            animation: fadeIn 0.2s ease-out;
        }
        
        .item-traducao-cheia {
            background: rgba(255, 255, 255, 0.5); /* Leve fundo branco */
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #2c3e50; /* Destaque lateral */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        body.modo-escuro .item-traducao-cheia {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #3498db;
        }
        
        .item-traducao-cheia .comp-versao {
            font-weight: bold;
            font-size: 0.8em;
            color: #e67e22;
            display: block;
            margin-bottom: 5px;
        }
        
        .item-traducao-cheia .comp-texto {
            font-size: 1.05em;
            line-height: 1.5;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Garante que o fundo use a vari√°vel de tema */
        #overlay-comparacao {
            background-color: var(--bg-color, #fdfbf7); 
            /* Se voc√™ usa background no body, ele vai herdar ou cobrir. 
               Se o modo escuro n√£o funcionar, force aqui: */
        }
        
        body.modo-escuro #overlay-comparacao {
            background-color: #1a1a1a; /* Cor de fundo do modo escuro */
        }
        
        /* --- CORRE√á√ÉO BLINDADA: MODO ESCURO NA COMPARA√á√ÉO --- */

        /* 1. Garante que o fundo da tela cheia seja escuro */
        body.modo-escuro #overlay-comparacao {
            background-color: #121212 !important; /* Preto suave */
            color: #e0e0e0 !important;            /* Texto base claro */
        }
        
        /* 2. Corrige o cabe√ßalho (Bot√£o Voltar e T√≠tulo) */
        body.modo-escuro #overlay-comparacao .cabecalho-subtela {
            background-color: #1f1f1f !important; /* Cinza um pouco mais claro */
            border-bottom: 1px solid #333 !important;
        }
        
        body.modo-escuro #overlay-comparacao h3 {
            color: #ffffff !important; /* T√≠tulo branco puro */
        }
        
        /* 3. Estilo dos Cart√µes (Cada vers√£o da B√≠blia) */
        body.modo-escuro .item-traducao-cheia {
            /* Troca a transpar√™ncia por um cinza s√≥lido leg√≠vel */
            background-color: #2c2c2c !important; 
            border: 1px solid #444 !important;    
            border-left: 4px solid #3498db !important; /* Mant√©m a cor azul lateral */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3) !important;
        }
        
        /* 4. A Sigla da Vers√£o (ex: NVI, ARC) */
        body.modo-escuro .item-traducao-cheia .comp-versao {
            color: #90caf9 !important; /* Azul claro neon */
            font-weight: bold;
        }
        
        /* 5. O Texto do Vers√≠culo (A leitura em si) */
        body.modo-escuro .item-traducao-cheia .comp-texto {
            color: #ecf0f1 !important; /* Branco Gelo (Leitura confort√°vel) */
            font-size: 1.1rem; /* Um pouco maior para facilitar leitura noturna */
        }
        
        /* 6. Bot√£o Voltar dentro do Overlay */
        body.modo-escuro #overlay-comparacao .btn-voltar-perfil {
            border-color: #666 !important;
            color: #fff !important;
        }

        /* --- TURBINAR O MENU INFERIOR (M√ìVEL) --- */
        @media (max-width: 768px) {
            
            /* 1. A BARRA EM SI */
            .menu-inferior {
                /* Aumenta a altura para ficar mais "parrudo" */
                height: auto !important; 
                min-height: 75px !important; 
                
                /* Prote√ß√£o vital para iPhone e Androids novos (Barra de gestos) */
                padding-bottom: calc(env(safe-area-inset-bottom) + 10px) !important;
                padding-top: 10px !important;
                
                /* Garante alinhamento */
                display: flex !important;
                justify-content: space-around !important;
                align-items: center !important;
                
                /* Sombra para destacar do conte√∫do */
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
            }
        
            /* 2. OS BOT√ïES DENTRO DA BARRA */
            .menu-inferior button, 
            .menu-inferior .item-menu {
                /* Aumenta o tamanho geral (√çcone + Texto) */
                font-size: 1.1rem !important; 
                
                /* D√° mais espa√ßo para o toque */
                padding: 5px !important;
                
                /* Se tiver √≠cones e texto, empilha eles bonitinho */
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                flex: 1 !important; /* Faz todos terem a mesma largura */
            }
        
            /* Opcional: Se usares √≠cones separados do texto */
            .menu-inferior svg, 
            .menu-inferior i {
                font-size: 1.5rem !important; /* √çcone grande */
                margin-bottom: 4px !important;
            }
        }
        
        /* --- CORRE√á√ÉO DA CAIXINHA NA LISTA --- */
        .nota-preview {
            background-color: #fff3cd; /* Fundo Amarelo */
            color: #856404;            /* Texto Amarelo Escuro */
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 14px;
            font-style: italic;
            border-left: 4px solid #ffeeba;
            
            /* O SEGREDO PARA N√ÉO SAIR DA CAIXA: */
            white-space: pre-wrap;      /* Respeita as quebras de linha que voc√™ deu */
            word-wrap: break-word;      /* Quebra palavras muito longas */
            word-break: break-word;     /* Garante que n√£o estoure a largura */
        }
        
        /* --- ESTILO DO NOVO MODAL DE LEITURA (CENTRALIZADO) --- */
        .modal-centro-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.6); /* Fundo escuro transparente */
            z-index: 10005; /* Bem na frente */
            
            display: none; /* Come√ßa escondido */
            align-items: center;     /* Centraliza Verticalmente */
            justify-content: center; /* Centraliza Horizontalmente */
            backdrop-filter: blur(2px);
        }
        
        .modal-centro-card {
            background-color: #fff;
            width: 90%;
            max-width: 500px; /* Largura m√°xima bonita no PC */
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            animation: zoomIn 0.2s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Estilos internos do Modal de Leitura */
        .modal-leitura-ref {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-leitura-texto-biblico {
            font-size: 18px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 25px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .modal-leitura-comentario {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap; /* Mant√©m par√°grafos */
        }
        
        /* Modo Escuro para o Modal */
        body.modo-escuro .modal-centro-card { background-color: #2c2c2c; color: #eee; }
        body.modo-escuro .modal-leitura-ref { color: #ecf0f1; border-color: #444; }
        body.modo-escuro .modal-leitura-texto-biblico { background-color: #333; color: #ddd; border-left-color: #2980b9; }
        body.modo-escuro .modal-leitura-comentario { background-color: #443e2a; color: #f1c40f; border-color: #555; }

        /* --- CORRE√á√ÉO FINAL DO MODAL DE NOTAS --- */
        #leitura-nota-usuario {
            /* Define altura m√°xima e barra de rolagem */
            max-height: 40vh;          /* M√°ximo de 40% da altura da tela */
            overflow-y: auto;          /* Cria scroll se passar disso */
            
            /* Obriga o texto a quebrar linha e n√£o vazar */
            word-wrap: break-word;     
            white-space: pre-wrap;     
            
            /* Estilo da caixinha */
            background-color: #fff3cd; 
            color: #856404;            
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            font-size: 16px;
            margin-top: 10px;
        }
        
        /* Ajuste para o texto do vers√≠culo tamb√©m ter scroll se for gigante */
        #leitura-texto-biblico {
            max-height: 30vh;
            overflow-y: auto;
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        /* --- ESTILOS DO MODAL ALERTA (C√≥pia fiel do Confirmacao) --- */

        /* 1. Fundo e Posi√ß√£o */
        #modal-alerta {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2005; /* Um pouco acima do confirma√ß√£o */
            background-color: rgba(0,0,0,0.5);
        }
        
        #modal-alerta.escondido {
            display: none !important;
        }
        
        /* 2. Caixa (Modo Claro Padr√£o) */
        #modal-alerta .caixa-confirmacao {
            background: #fff;
            width: 90%;
            max-width: 350px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid transparent;
        }
        
        /* 3. Adapta√ß√£o para MODO ESCURO */
        body.modo-escuro #modal-alerta .caixa-confirmacao {
            background-color: #1e1e1e !important; 
            border: 1px solid #333 !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        
        body.modo-escuro #modal-alerta #titulo-alerta {
            color: #f8f9fa !important;
        }
        
        body.modo-escuro #modal-alerta #texto-alerta {
            color: #ccc !important;
        }
        
        /* --- ESTILO DOS MODAIS DE SISTEMA --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Fica acima de tudo */
            backdrop-filter: blur(2px);
        }

        .caixa-confirmacao {
            background: white; /* ou cor do seu tema escuro */
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
        }

        /* Anima√ß√£o de entrada */
        .zoom-in {
            animation: zoomIn 0.3s ease;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .btn-modal {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* --- MODO ESCURO (A M√°gica) --- */
        body.modo-escuro .caixa-confirmacao,
        body.dark-mode .caixa-confirmacao {
            background: #1e1e1e;
            color: #f0f0f0;
            border: 1px solid #333;
        }

        body.modo-escuro .caixa-confirmacao h3,
        body.dark-mode .caixa-confirmacao h3 {
            color: #ecf0f1; /* Branco gelo */
        }

        body.modo-escuro .caixa-confirmacao p,
        body.dark-mode .caixa-confirmacao p {
            color: #bbb;
        }

        body.modo-escuro .caixa-confirmacao textarea,
        body.dark-mode .caixa-confirmacao textarea {
            background: #2c2c2c;
            color: #fff;
            border: 1px solid #444;
        }

        /* Anima√ß√£o e Bot√µes */
        .zoom-in { animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .btn-modal {
            width: 100%;
            padding: 12px;
            margin-top: 8px; /* Espacinho entre bot√µes */
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: filter 0.2s;
        }
        .btn-modal:active { transform: scale(0.98); }

        /* --- CORRE√á√ÉO: Texto do Vers√≠culo nas Listas (Modo Escuro) --- */

        /* --- COR DO TEXTO DO VERS√çCULO --- */

        /* Cor Padr√£o (Modo Claro) */
        .verso-preview {
            color: #555;
        }

        /* Cor no Modo Escuro (Branco Gelo) */
        body.modo-escuro .verso-preview,
        body.dark-mode .verso-preview {
            color: #ecf0f1 !important;
        }
        
    </style>
</head>
<body id="corpo-app">

    <header id="cabecalho-principal">
        <button id="btn-tema" onclick="alternarTema()">üåó</button>
        <h1 id="titulo-app">B√≠blia Sagrada</h1>
        
        <div id="area-versao" class="dropdown-container seletor-versao-container escondido">
            
            <button id="btn-versao-selecionada" onclick="alternarMenuVersoes()">NVI</button>

            <div id="lista-versoes-custom" class="dropdown-menu escondido" 
                 style="max-height: 50vh; overflow-y: auto; border: 1px solid #ccc;">
            </div>
        </div>
    </header>

    <div id="loading">‚è≥ Carregando...</div>

    <main id="area-principal">
        
        <div id="tab-biblia">
            <div id="tela-livros"></div>
            <div id="tela-capitulos" class="grade-capitulos escondido"></div>
            
            <div id="tela-leitura" class="escondido">
                <h2 id="titulo-capitulo-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-biblico" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-hinarios" class="escondido">
            <div id="tela-escolha-hinario" class="grade-livros" style="margin-top:20px;">
                <button class="btn-hinario" onclick="abrirHinario('harpa')">üéµ Harpa Crist√£</button>
                <button class="btn-hinario" onclick="abrirHinario('cantor')">üéº Cantor Crist√£o</button>
            </div>

            <div id="tela-lista-hinos" class="escondido">
                <button class="btn-voltar-topo" onclick="voltarParaEscolhaHinario()">&#11013; Voltar aos Hin√°rios</button>
                <input type="text" id="busca-hino" placeholder="N√∫mero ou nome..." 
                       style="width:90%; padding:15px; margin: 0 auto 15px auto; display:block; font-size:18px; border-radius:8px; border:1px solid #ccc;"
                       onkeyup="filtrarHinos()">
                <div id="lista-hinos-container" class="lista-hinos"></div>
            </div>

            <div id="tela-leitura-hino" class="escondido">
                <h2 id="titulo-hino-leitura" style="text-align:center; margin-top:0;"></h2>
                <div id="texto-hino" onclick="alternarImersao()"></div>
            </div>
        </div>

        <div id="tab-busca" class="escondido">
            <div class="container-busca">
                <div class="wrapper-input">
                    <input type="text" id="input-busca" placeholder="Digite ou fale (ex: Jesus chorou)..." onkeyup="if(event.key === 'Enter') realizarBusca()">
                    <button id="btn-mic" onclick="ativarMicrofone()">üé§</button>
                </div>
        
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-livro btn-pesquisar-principal" onclick="realizarBusca()">
                        üîç Pesquisar
                    </button>
                    
                    <button class="btn-livro btn-limpar-busca" onclick="limparBusca()">
                        üóë
                    </button>
                </div>
                
                <div id="resultados-busca"></div>
            </div>
        </div>
        
        <div id="tela-meus-dados" class="tela-conteudo escondido">
        
            <div id="menu-perfil-principal" class="anime-fade">
                
                <div class="lista-opcoes-perfil">
                    <button class="btn-opcao-perfil" onclick="abrirTelaProgressao()">
                        <span class="icone-grande">üìä</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Progress√£o de Leitura</span>
                            <span class="desc-opcao">Estat√≠sticas e livros lidos</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
    
                    <button class="btn-opcao-perfil" onclick="abrirTelaFavoritos()">
                        <span class="icone-grande">‚≠ê</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Vers√≠culos Favoritos</span>
                            <span class="desc-opcao">Seus textos marcados</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
    
                    <button class="btn-opcao-perfil" onclick="abrirTelaComentarios()">
                        <span class="icone-grande">üìù</span>
                        <div class="texto-opcao">
                            <span class="titulo-opcao">Meus Coment√°rios</span>
                            <span class="desc-opcao">Reflex√µes e anota√ß√µes</span>
                        </div>
                        <span class="seta-opcao">‚ûî</span>
                    </button>
                </div>
                <div style="margin-top: 25px; border-top: 1px solid #ddd; padding-top: 15px; padding-bottom: 30px;">
                    <h4 style="margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px; text-transform: uppercase; text-align: center;">Seguran√ßa dos Dados</h4>
                    
                    <div style="display: flex; gap: 10px; flex-direction: column; padding: 0 15px;">
                        <button onclick="fazerBackup()" class="btn-config" style="background-color: #3498db; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>üì§</span> Fazer Backup
                        </button>

                        <button onclick="acionarRestauracao()" class="btn-config" style="background-color: #27ae60; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span>üì•</span> Restaurar Backup
                        </button>

                        <p style="font-size: 12px; color: #999; text-align: center; margin: 5px 0 0 0;">
                            Gere um c√≥digo de seguran√ßa para salvar seus dados.
                        </p>
                    </div>

                    <input type="file" id="input-restore-hidden" style="display: none;" accept=".json" onchange="processarArquivoBackup(this)">
                </div>
            </div>
    
            <div id="view-progressao" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Estat√≠sticas</h3>
                </div>
                <div class="painel-resumo">
                    <div class="card-dado"> <span class="dado-valor" id="total-lido-pct">0%</span> <span class="dado-label">B√≠blia</span> </div>
                    <div class="card-dado"> <span class="dado-valor" id="total-caps-lidos">0</span> <span class="dado-label">Cap√≠tulos</span> </div>
                </div>
                <div id="lista-progresso-livros"></div>
                <button onclick="resetarProgresso()" class="btn-resetar">üóëÔ∏è Zerar Leitura</button>
                <div style="height: 100px;"></div>
            </div>
    
            <div id="view-favoritos" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Favoritos</h3>
                </div>
                <div id="lista-favoritos-container" style="padding: 15px;"></div>
                <button onclick="resetarFavoritos()" class="btn-resetar">üóëÔ∏è Apagar Favoritos</button>
                <div style="height: 100px;"></div>
            </div>
    
            <div id="view-comentarios" class="sub-tela escondido">
                <div class="cabecalho-subtela">
                    <button class="btn-voltar-perfil" onclick="voltarMenuPerfil()">‚¨Ö Voltar</button>
                    <h3>Anota√ß√µes</h3>
                </div>
                <div id="lista-comentarios-container" style="padding: 15px;"></div>
                <button onclick="resetarComentarios()" class="btn-resetar">üóëÔ∏è Apagar Coment√°rios</button>
                <div style="height: 100px;"></div>
            </div>
        </div>
    
        <div id="modal-verso" class="modal-overlay escondido" onclick="fecharModalVerso(event)">
            <div class="modal-bottom-sheet" onclick="event.stopPropagation()">
                
                <div class="modal-header">
                    <span id="titulo-modal-verso">G√™nesis 1:1</span>
                    <button onclick="fecharModalVerso()" style="border:none; background:none; font-size:20px; padding: 10px;">‚úï</button>
                </div>
                
                <div id="texto-verso-preview">
                    "No princ√≠pio criou Deus os c√©us e a terra..."
                </div>
    
                <button class="btn-modal-acao" onclick="copiarVersoSelecionado()" style="margin-bottom: 10px; background-color: #34495e; color: white;">
                    üìã Copiar Vers√≠culo
                </button>
                
                <p style="font-size:14px; color:#777; margin: 10px 0; text-align: center;">Marcar cor:</p>
                
                <div class="opcoes-cores">
                    <button class="btn-cor cor-azul" onclick="aplicarCor('azul')"></button>
                    <button class="btn-cor cor-amarelo" onclick="aplicarCor('amarelo')"></button>
                    <button class="btn-cor cor-rosa" onclick="aplicarCor('rosa')"></button>
                    <button class="btn-cor cor-verde" onclick="aplicarCor('verde')"></button>
                    <button class="btn-cor cor-vermelho" onclick="aplicarCor('vermelho')"></button>
                    <button class="btn-cor cor-limpar" onclick="aplicarCor('limpar')">‚úï</button>
                </div>
    
                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
    
                <button class="btn-modal-acao" onclick="iniciarComentario()">
                    üìù Adicionar / Editar Nota
                </button>
            </div>
        </div>
            
        <div id="modal-editor-nota" class="modal-overlay escondido">
            <div class="caixa-editor zoom-in">
                <h3 id="titulo-editor" style="margin-top:0;">Minha Anota√ß√£o</h3>
        
                <p id="ref-editor" style="font-size: 14px; margin-bottom: 10px;">G√™nesis 1:1</p>
        
                <textarea id="texto-nota-input" placeholder="Escreva sua reflex√£o aqui..."></textarea>
        
                <div class="botoes-editor">
                    <button class="btn-cancelar" onclick="fecharEditorNota()">Cancelar</button>
                    <button class="btn-salvar" onclick="salvarNotaPeloModal()">Salvar</button>
                </div>
            </div>
        </div>
        
        <div id="modal-confirmacao" class="modal-overlay escondido">
            <div class="caixa-confirmacao zoom-in">
                <h3 id="titulo-confirmacao">Confirma√ß√£o</h3>
                <p id="texto-confirmacao">Tem certeza que deseja realizar esta a√ß√£o?</p>
                
                <div class="botoes-editor">
                    <button class="btn-cancelar" onclick="fecharModalConfirmacao()">
                        Cancelar
                    </button>
                    <button class="btn-salvar" onclick="executarAcaoConfirmada()">
                        Confirmar ‚úì
                    </button>
                </div>
            </div>
        </div>
        
        <div id="modal-leitura-perfil" class="modal-overlay escondido">
            <div class="janela-leitura-perfil zoom-in">
                
                <div class="cabecalho-leitura-modal">
                    <h3 id="titulo-leitura-modal">Salmos 23</h3>
                    <div class="acoes-leitura-modal">
                        <button onclick="alternarTelaCheiaModal()" title="Tela Cheia">‚§¢</button>
                        <button onclick="fecharModalLeituraPerfil()" title="Fechar">‚úï</button>
                    </div>
                </div>
        
                <div id="conteudo-leitura-modal">
                    </div>
        
            </div>
        </div>
        
    </main>

   <div id="modal-comparacao" class="modal escondido">
        <div class="modal-conteudo" style="display: flex; flex-direction: column; padding: 0; overflow: hidden;">
            <div style="padding: 15px 20px; border-bottom: 1px solid #ddd; position: relative; flex-shrink: 0; background: var(--cor-fundo);">
                <button class="btn-fechar" onclick="fecharComparacao()" style="position: absolute; top: 12px; right: 15px; margin: 0;">‚úñ</button>
                <h3 id="titulo-comparacao" style="margin: 0; padding-right: 30px; font-size: 1.2rem;">Vers√≠culo</h3>
            </div>
            
            <div id="lista-comparacao" style="overflow-y: auto; flex-grow: 1; padding: 20px 20px 120px 20px;">
                Carregando...
            </div>
        </div>
    </div>

    <div id="modal-leitura-nota" class="modal-centro-overlay" onclick="fecharModalLeitura(event)">
        <div class="modal-centro-card" onclick="event.stopPropagation()"> <div class="modal-leitura-ref">
                <span id="leitura-titulo">Livro 1:1</span>
                <button onclick="fecharModalLeitura()" style="background:none; border:none; font-size:24px; color:#e74c3c; cursor:pointer;">&times;</button>
            </div>
    
            <div id="leitura-texto-biblico" class="modal-leitura-texto-biblico">
                "Texto do vers√≠culo aparecer√° aqui..."
            </div>
    
            <label style="font-size:12px; color:#999; font-weight:bold; margin-bottom:5px; display:block;">SEU COMENT√ÅRIO:</label>
            <div id="leitura-nota-usuario" class="modal-leitura-comentario">
                Seu coment√°rio aparecer√° aqui...
            </div>
    
            <button onclick="editarNotaAtual()" style="width:100%; margin-top:20px; padding:12px; background:#3498db; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                Editar Coment√°rio
            </button>
    
        </div>
    </div>

    <div id="modal-alerta" class="escondido" onclick="fecharAlerta()">
        <div class="caixa-confirmacao" onclick="event.stopPropagation()">
            
            <h3 id="titulo-alerta" style="margin-top: 0; color: #2c3e50;">Aviso</h3>
            
            <div id="texto-alerta" style="margin-bottom: 25px; font-size: 16px; line-height: 1.4; color: #555;">
                </div>
    
            <div class="botoes-editor" style="justify-content: center;">
                <button class="btn-salvar" onclick="fecharAlerta()" style="background-color: #2ecc71; border: none; width: 100%; max-width: 150px; color: white;">
                    OK
                </button>
            </div>
        </div>
    </div>

    <footer id="rodape-nav" class="escondido">
        <button type="button" class="btn-nav btn-voltar-menu" onclick="voltarInicioLeitura()">Voltar</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(-1)">&#9664;</button>
        <button type="button" class="btn-nav" onclick="navegarConteudo(1)">&#9654;</button>
    </footer>

    <nav id="abas-principais">
        <button class="aba ativa" onclick="mudarAba('biblia')" id="btn-aba-biblia">
            <span class="icone-aba">üìñ</span> B√≠blia
        </button>
        <button class="aba" onclick="mudarAba('busca')" id="btn-aba-busca">
            <span class="icone-aba">üîç</span> Busca
        </button>
        <button class="aba" onclick="mudarAba('hinarios')" id="btn-aba-hinarios">
            <span class="icone-aba">üéµ</span> Hin√°rios
        </button> <button class="aba" onclick="mudarAba('dados')" id="btn-aba-dados">
            <span class="icone-aba">üë§</span> Perfil
        </button>
    </nav>

    <script>
        // --- SERVICE WORKER ---
        // --- SERVICE WORKER COM ATUALIZA√á√ÉO AUTOM√ÅTICA ---
        if ('serviceWorker' in navigator) {
            
            // Vari√°vel de controle para impedir recarregamentos infinitos
            let refreshing = false;
    
            // 1. O PULO DO GATO: Escuta quando o novo SW assume o controle
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload(); // Recarrega a p√°gina sozinho!
                }
            });
    
            // 2. Registro padr√£o ao carregar a p√°gina
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    // For√ßa o navegador a verificar se existe uma vers√£o nova (v37, v38...)
                    registration.update();
                    console.log('Service Worker registrado com sucesso:', registration.scope);
                }).catch(err => {
                    console.log('Falha ao registrar Service Worker:', err);
                });
            });
        }

        // --- O "C√ìDIGO DE CHOQUE" (Simula o efeito do teclado) ---
        document.addEventListener("visibilitychange", function() {
            if (document.visibilityState === "visible") {
                
                // Tenta 3 vezes em tempos diferentes para garantir que pegou o navegador "acordado"
                [50, 150, 300].forEach(tempo => {
                    setTimeout(() => {
                        
                        // 1. Simula que a tela mudou de tamanho (engana o navegador)
                        window.dispatchEvent(new Event('resize'));
        
                        // 2. A "Tremidinha": Rola 1px e volta (for√ßa a GPU a redesenhar)
                        window.scrollBy(0, 1);
                        window.scrollBy(0, -1);
        
                        // 3. Reafirma a altura correta (o c√≥digo que j√° t√≠nhamos)
                        let alturaReal = window.innerHeight;
                        document.body.style.height = alturaReal + "px";
                        window.scrollTo(0, 0); // Garante topo
        
                    }, tempo);
                });
            }
        });

        const listaLivros = ["G√™nesis","√äxodo","Lev√≠tico","N√∫meros","Deuteron√¥mio","Josu√©","Ju√≠zes","Rute","1 Samuel","2 Samuel","1 Reis","2 Reis","1 Cr√¥nicas","2 Cr√¥nicas","Esdras","Neemias","Ester","J√≥","Salmos","Prov√©rbios","Eclesiastes","C√¢nticos","Isa√≠as","Jeremias","Lamenta√ß√µes","Ezequiel","Daniel","Oseias","Joel","Am√≥s","Obadias","Jonas","Miqueias","Naum","Habacuque","Sofonias","Ageu","Zacarias","Malaquias","Mateus","Marcos","Lucas","Jo√£o","Atos","Romanos","1 Cor√≠ntios","2 Cor√≠ntios","G√°latas","Ef√©sios","Filipenses","Colossenses","1 Tessalonicenses","2 Tessalonicenses","1 Tim√≥teo","2 Tim√≥teo","Tito","Filemom","Hebreus","Tiago","1 Pedro","2 Pedro","1 Jo√£o","2 Jo√£o","3 Jo√£o","Judas","Apocalipse"];
        const antigoTestamento = [{ nome: "G√™nesis", caps: 50 }, { nome: "√äxodo", caps: 40 }, { nome: "Lev√≠tico", caps: 27 }, { nome: "N√∫meros", caps: 36 }, { nome: "Deuteron√¥mio", caps: 34 }, { nome: "Josu√©", caps: 24 }, { nome: "Ju√≠zes", caps: 21 }, { nome: "Rute", caps: 4 }, { nome: "1 Samuel", caps: 31 }, { nome: "2 Samuel", caps: 24 }, { nome: "1 Reis", caps: 22 }, { nome: "2 Reis", caps: 25 }, { nome: "1 Cr√¥nicas", caps: 29 }, { nome: "2 Cr√¥nicas", caps: 36 }, { nome: "Esdras", caps: 10 }, { nome: "Neemias", caps: 13 }, { nome: "Ester", caps: 10 }, { nome: "J√≥", caps: 42 }, { nome: "Salmos", caps: 150 }, { nome: "Prov√©rbios", caps: 31 }, { nome: "Eclesiastes", caps: 12 }, { nome: "C√¢nticos", caps: 8 }, { nome: "Isa√≠as", caps: 66 }, { nome: "Jeremias", caps: 52 }, { nome: "Lamenta√ß√µes", caps: 5 }, { nome: "Ezequiel", caps: 48 }, { nome: "Daniel", caps: 12 }, { nome: "Oseias", caps: 14 }, { nome: "Joel", caps: 3 }, { nome: "Am√≥s", caps: 9 }, { nome: "Obadias", caps: 1 }, { nome: "Jonas", caps: 4 }, { nome: "Miqueias", caps: 7 }, { nome: "Naum", caps: 3 }, { nome: "Habacuque", caps: 3 }, { nome: "Sofonias", caps: 3 }, { nome: "Ageu", caps: 2 }, { nome: "Zacarias", caps: 14 }, { nome: "Malaquias", caps: 4 }];
        const novoTestamento = [{ nome: "Mateus", caps: 28 }, { nome: "Marcos", caps: 16 }, { nome: "Lucas", caps: 24 }, { nome: "Jo√£o", caps: 21 }, { nome: "Atos", caps: 28 }, { nome: "Romanos", caps: 16 }, { nome: "1 Cor√≠ntios", caps: 16 }, { nome: "2 Cor√≠ntios", caps: 13 }, { nome: "G√°latas", caps: 6 }, { nome: "Ef√©sios", caps: 6 }, { nome: "Filipenses", caps: 4 }, { nome: "Colossenses", caps: 4 }, { nome: "1 Tessalonicenses", caps: 5 }, { nome: "2 Tessalonicenses", caps: 3 }, { nome: "1 Tim√≥teo", caps: 6 }, { nome: "2 Tim√≥teo", caps: 4 }, { nome: "Tito", caps: 3 }, { nome: "Filemom", caps: 1 }, { nome: "Hebreus", caps: 13 }, { nome: "Tiago", caps: 5 }, { nome: "1 Pedro", caps: 5 }, { nome: "2 Pedro", caps: 3 }, { nome: "1 Jo√£o", caps: 5 }, { nome: "2 Jo√£o", caps: 1 }, { nome: "3 Jo√£o", caps: 1 }, { nome: "Judas", caps: 1 }, { nome: "Apocalipse", caps: 22 }];
        
        // Lista INTELIGENTE (Sigla para o sistema, Nome para o visual)
        const listaVersoesDisponiveis = [
            { sigla: "NVI",  nome: "NVI - Nova Vers√£o Internacional" },
            { sigla: "NVT",  nome: "NVT - Nova Vers√£o Transformadora" },
            { sigla: "ACF",  nome: "ACF - Almeida Corrigida Fiel" },
            { sigla: "ARA",  nome: "ARA - Almeida Revista e Atualizada" },
            { sigla: "ARC",  nome: "ARC - Almeida Revista e Corrigida" },
            { sigla: "JFA", nome: "JFA - Jo√£o Ferreira de Almeida" },
            { sigla: "TB",   nome: "TB - Tradu√ß√£o Brasileira" },
            { sigla: "KJA",  nome: "KJA - King James Atualizada" },
            { sigla: "NAA",  nome: "NAA - Nova Almeida Atualizada" },
            { sigla: "NBV",  nome: "NBV - Nova B√≠blia Viva" },
            { sigla: "NTLH", nome: "NTLH - Nova Tradu√ß√£o Linguagem de Hoje" },
            { sigla: "AS21", nome: "A21 - Almeida S√©culo 21" },
            { sigla: "KJF",  nome: "KJF - King James Fiel" }
        ];
        
        // --- VARI√ÅVEIS DE DADOS DO USU√ÅRIO (Restaure isso!) ---
        let dadosUsuario = JSON.parse(localStorage.getItem('biblia_dados_v1')) || { 
            progresso: {},
            favoritos: [],
            anotacoes: {} 
        };

        if (!dadosUsuario.grifos) dadosUsuario.grifos = {};
        if (!dadosUsuario.notas) dadosUsuario.notas = {};
        if (!dadosUsuario.progresso) dadosUsuario.progresso = {};
        
        // --- VARI√ÅVEIS DE ESTADO ---
        let modoAtual = 'biblia';
        let bibliaCompleta = null;
        let versaoCarregadaNome = "";
        
        // CACHES EM MEM√ìRIA RAM (Para velocidade instant√¢nea)
        const cacheVersoes = {}; 
        const cacheHinarios = {}; 
        
        let livroAtualIndex = 0; 
        let livroAtualNome = "";
        let livroAtualMaxCaps = 0;
        let capituloAtual = 1;
        
        let dadosHinario = [];
        let hinoAtual = 1;
        
        // ELEMENTOS DOM
        const corpoApp = document.getElementById('corpo-app');
        const loading = document.getElementById('loading');
        const areaVersao = document.getElementById('area-versao');
        const rodape = document.getElementById('rodape-nav');
        const abasPrincipais = document.getElementById('abas-principais');
        const selectVersao = document.getElementById('select-versao');
        const tituloApp = document.getElementById('titulo-app');
        const areaPrincipal = document.getElementById('area-principal');
        
        const tabBiblia = document.getElementById('tab-biblia');
        const tabBusca = document.getElementById('tab-busca');
        const tabHinarios = document.getElementById('tab-hinarios');
        // Adicione junto das outras declara√ß√µes l√° no topo:
        const tabDados = document.getElementById('tela-meus-dados');
        
        const telaLivros = document.getElementById('tela-livros');
        const telaCapitulos = document.getElementById('tela-capitulos');
        const telaLeitura = document.getElementById('tela-leitura');
        const textoBiblico = document.getElementById('texto-biblico');
        
        const telaEscolhaHinario = document.getElementById('tela-escolha-hinario');
        const telaListaHinos = document.getElementById('tela-lista-hinos');
        const telaLeituraHino = document.getElementById('tela-leitura-hino');
        const btnVersao = document.getElementById('btn-versao-selecionada');
        const menuVersoes = document.getElementById('lista-versoes-custom');
        
        function limparBusca() {
            document.getElementById('input-busca').value = ""; 
            document.getElementById('resultados-busca').innerHTML = ""; 
            document.getElementById('input-busca').focus(); 
        }
        
        function gerarMenuVersoes(versaoAtual) {
            menuVersoes.innerHTML = ''; // Limpa lista antiga
            
            listaVersoesDisponiveis.forEach(itemInfo => {
                const item = document.createElement('div');
                item.className = 'item-versao';
                
                // AQUI √â A M√ÅGICA: Mostra o nome comprido na lista
                item.innerText = itemInfo.nome; 
                
                // Compara usando a sigla (ex: "NVI")
                if(itemInfo.sigla === versaoAtual) item.classList.add('selecionado');
    
                // Ao clicar, envia apenas a sigla para carregar o arquivo certo
                item.onclick = () => {
                    mudarVersaoCustom(itemInfo.sigla);
                };
    
                menuVersoes.appendChild(item);
            });
        }
        
        function alternarMenuVersoes() {
            menuVersoes.classList.toggle('escondido');
        }
        
        // Fecha o menu se clicar fora dele
        window.onclick = function(event) {
            if (!event.target.matches('#btn-versao-selecionada')) {
                if (!menuVersoes.classList.contains('escondido')) {
                    menuVersoes.classList.add('escondido');
                }
            }
        } 
        
        async function mudarVersaoCustom(novaVersao) {
            // 1. C√ÅLCULO DA PORCENTAGEM: Grava quanto % da tela voc√™ j√° desceu
            // Ex: Se leu metade, grava 0.5 (50%)
            const totalAntigo = areaPrincipal.scrollHeight - areaPrincipal.clientHeight;
            const posicaoAntiga = areaPrincipal.scrollTop;
            
            let porcentagemLida = 0;
            if (totalAntigo > 0) {
                porcentagemLida = posicaoAntiga / totalAntigo;
            }
    
            const scrollJanela = window.scrollY; // Backup para garantir
    
            // --- L√≥gica Padr√£o de Troca ---
            btnVersao.innerText = novaVersao; 
            localStorage.setItem('versaoBiblia', novaVersao);
            menuVersoes.classList.add('escondido');
            
            await carregarVersaoBiblia(novaVersao);
            
            if (modoAtual === 'biblia' && !telaLeitura.classList.contains('escondido')) {
                lerCapitulo(capituloAtual);
                
                // 2. RESTAURA√á√ÉO PROPORCIONAL
                // Aplica a mesma porcentagem ao tamanho do NOVO texto
                setTimeout(() => {
                    const novoTotal = areaPrincipal.scrollHeight - areaPrincipal.clientHeight;
                    const novaPosicao = porcentagemLida * novoTotal;
                    
                    areaPrincipal.scrollTop = novaPosicao;
                    window.scrollTo(0, scrollJanela);
                }, 50); // Aumentei para 50ms para dar tempo do texto renderizar
            }
            
            gerarMenuVersoes(novaVersao);
        }

        // Fun√ß√£o que corrige a altura em celulares
        function forcarAlturaReal() {
            // Pega a altura exata da janela vis√≠vel
            const alturaReal = window.innerHeight;
            // For√ßa o corpo do app a ter exatamente essa altura
            document.body.style.height = `${alturaReal}px`;
            
            // Refor√ßa a cor do fundo (para garantir que n√£o falhou)
            const corAtual = document.body.classList.contains('modo-escuro') ? "#1f1f1f" : "#fdfbf7";
            document.documentElement.style.backgroundColor = corAtual;
        }

        // Adiciona um "ouvinte" para corrigir sempre que a tela girar ou mudar
        window.addEventListener('resize', forcarAlturaReal);
           
        // --- INICIALIZA√á√ÉO ---
        function iniciarApp() {
            // 1. CORRE√á√ÉO DE TELA (O Segredo!)
            // Executa imediatamente para tirar a listra branca
            forcarAlturaReal();
            
            // Executa novamente ap√≥s meio segundo para garantir (caso a barra do navegador se mova)
            setTimeout(forcarAlturaReal, 500);

            // 2. TEMA: Carrega as cores e o fundo correto
            carregarTemaSalvo(); 
            
            // 3. INTERFACE: Renderiza os livros
            renderizarLivros();
            
            // 4. VERS√ÉO: Recupera qual b√≠blia o usu√°rio estava lendo
            const versaoSalva = localStorage.getItem('versaoBiblia') || "NVI";
            
            btnVersao.innerText = versaoSalva;
            gerarMenuVersoes(versaoSalva);
            
            // 5. CARREGAMENTO: Busca o texto da B√≠blia
            carregarVersaoBiblia(versaoSalva).then(() => {
                // Inicia o download silencioso do resto ap√≥s 2 segundos
                setTimeout(preCarregarTudoSilenciosamente, 2000);
            });
        }
        
        // --- PR√â-CARREGAMENTO UNIVERSAL (B√≠blias e Hin√°rios) ---
        // --- PR√â-CARREGAMENTO UNIVERSAL (CORRIGIDO) ---
        async function preCarregarTudoSilenciosamente() {
            console.log("Iniciando pr√©-carregamento total...");
        
            // A. Baixar Hin√°rios
            const hinarios = ["harpa", "cantor"];
            for (const h of hinarios) {
                if (!cacheHinarios[h]) {
                    try {
                        const r = await fetch(`./${h}.json`);
                        if(r.ok) {
                            const json = await r.json();
                            processarJsonHinario(json, h);
                        }
                    } catch(e) { console.warn("Falha pre-load hinario: " + h); }
                }
            }
        
            // B. Baixar Outras Vers√µes da B√≠blia (CORRE√á√ÉO AQUI)
            // Agora percorremos a lista de objetos e usamos 'versao.sigla'
            for (const item of listaVersoesDisponiveis) {
                const sigla = item.sigla; // Pegamos s√≥ a sigla (ex: "NVI")
                
                if (!cacheVersoes[sigla]) {
                    try {
                        const resp = await fetch(`./${sigla}.json`);
                        if (resp.ok) {
                            cacheVersoes[sigla] = await resp.json();
                            // console.log(`Vers√£o ${sigla} pr√©-carregada!`);
                        }
                    } catch (e) { console.warn(`Falha pre-load ${sigla}`); }
                }
            }
        }
        
        // Auxiliar para preparar o JSON do hin√°rio assim que baixar
        function processarJsonHinario(json, tipo) {
            let listaFinal = [];
            if (Array.isArray(json)) {
                listaFinal = json.map(h => ({
                    numero: h.numero || h.number || h.id, 
                    titulo: h.titulo || h.title,
                    letra: h.letra || h.text || h.verses || h.lyrics
                }));
            } else {
                listaFinal = Object.values(json)
                    .filter(obj => obj.hino)
                    .map(obj => {
                        let partes = obj.hino.split(" - ");
                        let num = partes[0].trim();
                        let tit = partes.length > 1 ? partes.slice(1).join(" - ").trim() : "Sem t√≠tulo";
                        let letraArr = (obj.verses && typeof obj.verses === 'object') ? Object.values(obj.verses) : obj.verses;
                        return { numero: num, titulo: tit, letra: letraArr };
                    });
                listaFinal.sort((a, b) => parseInt(a.numero) - parseInt(b.numero));
            }
            // Salva no Cache de Hin√°rios com uma propriedade extra "tipo"
            listaFinal.tipo = tipo;
            cacheHinarios[tipo] = listaFinal;
        }
        
        function atualizarMetaColor(escuro) {
            // --- DEFINI√á√ÉO DAS CORES ---
            // Aqui definimos as cores para Modo Escuro e Claro
            
            // Cor do Fundo (e da Listra de baixo)
            const corFundo = escuro ? "#1f1f1f" : "#fdfbf7"; 
            
            // Cor da Barra de Status (L√° no topo, onde fica a bateria)
            // DICA: Se a listra aparecer no topo, mude esta cor para igual a 'corFundo' tamb√©m!
            const corBarraTopo = escuro ? "#1f1f1f" : "#2c3e50"; 
    
            // 1. Pinta a Barra de Notifica√ß√µes (Android/Chrome)
            const metaThemeColor = document.querySelector("meta[name='theme-color']");
            if (metaThemeColor) {
                metaThemeColor.setAttribute("content", corBarraTopo);
            }
    
            // 2. A M√ÅGICA DA CAMUFLAGEM:
            // Pinta o elemento <html> (que √© a listra de fundo)
            document.documentElement.style.backgroundColor = corFundo;
            
            // Pinta o corpo do site
            document.body.style.backgroundColor = corFundo;
        }
        
        function alternarTema() {
            document.body.classList.toggle('modo-escuro');
            const escuroAtivo = document.body.classList.contains('modo-escuro');
            localStorage.setItem('temaEscuro', escuroAtivo);
            atualizarMetaColor(escuroAtivo);
        }
        
        function carregarTemaSalvo() {
            const escuroSalvo = localStorage.getItem('temaEscuro') === 'true';
            if (escuroSalvo) {
                document.body.classList.add('modo-escuro');
            }
            atualizarMetaColor(escuroSalvo);
        }

        /* --- FUN√á√ÉO AUXILIAR PARA MOSTRAR ALERTA BONITO --- */
        function mostrarAlerta(mensagem, titulo = "Aviso") {
            const modal = document.getElementById('modal-alerta');
            const tituloEl = document.getElementById('titulo-alerta');
            const msgEl = document.getElementById('texto-alerta');
            
            if (modal && msgEl) {
                if(tituloEl) tituloEl.innerText = titulo; // Opcional: mudar t√≠tulo
                msgEl.innerText = mensagem;
                
                modal.classList.remove('escondido');
                modal.style.display = 'flex';
            } else {
                alert(mensagem); // Seguran√ßa
            }
        }
        
        function fecharAlerta() {
            const modal = document.getElementById('modal-alerta');
            if (modal) {
                modal.classList.add('escondido');
                modal.style.display = 'none';
            }
        }
        
        // --- CARREGAMENTO DE B√çBLIA ---
        async function carregarVersaoBiblia(versao) {
            // 1. Verifica cache
            if (cacheVersoes[versao]) {
                bibliaCompleta = cacheVersoes[versao];
                
                // --- A CORRE√á√ÉO MAGICA ---
                window.bibliaCompleta = bibliaCompleta; 
                window.biblia = bibliaCompleta; 
                // -------------------------
        
                versaoCarregadaNome = versao;
                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }
                return;
            }
        
            // 2. Carrega do arquivo
            loading.style.display = 'block';
            try {
                const resp = await fetch(`./${versao}.json`);
                if(!resp.ok) throw new Error("Erro");
                
                const dados = await resp.json();
                
                cacheVersoes[versao] = dados;
                bibliaCompleta = dados;
        
                // --- A CORRE√á√ÉO MAGICA ---
                window.bibliaCompleta = dados; // Grava na Janela Global
                window.biblia = dados;         // Grava no backup
                // -------------------------
                
                versaoCarregadaNome = versao;
                
                if (!telaLeitura.classList.contains('escondido') && modoAtual === 'biblia') {
                    lerCapitulo(capituloAtual);
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao carregar vers√£o.");
            } finally {
                loading.style.display = 'none';
            }
        }
        
        /* --- SISTEMA DE PROGRESSO --- */

        function salvarDados() {
            localStorage.setItem('biblia_dados_v1', JSON.stringify(dadosUsuario));
        }
        
        // Chamada quando clica no bot√£o "Marcar como Lido" no fim do cap√≠tulo
        function alternarStatusCapitulo(livro, capitulo) {
            if (!dadosUsuario.progresso[livro]) dadosUsuario.progresso[livro] = [];
            
            const lista = dadosUsuario.progresso[livro];
            const index = lista.indexOf(capitulo);
            
            // Elemento do bot√£o
            const btn = document.getElementById('btn-leitura-final');
            
            if (index === -1) {
                // Marca
                lista.push(capitulo);
                if (btn) {
                    btn.className = "btn-marcar-lido lido";
                    btn.innerText = "‚úÖ Leitura Conclu√≠da (Desmarcar)";
                }
                // Feedback visual simples
                // alert("Cap√≠tulo salvo!"); 
            } else {
                // Desmarca
                lista.splice(index, 1);
                if (btn) {
                    btn.className = "btn-marcar-lido nao-lido";
                    btn.innerText = "Marcar Leitura como Conclu√≠da";
                }
            }
            
            salvarDados();
        }
        
        function esconderTodasSubTelas() {
            document.getElementById('view-progressao').classList.add('escondido');
            document.getElementById('view-favoritos').classList.add('escondido');
            document.getElementById('view-comentarios').classList.add('escondido');
        }
        function abrirTelaProgressao() {
            // --- 1. NAVEGA√á√ÉO MANUAL ---
            document.getElementById('menu-perfil-principal').style.display = 'none';
            
            // Esconde as outras telas irm√£s
            document.getElementById('view-comentarios').style.display = 'none';
            document.getElementById('view-favoritos').style.display = 'none';
        
            // Mostra a tela de progress√£o
            const view = document.getElementById('view-progressao');
            view.style.display = 'block';
            view.classList.remove('escondido');
            
            // --- 2. RENDERIZA√á√ÉO ---
            // Verifica se a fun√ß√£o existe antes de chamar para n√£o travar
            if (typeof renderizarProgressoCompleto === 'function') {
                renderizarProgressoCompleto();
            } else {
                console.log("A fun√ß√£o renderizarProgressoCompleto ainda n√£o foi criada.");
            }
        }
        
        function voltarMenuPerfil() {
            // 1. Esconde TODAS as sub-telas manualmente para n√£o ter erro
            const subTelas = ['view-comentarios', 'view-favoritos', 'view-progressao'];
            
            subTelas.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.style.display = 'none';
                    el.classList.add('escondido'); // Garante via classe tamb√©m
                }
            });
        
            // 2. Mostra o Menu Principal
            const menu = document.getElementById('menu-perfil-principal');
            if(menu) {
                menu.style.display = 'block';
                menu.classList.remove('escondido');
            }
        }

        /* --- NAVEGA√á√ÉO ENTRE TELAS --- */
        function irParaVersiculo(livroNome, capNumero, versoNumero) {
            // 1. Acha o √≠ndice do livro no array da b√≠blia
            const index = bibliaCompleta.findIndex(b => b.name === livroNome);
            if (index === -1) return;
        
            // 2. Atualiza as vari√°veis globais
            livroAtualIndex = index;
            livroAtualNome = livroNome;
            
            // 3. Renderiza o cap√≠tulo
            lerCapitulo(parseInt(capNumero)); // Converte para n√∫mero por garantia
        
            // 4. Rola at√© o vers√≠culo (com um pequeno delay para dar tempo de desenhar a tela)
            setTimeout(() => {
                const elementoVerso = document.getElementById(`verso-${versoNumero}`);
                if (elementoVerso) {
                    elementoVerso.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Efeito visual: piscar o vers√≠culo para destacar
                    elementoVerso.style.transition = "background 0.5s";
                    const corOriginal = elementoVerso.style.backgroundColor;
                    elementoVerso.style.backgroundColor = "rgba(255, 215, 0, 0.3)"; // Amarelo suave
                    setTimeout(() => {
                        elementoVerso.style.backgroundColor = corOriginal;
                    }, 1500);
                }
            }, 300); // 300ms de espera
        }
        
        // 2. Renderiza√ß√£o das Barras (Garante que mostra TODOS os livros)
        function renderizarProgressoCompleto() {
            const container = document.getElementById('lista-progresso-livros');
            container.innerHTML = '';
            
            let totalCapsBibia = 0;
            let totalLidosGeral = 0;
        
            // Concatena as listas que j√° existem no seu c√≥digo para garantir a ordem certa
            // (G√™nesis...Malaquias -> Mateus...Apocalipse)
            const todosLivros = [...antigoTestamento, ...novoTestamento];
        
            todosLivros.forEach(livroObj => {
                const nomeLivro = livroObj.nome;
                const totalCaps = livroObj.caps;
                
                // Verifica o progresso (se n√£o tiver nada, assume array vazio [])
                const lidosArray = dadosUsuario.progresso[nomeLivro] || [];
                const qtdLidos = lidosArray.length;
                
                // Calcula porcentagem (Evita divis√£o por zero se houver erro nos dados)
                const pct = totalCaps > 0 ? Math.round((qtdLidos / totalCaps) * 100) : 0;
        
                // Soma para o cabe√ßalho geral
                totalCapsBibia += totalCaps;
                totalLidosGeral += qtdLidos;
        
                // Cor da barra: Verde Escuro se completou (100%), Verde Neon se est√° lendo
                const corBarra = pct === 100 ? '#27ae60' : '#39ff14'; 
        
                const html = `
                    <div class="item-progresso">
                        <div class="cabecalho-progresso">
                            <span>${nomeLivro}</span>
                            <span>${pct}% <small style="color:#95a5a6">(${qtdLidos}/${totalCaps})</small></span>
                        </div>
                        <div class="barra-trilho">
                            <div class="barra-preenchida" style="width: ${pct}%; background-color: ${corBarra}"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        
            // Atualiza os n√∫meros grandes l√° no topo (Resumo Geral)
            const pctGeral = totalCapsBibia > 0 ? Math.round((totalLidosGeral / totalCapsBibia) * 100) : 0;
            document.getElementById('total-lido-pct').innerText = pctGeral + "%";
            document.getElementById('total-caps-lidos').innerText = totalLidosGeral;
        }

        let timerClique = null; // Controla o tempo entre cliques
        
        // Essa fun√ß√£o decide se foi 1 clique ou 2 cliques
        function gerenciarCliqueVerso(livro, cap, num, textoCodificado) {
            if (timerClique) {
                // --- DUPLO CLIQUE DETECTADO ---
                clearTimeout(timerClique);
                timerClique = null;
                
                // Abre o menu de op√ß√µes (sua fun√ß√£o antiga atualizada)
                abrirMenuVersiculo(livro, cap, num, textoCodificado);
                
            } else {
                // --- PRIMEIRO CLIQUE (ESPERANDO O SEGUNDO...) ---
                timerClique = setTimeout(() => {
                    // Se passar 300ms e ningu√©m clicar de novo, √© clique simples
                    alternarModoImersivo(); 
                    timerClique = null;
                }, 300); // 300 milissegundos de espera
            }
        }

        function alternarModoImersivo() {
            const topo = document.querySelector('.barra-topo');
            const nav = document.querySelector('.barra-navegacao');
            
            // Verifica se j√° est√° escondido
            const estaImersivo = topo.classList.contains('escondido-topo'); // Vamos criar essa classe no CSS
            
            if (estaImersivo) {
                // MOSTRAR TUDO
                topo.classList.remove('escondido-topo');
                nav.classList.remove('escondido-nav');
            } else {
                // ESCONDER TUDO
                topo.classList.add('escondido-topo');
                nav.classList.add('escondido-nav');
            }
        }

        // Vari√°vel para guardar a fun√ß√£o que deve ser executada se o usu√°rio disser "Sim"
        let acaoPendente = null;
        
        // 1. Fun√ß√£o que CHAMA o modal (Substitui o "if confirm")
        function mostrarConfirmacao(texto, funcaoCallback) {
            const modal = document.getElementById('modal-confirmacao');
            const textoElemento = document.getElementById('texto-confirmacao');
            
            // Define o texto da pergunta
            textoElemento.innerText = texto;
            
            // Guarda a a√ß√£o para usar depois
            acaoPendente = funcaoCallback;
            
            // Mostra o modal
            modal.classList.remove('escondido');
        }
        
        // 2. Fun√ß√£o que FECHA o modal (Bot√£o Cancelar)
        function fecharModalConfirmacao() {
            const modal = document.getElementById('modal-confirmacao');
            modal.classList.add('escondido');
            acaoPendente = null; // Limpa a a√ß√£o
        }
        
        // 3. Fun√ß√£o que EXECUTA a a√ß√£o (Bot√£o Confirmar)
        function executarAcaoConfirmada() {
            if (acaoPendente) {
                acaoPendente(); // Executa a fun√ß√£o que estava guardada
            }
            fecharModalConfirmacao();
        }
        
        // 3. Fun√ß√£o de Resetar (Atualizada para o novo sistema)
        function resetarProgresso() {
            // Usamos a nossa fun√ß√£o personalizada em vez do confirm()
            mostrarConfirmacao(
                "Tem certeza que deseja apagar todo o seu hist√≥rico de leitura? Essa a√ß√£o n√£o pode ser desfeita.", 
                function() {
                    // O c√≥digo que roda APENAS se o usu√°rio clicar em "Confirmar"
                    dadosUsuario.progresso = {};   // Zera o objeto
                    salvarDados();                 // Salva no celular
                    renderizarProgressoCompleto(); // Atualiza a tela na hora
                    
                    // Opcional: Feedback visual extra para confirmar que foi feito
                    // alert("Hist√≥rico de leitura apagado com sucesso!");
                }
            );
        }
        
        function mudarVersao() {
            const novaVersao = selectVersao.value;
            localStorage.setItem('versaoBiblia', novaVersao);
            carregarVersaoBiblia(novaVersao);
        }
        
        // --- INTERFACE ---
        function alternarBarras(modo) {
            corpoApp.classList.remove('imersivo');
            if (modo === 'leitura') {
                corpoApp.classList.add('modo-leitura');
                abasPrincipais.classList.add('escondido');
                rodape.classList.remove('escondido');
                if(modoAtual === 'biblia') areaVersao.classList.remove('escondido');
                else areaVersao.classList.add('escondido');
            } else { 
                corpoApp.classList.remove('modo-leitura');
                abasPrincipais.classList.remove('escondido');
                rodape.classList.add('escondido');
                areaVersao.classList.add('escondido');
            }
        }
        
        function alternarImersao() {
            if (corpoApp.classList.contains('modo-leitura')) {
                corpoApp.classList.toggle('imersivo');
            }
        }
        
        function mudarAba(aba) {
            modoAtual = aba;
            
            // Atualiza os bot√µes do menu
            document.querySelectorAll('.aba').forEach(btn => btn.classList.remove('ativa'));
            const btnAlvo = document.getElementById(`btn-aba-${aba}`);
            if (btnAlvo) btnAlvo.classList.add('ativa');
            
            // Esconde TODAS as telas (incluindo a nova tabDados)
            tabBiblia.classList.add('escondido');
            tabBusca.classList.add('escondido');
            tabHinarios.classList.add('escondido');
            if(tabDados) tabDados.classList.add('escondido'); 
            
            const titulo = document.getElementById('titulo-app');
            alternarBarras('navegacao');
        
            // L√≥gica de qual mostrar
            if (aba === 'biblia') {
                tabBiblia.classList.remove('escondido');
                titulo.innerText = "B√≠blia Sagrada";
                // Se estava lendo, restaura a barra de leitura
                if (!telaLeitura.classList.contains('escondido')) alternarBarras('leitura');
        
            } else if (aba === 'busca') {
                tabBusca.classList.remove('escondido');
                titulo.innerText = "Busca Inteligente";
                setTimeout(() => document.getElementById('input-busca').focus(), 50);
        
            } else if (aba === 'hinarios') { 
                // ATEN√á√ÉO: Mudei de 'else' para 'else if' aqui
                tabHinarios.classList.remove('escondido');
                titulo.innerText = "Hin√°rios";
                if (!telaLeituraHino.classList.contains('escondido')) alternarBarras('leitura');
        
            } else if (aba === 'dados') {
                if(tabDados) tabDados.classList.remove('escondido');
                titulo.innerText = "Meu Perfil";
                // Garante que come√ßa no menu, n√£o na progress√£o antiga
                voltarMenuPerfil(); 
            }
            
        }
        
        // --- RENDERIZA√á√ÉO B√çBLIA ---
        function renderizarLivros() {
            telaLivros.innerHTML = "";
            telaCapitulos.classList.add('escondido');
            telaLeitura.classList.add('escondido');
            telaLivros.classList.remove('escondido');
            alternarBarras('navegacao'); 
            tituloApp.innerText = "B√≠blia Sagrada";
        
            function criarSecao(titulo, lista, offsetIndex) {
                const divTitulo = document.createElement('div');
                divTitulo.className = 'separador-testamento';
                divTitulo.innerText = titulo;
                telaLivros.appendChild(divTitulo);
                const grid = document.createElement('div');
                grid.className = 'grade-livros';
                lista.forEach((livro, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-livro';
                    btn.innerText = livro.nome;
                    const indiceGlobal = offsetIndex + index;
                    btn.onclick = () => abrirCapitulos(indiceGlobal, livro.nome, livro.caps);
                    grid.appendChild(btn);
                });
                telaLivros.appendChild(grid);
            }
            criarSecao("Antigo Testamento", antigoTestamento, 0);
            criarSecao("Novo Testamento", novoTestamento, 39);
        }
        
        function abrirCapitulos(indexGlobal, nome, totalCaps) {
            // 1. Configura as vari√°veis globais
            livroAtualIndex = indexGlobal;
            livroAtualNome = nome;
            livroAtualMaxCaps = totalCaps;
            tituloApp.innerText = nome;
            
            // 2. Troca as telas
            telaLivros.classList.add('escondido');
            telaCapitulos.classList.remove('escondido');
            telaCapitulos.innerHTML = "";
            
            // 3. Bot√£o de Voltar
            const btnVoltar = document.createElement('button');
            btnVoltar.className = 'btn-voltar-topo';
            btnVoltar.innerHTML = "&#11013; Escolher outro livro"; 
            btnVoltar.onclick = () => { renderizarLivros(); };
            telaCapitulos.appendChild(btnVoltar);
        
            // --- AQUI EST√Å A MUDAN√áA (RECUPERA OS DADOS) ---
            // Pega a lista de cap√≠tulos lidos deste livro (ex: [1, 5, 10])
            // Se n√£o tiver nada, retorna array vazio []
            const lidos = dadosUsuario.progresso[nome] || [];

            // 4. Cria os bot√µes num√©ricos
            for (let i = 1; i <= totalCaps; i++) {
                const btn = document.createElement('button');
                
                // Verifica se 'i' (o n√∫mero do cap√≠tulo) est√° na lista de lidos
                if (lidos.includes(i)) {
                    // SE LEU: Classe especial + Check
                    btn.className = 'btn-capitulo lido';
                    btn.innerHTML = `${i} <span class="check-lido">‚úì</span>`;
                } else {
                    // SE N√ÉO LEU: Bot√£o normal
                    btn.className = 'btn-capitulo';
                    btn.innerText = i;
                }

                btn.onclick = () => lerCapitulo(i);
                telaCapitulos.appendChild(btn);
            }
            
            // Rola para o topo para garantir
            window.scrollTo(0, 0);
        }
        
        function lerCapitulo(numero) {
            if (!bibliaCompleta) return;
            capituloAtual = numero;
            
            try {
                if (!bibliaCompleta[livroAtualIndex] || !bibliaCompleta[livroAtualIndex].chapters) return;
                
                const capituloTextoArray = bibliaCompleta[livroAtualIndex].chapters[capituloAtual - 1];
                let html = "";
                
                capituloTextoArray.forEach((versiculo, idx) => {
                    const numVerso = idx + 1;
                    
                    // Dados para o sistema
                    const chave = `${livroAtualNome}_${capituloAtual}_${numVerso}`;
                    const dadosGrifo = dadosUsuario.grifos[chave]; 
                    const classeCor = dadosGrifo ? `grifo-${dadosGrifo.cor}` : "";
                    const temNota = dadosUsuario.notas[chave] ? "üìù" : "";
                    const textoSafe = encodeURIComponent(versiculo);
                    
                    /* --- NOVA L√ìGICA DE INTERA√á√ÉO ---
                       1. A DIV inteira (o texto) tem onclick="alternarModoImersivo()"
                       2. O SPAN do n√∫mero tem onclick="abrirMenu...; event.stopPropagation()"
                       
                       O stopPropagation impede que o clique no n√∫mero ative o modo imersivo.
                    */
                    
                    html += `
                        <div id="verso-${numVerso}" class="verso-clicavel ${classeCor}" 
                             onclick="alternarModoImersivo()">
                             
                            <span class="versiculo-num" 
                                  onclick="event.stopPropagation(); abrirMenuVersiculo('${livroAtualNome}', ${capituloAtual}, ${numVerso}, '${textoSafe}')">
                                ${numVerso}
                            </span> 
                            
                            ${versiculo} 
                            <span class="icone-nota">${temNota}</span>
                        </div>
                        <br>
                    `;
                });
                
                document.getElementById('titulo-capitulo-leitura').innerText = `${livroAtualNome} ${capituloAtual}`;
                textoBiblico.innerHTML = html;
        
                // BOT√ÉO FINAL
                const lidos = dadosUsuario.progresso[livroAtualNome] || [];
                const jaLeu = lidos.includes(capituloAtual);
                const btnHTML = `
                    <button id="btn-leitura-final" 
                            class="btn-marcar-lido ${jaLeu ? 'lido' : 'nao-lido'}" 
                            onclick="alternarStatusCapitulo('${livroAtualNome}', ${capituloAtual})">
                        ${jaLeu ? '‚úÖ Leitura Conclu√≠da (Desmarcar)' : 'Marcar Leitura como Conclu√≠da'}
                    </button>
                `;
                textoBiblico.innerHTML += btnHTML;
                
                telaCapitulos.classList.add('escondido');
                telaLeitura.classList.remove('escondido');
                alternarBarras('leitura');
                
                window.scrollTo(0,0);
                
            } catch (erro) { console.error(erro); }
        }
        
        // --- BUSCA ---
        function normalizar(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,;?!]/g,"");
        }
        
        function ativarMicrofone() {
            const btn = document.getElementById('btn-mic');
            const input = document.getElementById('input-busca');
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return alert("Microfone n√£o suportado.");
        
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            
            rec.onstart = () => { btn.classList.add('ouvindo'); input.placeholder = "Ouvindo..."; };
            rec.onend = () => { btn.classList.remove('ouvindo'); input.placeholder = "Digite ou fale..."; };
            rec.onresult = (e) => {
                input.value = e.results[0][0].transcript;
                realizarBusca();
            };
            rec.start();
        }
        
        function realizarBusca() {
            const termo = document.getElementById('input-busca').value.trim();
            if (termo.length < 3) {
                mostrarAlerta("Digite pelo menos 3 letras.");
                return;
            }
            if (!bibliaCompleta) return alert("Aguarde o carregamento.");
        
            document.getElementById('input-busca').blur();
            const container = document.getElementById('resultados-busca');
            container.innerHTML = '<div style="text-align:center; padding:20px;">Pesquisando...</div>';
        
            setTimeout(() => {
                const termoNorm = normalizar(termo);
                const palavras = termoNorm.split(" ").filter(p => p.length > 2);
                let resultados = [];
        
                bibliaCompleta.forEach((livroObj, idxLivro) => {
                    if (!livroObj.chapters) return;
                    livroObj.chapters.forEach((cap, idxCap) => {
                        cap.forEach((versiculo, idxVer) => {
                            const vNorm = normalizar(versiculo);
                            let pts = 0;
                            if (vNorm.includes(termoNorm)) pts += 100;
                            else {
                                palavras.forEach(p => { if (vNorm.includes(p)) pts += 10; });
                            }
                            if (pts > 0) {
                                const nomeReal = listaLivros[idxLivro] || livroObj.nome; 
                                resultados.push({ livro: nomeReal, cap: idxCap + 1, ver: idxVer + 1, texto: versiculo, pontos: pts, idxLivro: idxLivro });
                            }
                        });
                    });
                });
        
                resultados.sort((a, b) => b.pontos - a.pontos);
                const top = resultados.slice(0, 50);
                
                container.innerHTML = "";
                if (top.length === 0) container.innerHTML = "<p style='text-align:center'>Nenhum resultado.</p>";
                
                top.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'resultado-item';
                    div.innerHTML = `
                        <span class="res-ref">${res.livro} ${res.cap}:${res.ver}</span>
                        <div class="res-texto">${res.texto}</div>
                        <button class="btn-comparar" onclick="compararVersoes(${res.idxLivro}, ${res.cap}, ${res.ver}, '${res.livro}')">Ver em outras vers√µes</button>
                    `;
                    div.onclick = (e) => {
                        if(e.target.className !== 'btn-comparar') {
                            livroAtualIndex = res.idxLivro;
                            livroAtualNome = res.livro;
                            livroAtualMaxCaps = (bibliaCompleta[res.idxLivro].chapters || []).length || 50;
                            lerCapitulo(res.cap);
                            mudarAba('biblia');
                        }
                    };
                    container.appendChild(div);
                });
            }, 100);
        }
        
        // --- FUN√á√ÉO DE COMPARA√á√ÉO (ATUALIZADA COM BOT√ÉO DE TEMA) ---
        async function compararVersoes(idxLivro, cap, ver, nome) {
            // 1. Fecha menus e remove telas antigas
            if (typeof fecharModalVersiculo === 'function') fecharModalVersiculo();
            const telaAntiga = document.getElementById('overlay-comparacao');
            if (telaAntiga) telaAntiga.remove();
        
            // 2. Cria o Overlay (A tela cheia)
            const overlay = document.createElement('div');
            overlay.id = 'overlay-comparacao';
        
            // Configura√ß√£o visual base
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.zIndex = '9999';
            overlay.style.backgroundColor = document.body.classList.contains('modo-escuro') ? '#121212' : '#fdfbf7';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
        
            // 3. DEFINE A ALTURA DA BARRA DE SEGURAN√áA (SPACER)
            // Se for telem√≥vel (<= 768px), cria um espa√ßo. Se for PC, √© 0.
            let alturaSpacer = '0px';
            if (window.innerWidth <= 768) {
                // Usa a vari√°vel de ambiente segura (notch) ou 35px fixos como garantia
                alturaSpacer = 'max(env(safe-area-inset-top), 35px)';
            }
        
            // 4. MONTA O CONTE√öDO
            // Inserimos a div 'spacer-topo' antes do cabe√ßalho.
            overlay.innerHTML = `
                <div id="spacer-topo" style="width: 100%; height: ${alturaSpacer}; flex-shrink: 0; background: inherit;"></div>
        
                <div class="cabecalho-subtela" style="
                    flex-shrink: 0; 
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 10px 20px; 
                    border-bottom: 1px solid #3333;
                    height: 60px; /* Altura fixa para garantir alinhamento */
                ">
                    
                    <button class="btn-voltar-perfil" id="btn-fechar-comp">‚Üê Voltar</button>
                    
                    <h3 style="margin:0; font-size: 1.1rem; text-align:center;">${nome} ${cap}:${ver}</h3>
                    
                    <button onclick="alternarTema(); atualizarCorOverlay()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:5px;">
                        üåó
                    </button>
                </div>
        
                <div id="lista-comparacao-cheia" class="tela-cheia-container" style="flex-grow: 1; overflow-y: auto;">
                    <div style="padding: 20px; text-align:center; opacity: 0.7;">Carregando tradu√ß√µes...</div>
                </div>
            `;
        
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        
            // 5. Configura bot√£o fechar
            document.getElementById('btn-fechar-comp').onclick = function() {
                overlay.remove();
                document.body.style.overflow = ''; 
            };
        
            // Fun√ß√£o auxiliar de tema
            window.atualizarCorOverlay = function() {
                const overlayAtivo = document.getElementById('overlay-comparacao');
                if(overlayAtivo) {
                    overlayAtivo.style.backgroundColor = document.body.classList.contains('modo-escuro') ? '#121212' : '#fdfbf7';
                }
            };
        
            // 6. Carrega os textos (Mesma l√≥gica)
            const listaContainer = document.getElementById('lista-comparacao-cheia');
            const versoesParaCarregar = (typeof listaVersoesDisponiveis !== 'undefined') ? listaVersoesDisponiveis : [];
        
            const promises = versoesParaCarregar.map(async item => {
                const v = item.sigla;
                try {
                    let dadosVersao = (typeof cacheVersoes !== 'undefined') ? cacheVersoes[v] : null;
                    if (!dadosVersao) {
                        const r = await fetch(`./${v}.json`);
                        if(r.ok) {
                            dadosVersao = await r.json();
                            if (typeof cacheVersoes !== 'undefined') cacheVersoes[v] = dadosVersao;
                        }
                    }
                    if(dadosVersao && dadosVersao[idxLivro]?.chapters?.[cap-1]) {
                        const txt = dadosVersao[idxLivro].chapters[cap-1][ver-1];
                        return `
                            <div class="item-traducao-cheia">
                                <span class="comp-versao">${v}</span>
                                <div class="comp-texto">${txt}</div>
                            </div>`;
                    }
                } catch(e) { console.error(e); }
                return "";
            });
        
            const htmls = await Promise.all(promises);
            listaContainer.innerHTML = htmls.join("");
        }
        
        // Pequena fun√ß√£o auxiliar para mudar a cor do fundo do overlay instantaneamente
        function atualizarCorOverlay() {
            const overlay = document.getElementById('overlay-comparacao');
            if(overlay) {
                const ehEscuro = document.body.classList.contains('modo-escuro');
                overlay.style.backgroundColor = ehEscuro ? '#121212' : '#fdfbf7';
            }
        }
        
        function fecharModalVersiculo() {
            const overlay = document.getElementById('modal-overlay');
            if (overlay) overlay.classList.add('escondido');
        
            const menu = document.getElementById('menu-acoes-versiculo');
            if (menu) menu.classList.add('escondido');
        
            document.querySelectorAll('.versiculo.selected').forEach(v => {
                v.classList.remove('selected');
            });
        }
        
        function voltarParaLeitura() {
            // 1. Mostra novamente o rodap√© e as abas
            document.getElementById('rodape-nav').classList.remove('escondido');
            document.getElementById('abas-principais').classList.remove('escondido');
            
            // 2. Recarrega a leitura do cap√≠tulo atual
            renderizarVersiculos(); 
        }
        
        // --- HIN√ÅRIOS (AGORA ULTRA-R√ÅPIDOS) ---
        async function abrirHinario(tipo) {
            document.getElementById('tela-escolha-hinario').classList.add('escondido');
            document.getElementById('titulo-app').innerText = (tipo === 'harpa') ? "Harpa Crist√£" : "Cantor Crist√£o";
        
            // 1. Tenta pegar do Cache RAM (Instant√¢neo)
            if (cacheHinarios[tipo]) {
                dadosHinario = cacheHinarios[tipo];
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao');
                return; // Sucesso, nem mostra loading
            }
        
            // 2. Se por acaso ainda n√£o baixou (muito raro), baixa agora
            let url = (tipo === 'harpa') ? "./harpa.json" : "./cantor.json";
            loading.style.display = 'block';
        
            try {
                const resp = await fetch(url);
                if(!resp.ok) throw new Error("Erro de rede");
                let json = await resp.json();
                
                processarJsonHinario(json, tipo); // Salva no cache
                dadosHinario = cacheHinarios[tipo]; // Usa o cache processado
        
                renderizarListaHinos();
                telaListaHinos.classList.remove('escondido');
                alternarBarras('navegacao');
        
            } catch(e) {
                alert("Erro ao abrir Hin√°rio.");
                telaEscolhaHinario.classList.remove('escondido');
            } finally {
                loading.style.display = 'none';
            }
        }

        // --- L√ìGICA DO MODAL DE LEITURA (PERFIL) ---

        let modalLeituraAberto = false;
        
        function abrirModalLeituraPerfil(livroNome, capitulo, versoFoco) {
            if (!bibliaCompleta) return alert("Aguarde o carregamento da B√≠blia.");
        
            // 1. Encontrar o √≠ndice do livro
            const indexLivro = bibliaCompleta.findIndex(b => b.name === livroNome || b.nome === livroNome);
            if (indexLivro === -1) return alert("Livro n√£o encontrado.");
        
            // 2. Pegar o texto do cap√≠tulo inteiro
            // (Nota: arrays come√ßam em 0, ent√£o capitulo-1)
            const capituloArray = bibliaCompleta[indexLivro].chapters[capitulo - 1];
            if (!capituloArray) return alert("Cap√≠tulo n√£o encontrado.");
        
            // 3. Montar o HTML
            const containerTexto = document.getElementById('conteudo-leitura-modal');
            containerTexto.innerHTML = ""; // Limpa anterior
            
            let htmlFinal = "";
        
            capituloArray.forEach((textoVerso, index) => {
                const num = index + 1;
                // Verifica se este √© o vers√≠culo que clicamos
                const ehOFoco = (num == versoFoco);
                
                // Se for o foco, adiciona ID especial e classe de destaque
                const idVerso = ehOFoco ? "verso-foco-modal" : `verso-modal-${num}`;
                const classeExtra = ehOFoco ? "verso-destaque-foco" : "";
        
                htmlFinal += `
                    <div id="${idVerso}" class="verso-modal ${classeExtra}">
                        <span class="num-verso-modal">${num}</span> ${textoVerso}
                    </div>
                `;
            });
        
            containerTexto.innerHTML = htmlFinal;
        
            // 4. Atualizar T√≠tulo e Mostrar Modal
            document.getElementById('titulo-leitura-modal').innerText = `${livroNome} ${capitulo}`;
            const modal = document.getElementById('modal-leitura-perfil');
            
            // Mover para o body para garantir sobreposi√ß√£o (Z-index correto)
            document.body.appendChild(modal);
            modal.classList.remove('escondido');
            modalLeituraAberto = true;
        
            // 5. Rolar at√© o vers√≠culo (Scroll autom√°tico)
            setTimeout(() => {
                const elementoFoco = document.getElementById('verso-foco-modal');
                if (elementoFoco) {
                    elementoFoco.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300); // Pequeno delay para a anima√ß√£o de abrir terminar
        }
        
        function fecharModalLeituraPerfil() {
            const modal = document.getElementById('modal-leitura-perfil');
            modal.classList.add('escondido');
            // Remove a tela cheia ao fechar para resetar
            document.querySelector('.janela-leitura-perfil').classList.remove('tela-cheia');
            modalLeituraAberto = false;
        }
        
        function alternarTelaCheiaModal() {
            const janela = document.querySelector('.janela-leitura-perfil');
            janela.classList.toggle('tela-cheia');
        }
        
        function renderizarListaHinos(filtro = "") {
            const container = document.getElementById('lista-hinos-container');
            container.innerHTML = "";
            const termo = filtro.toLowerCase();
            dadosHinario.forEach((hino, index) => {
                if(String(hino.titulo).toLowerCase().includes(termo) || String(hino.numero).includes(termo)) {
                    const div = document.createElement('div');
                    div.className = 'item-hino';
                    div.innerHTML = `<strong>${hino.numero}.</strong> ${hino.titulo}`;
                    div.onclick = () => lerHino(index);
                    container.appendChild(div);
                }
            });
        }
        
        function filtrarHinos() { 
            renderizarListaHinos(document.getElementById('busca-hino').value); 
        }
        
        function lerHino(index) {
            hinoAtual = index;
            const hino = dadosHinario[index];
            let letraRaw = hino.letra;
            let letraHTML = "";
        
            if (!letraRaw) {
                letraHTML = "<p>Letra indispon√≠vel.</p>";
            } else if (Array.isArray(letraRaw)) {
                letraRaw.forEach(estrofe => {
                     let texto = (typeof estrofe === 'string') ? estrofe : (estrofe.verse || estrofe.text || "");
                     letraHTML += `<div class="estrofe-hino">${texto.replace(/\n/g, '<br>')}</div>`;
                });
            } else {
                letraHTML = `<div class="estrofe-hino">${String(letraRaw).replace(/\n/g, '<br>')}</div>`;
            }
        
            document.getElementById('titulo-hino-leitura').innerText = `${hino.numero}. ${hino.titulo}`;
            document.getElementById('texto-hino').innerHTML = letraHTML;
            
            telaListaHinos.classList.add('escondido');
            telaLeituraHino.classList.remove('escondido');
            alternarBarras('leitura');
            areaPrincipal.scrollTop = 0; 
            window.scrollTo(0,0);
        }
        
        function voltarParaEscolhaHinario() {
            telaListaHinos.classList.add('escondido');
            telaEscolhaHinario.classList.remove('escondido');
            tituloApp.innerText = "Hin√°rios";
            alternarBarras('navegacao');
        }
        
        function voltarInicioLeitura() {
            alternarBarras('navegacao');
            
            if (modoAtual === 'biblia') {
                telaLeitura.classList.add('escondido');
                abrirCapitulos(livroAtualIndex, livroAtualNome, livroAtualMaxCaps);
                
            } else {
                telaLeituraHino.classList.add('escondido');
                telaListaHinos.classList.remove('escondido');
            }
        }
        
        function navegarConteudo(direcao) {
            if (modoAtual === 'biblia') {
                const novoCap = capituloAtual + direcao;
                if (novoCap < 1 || novoCap > livroAtualMaxCaps) return alert("Fim do livro.");
                lerCapitulo(novoCap);
            } else {
                const novoIndex = hinoAtual + direcao;
                if (novoIndex < 0 || novoIndex >= dadosHinario.length) return alert("Fim do hin√°rio.");
                lerHino(novoIndex);
            }
        }
        /* --- SISTEMA DE GRIFOS E COMENT√ÅRIOS --- */

        // Vari√°veis tempor√°rias para saber qual vers√≠culo foi clicado
        let versoSelecionado = { livro: "", cap: 0, num: 0, texto: "" };

        function abrirMenuVersiculo(livro, cap, num, textoCodificado) {
            const modal = document.getElementById('modal-verso');
            
            // --- CORRE√á√ÉO DE PRIORIDADE ---
            // Isto move o modal fisicamente para o final do <body>.
            // Ao fazer isso, ele sai de dentro do 'main' e ganha o poder de ficar
            // por cima do cabe√ßalho fixo.
            if (modal) {
                document.body.appendChild(modal);
            }
            // -----------------------------
        
            // 2. Prepara os dados
            const texto = decodeURIComponent(textoCodificado);
            versoSelecionado = { livro, cap, num, texto };
            
            // Atualiza os textos do modal
            const titulo = document.getElementById('titulo-modal-verso');
            if (titulo) titulo.innerText = `${livro} ${cap}:${num}`;
            
            const preview = document.getElementById('texto-verso-preview');
            if (preview) {
                const textoPreview = texto.length > 100 ? texto.substring(0, 100) + "..." : texto;
                preview.innerText = `"${textoPreview}"`;
            }
            
            // 3. Mostra o modal
            if (modal) {
                modal.classList.remove('escondido');
            }
        
            // OPCIONAL: Adicionar um fundo escuro (overlay) atr√°s para fechar ao clicar fora
            // Se voc√™ j√° tiver um overlay no seu HTML, certifique-se de mover ele para o body tamb√©m.
        }
        
        function copiarVersoSelecionado() {
            // Monta o texto
            const textoFinal = `${versoSelecionado.texto} \n(${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num})`;
            
            // Copia para a √°rea de transfer√™ncia
            navigator.clipboard.writeText(textoFinal).then(() => {
                // Fecha o modal de op√ß√µes do vers√≠culo primeiro
                fecharModalVerso();
                
                // MOSTRA O ALERTA BONITO
                mostrarAlerta("Vers√≠culo copiado!");
                
            }).catch(err => {
                console.error('Erro ao copiar', err);
                fecharModalVerso();
                mostrarAlerta("Erro ao copiar. Tente selecionar manualmente.");
            });
        }
        
        function fecharModalVerso(e) {
            if (e && e.target !== e.currentTarget) return; // S√≥ fecha se clicar no fundo escuro
            document.getElementById('modal-verso').classList.add('escondido');
        }
        
        // 2. Salvar Cor (Grifo)
        function aplicarCor(cor) {
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            
            if (cor === 'limpar') {
                delete dadosUsuario.grifos[chave];
            } else {
                dadosUsuario.grifos[chave] = { cor: cor, texto: versoSelecionado.texto, timestamp: Date.now() };
            }
            
            salvarDados();
            fecharModalVerso();
            
            // Atualiza a tela de leitura imediatamente (sem recarregar tudo)
            lerCapitulo(capituloAtual); 
        }
        
        // 3. Salvar Coment√°rio
        function iniciarComentario() {
            // 1. Tenta fechar o menu de vers√≠culos para limpar a tela
            // (Verifique se o nome da fun√ß√£o de fechar √© 'fecharModalVerso' ou 'fecharMenuVersiculo')
            try { fecharModalVerso(); } catch(e) { /* ignora erro se n√£o existir */ }
            
            // Tenta fechar o overlay tamb√©m, s√≥ por garantia
            const overlay = document.getElementById('overlay-verso');
            if (overlay) overlay.remove();
        
            // 2. Prepara os dados
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            const notaSalva = dadosUsuario.notas[chave] ? dadosUsuario.notas[chave].texto : "";
            
            // 3. Preenche os campos do HTML
            document.getElementById('titulo-editor').innerText = "Adicionar/Editar Anota√ß√£o";
            document.getElementById('ref-editor').innerText = `${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num}`;
            document.getElementById('texto-nota-input').value = notaSalva;
            
            // 4. A CORRE√á√ÉO DE HIERARQUIA (Move para o Body)
            const modalEditor = document.getElementById('modal-editor-nota');
            if (modalEditor) {
                document.body.appendChild(modalEditor); // <--- O SEGREDO EST√Å AQUI
                
                // Remove a classe 'escondido' (ou define display flex)
                modalEditor.classList.remove('escondido');
                // For√ßa display flex caso o CSS 'escondido' use display:none
                modalEditor.style.display = 'flex'; 
            }
        
            // 5. Foca no campo de texto
            setTimeout(() => {
                const input = document.getElementById('texto-nota-input');
                if(input) input.focus();
            }, 100);
        }

        function fecharEditorNota() {
            const modal = document.getElementById('modal-editor-nota');
            if (modal) {
                modal.classList.add('escondido');
                modal.style.display = 'none'; // Garante que some
            }
        }

        function salvarNotaPeloModal() {
            // Se por acaso perder a refer√™ncia, cancela para n√£o dar erro
            if (!versoSelecionado) return;
        
            const textoDigitado = document.getElementById('texto-nota-input').value;
            const chave = `${versoSelecionado.livro}_${versoSelecionado.cap}_${versoSelecionado.num}`;
            
            if (textoDigitado.trim() === "") {
                delete dadosUsuario.notas[chave]; // Se deixar vazio, apaga
            } else {
                dadosUsuario.notas[chave] = { 
                    texto: textoDigitado, 
                    ref: `${versoSelecionado.livro} ${versoSelecionado.cap}:${versoSelecionado.num}`, 
                    timestamp: Date.now() 
                };
            }
            
            salvarDados();
            fecharEditorNota();
            
            // --- ATUALIZA√á√ïES VISUAIS ---
            
            // 1. Se estiver na tela da B√≠blia, atualiza o √≠cone
            if (modoAtual === 'biblia') {
                lerCapitulo(capituloAtual); 
            }
        
            // 2. NOVO: Se estiver na tela de Coment√°rios, atualiza a lista!
            const telaComentarios = document.getElementById('view-comentarios');
            if (telaComentarios && telaComentarios.style.display === 'block') {
                abrirTelaComentarios(); // Recarrega a lista com o texto novo
            }
        }
        
        // 4. Renderizar Tela de Favoritos
        function abrirTelaFavoritos() {
            // --- 1. NAVEGA√á√ÉO MANUAL (Sem depender de fun√ß√µes externas) ---
            document.getElementById('menu-perfil-principal').style.display = 'none';
            
            // Esconde as outras telas irm√£s
            document.getElementById('view-comentarios').style.display = 'none';
            document.getElementById('view-progressao').style.display = 'none';
        
            // Mostra a tela de favoritos
            const view = document.getElementById('view-favoritos');
            view.style.display = 'block';
            view.classList.remove('escondido');
            
            // --- 2. L√ìGICA DE LISTAGEM (Mantendo a sua original) ---
            const container = document.getElementById('lista-favoritos-container');
            container.innerHTML = "";
            
            const lista = Object.entries(dadosUsuario.grifos || {}).sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            if (lista.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px'>Nenhum vers√≠culo marcado ainda.</p>";
                return;
            }
            
            lista.forEach(([chave, dados]) => {
                const [livroSigla, cap, num] = chave.split("_");
                
                // Tenta pegar o nome completo do livro
                const nomeLivro = (typeof nomesLivros !== 'undefined' && nomesLivros[livroSigla]) ? nomesLivros[livroSigla] : livroSigla.toUpperCase();
        
                const div = document.createElement('div');
                // Adiciona a classe da cor se existir
                div.className = `item-ref ${dados.cor || ''}`; 
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
                        <div style="flex:1;">
                            <strong>${nomeLivro} ${cap}:${num}</strong>
                            <div class="texto-ref-b" style="margin-top:5px; color:#555;">"${dados.texto}..."</div>
                        </div>
                        <button class="btn-deletar-individual" title="Remover destaque" style="background:none; border:none; font-size:18px;">üóëÔ∏è</button>
                    </div>
                `;
                
                // Clique no card abre a leitura
                div.onclick = () => abrirModalLeituraPerfil(livroSigla, parseInt(cap), parseInt(num));
                
                // Clique na LIXEIRA apaga o item
                const btnLixo = div.querySelector('.btn-deletar-individual');
                btnLixo.onclick = (e) => {
                    e.stopPropagation(); // Impede de abrir o vers√≠culo ao deletar
                    apagarItemIndividual('grifos', chave, livroSigla, cap, num);
                };
                
                container.appendChild(div);
            });
        }
        
        // 5. Renderizar Tela de Coment√°rios (ATUALIZADA)
        /* --- VARI√ÅVEL GLOBAL PARA SABER QUAL NOTA ESTAMOS LENDO --- */
        let notaSendoLida = null; 

        /* --- HELPER: Converte sigla (ex: "gn") para √≠ndice num√©rico (ex: 0) --- */
        /* Helper: Converte 'gn' em 0, 'ex' em 1... */
        /* --- HELPER TURBINADO: Acha o √≠ndice por Sigla OU Nome --- */
        function obterIndicePorSigla(texto) {
            if (!texto) return -1;
            
            // 1. Limpeza b√°sica (tudo min√∫sculo, sem espa√ßos extras)
            let chave = texto.toLowerCase().trim();
        
            // 2. Mapa de Siglas (O m√©todo r√°pido)
            const mapaSiglas = {
                "gn": 0, "ex": 1, "lv": 2, "nm": 3, "dt": 4, "js": 5, "jz": 6, "rt": 7,
                "1sm": 8, "2sm": 9, "1rs": 10, "2rs": 11, "1cr": 12, "2cr": 13, "ed": 14,
                "ne": 15, "et": 16, "job": 17, "sl": 18, "pv": 19, "ec": 20, "ct": 21,
                "is": 22, "jr": 23, "lm": 24, "ez": 25, "dn": 26, "os": 27, "jl": 28,
                "am": 29, "ob": 30, "jn": 31, "mq": 32, "na": 33, "hc": 34, "sf": 35,
                "ag": 36, "zc": 37, "ml": 38, "mt": 39, "mc": 40, "lc": 41, "jo": 42,
                "at": 43, "rm": 44, "1co": 45, "2co": 46, "gl": 47, "ef": 48, "fp": 49,
                "cl": 50, "1ts": 51, "2ts": 52, "1tm": 53, "2tm": 54, "tt": 55, "fl": 56,
                "hb": 57, "tg": 58, "1pe": 59, "2pe": 60, "1jo": 61, "2jo": 62, "3jo": 63,
                "jd": 64, "ap": 65
            };
        
            // Se achou no mapa de siglas, retorna logo
            if (mapaSiglas[chave] !== undefined) {
                return mapaSiglas[chave];
            }
        
            // 3. Procura pelo Nome Completo (ex: "g√™nesis")
            // Varre a lista de livros oficial do sistema
            if (typeof listaLivros !== 'undefined' && Array.isArray(listaLivros)) {
                for (let i = 0; i < listaLivros.length; i++) {
                    let nomeLivro = listaLivros[i].toLowerCase(); // ex: "g√™nesis"
                    
                    // Compara direto
                    if (nomeLivro === chave) return i;
        
                    // Compara removendo acentos (para garantir que "genesis" ache "g√™nesis")
                    // (Normaliza NFD separa os acentos e o replace remove eles)
                    let nomeSemAcento = nomeLivro.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    let chaveSemAcento = chave.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    
                    if (nomeSemAcento === chaveSemAcento) return i;
                }
            }
        
            return -1; // Desistiu
        }
        
        /* --- 1. FUN√á√ÉO CORRIGIDA PARA SEUS IDs --- */
        function abrirTelaComentarios() {
            // Gest√£o das telas
            document.getElementById('menu-perfil-principal').style.display = 'none';
            ['view-favoritos', 'view-progressao'].forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.style.display='none'; 
            });
        
            const telaView = document.getElementById('view-comentarios');
            if(telaView) {
                telaView.style.display = 'block';
                telaView.classList.remove('escondido');
            }
        
            const container = document.getElementById('lista-comentarios-container');
            if(!container) return;
            
            container.innerHTML = '';
            
            if (!dadosUsuario.notas) dadosUsuario.notas = {};
            const chaves = Object.keys(dadosUsuario.notas);
        
            if (chaves.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px 20px; color:#7f8c8d;"><h3>Nenhuma anota√ß√£o ainda</h3></div>`;
                return;
            }
        
            chaves.reverse();
            
            // FOR√áA O USO DA B√çBLIA GLOBAL
            // Se window.bibliaCompleta estiver vazio, tenta window.biblia
            const bibliaAlvo = window.bibliaCompleta || window.biblia;
        
            if (!bibliaAlvo) {
                console.warn("‚ö†Ô∏è AVISO: B√≠blia ainda n√£o carregou na vari√°vel global.");
            }
        
            chaves.forEach(chave => {
                // Ex: chave = "gn_1_1"
                const partes = chave.split('_');
                
                // --- CORRE√á√ÉO DE SEGURAN√áA ---
                // Garante que pegamos a sigla em min√∫sculo independente de como salvou
                const livSigla = partes[0].toLowerCase(); 
                const cap = parseInt(partes[1]);
                const ver = parseInt(partes[2]);
        
                // 1. Texto da Nota
                let conteudoNota = dadosUsuario.notas[chave];
                let textoReal = (typeof conteudoNota === 'object' && conteudoNota !== null) ? (conteudoNota.texto || "") : conteudoNota;
        
                // 2. Busca Nome e √çndice
                const indiceLivro = obterIndicePorSigla(livSigla);
                
                let nomeLivro = livSigla.toUpperCase();
                // Tenta pegar nome bonito da lista de nomes, se existir
                if (indiceLivro !== -1 && typeof listaLivros !== 'undefined' && listaLivros[indiceLivro]) {
                    nomeLivro = listaLivros[indiceLivro];
                }
        
                // 3. BUSCA O VERS√çCULO (Com logs para debug)
                let textoVersiculo = "Carregando texto...";
                
                if (bibliaAlvo && indiceLivro !== -1) {
                    try {
                        // Tenta acessar o caminho que vimos funcionar no console:
                        // bibliaAlvo[0].chapters[0][0]
                        if (bibliaAlvo[indiceLivro] && bibliaAlvo[indiceLivro].chapters) {
                            const textoEncontrado = bibliaAlvo[indiceLivro].chapters[cap-1][ver-1];
                            if (textoEncontrado) {
                                textoVersiculo = textoEncontrado;
                            } else {
                                textoVersiculo = "Vers√≠culo n√£o encontrado no √≠ndice.";
                            }
                        } else {
                            textoVersiculo = "Erro na estrutura do livro.";
                        }
                    } catch(e) {
                        console.error("Erro ao ler nota:", chave, e);
                        textoVersiculo = "Erro ao ler.";
                    }
                } else {
                    if(!bibliaAlvo) textoVersiculo = "Aguardando carregamento da B√≠blia...";
                    if(indiceLivro === -1) textoVersiculo = `Livro n√£o reconhecido (${livSigla})`;
                }
        
                // 4. Renderiza
                const div = document.createElement('div');
                div.className = 'item-ref'; 
                div.onclick = function() { verNotaCompleta(chave); };
        
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <span class="res-ref">${nomeLivro} ${cap}:${ver}</span>
                            <div class="verso-preview" style="font-size:14px; margin-bottom:8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; font-style:italic;">
                                "${textoVersiculo}"
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); apagarItemIndividual('notas', '${chave}', '${livSigla}', ${cap}, ${ver})" 
                                style="background:none; border:none; color:#c0392b; font-size:20px; padding:0 0 0 15px;">‚úñ</button>
                    </div>
                    <div class="nota-preview" style="border-left: 3px solid #f39c12; padding-left: 8px;">${textoReal}</div>
                `;
                container.appendChild(div);
            });
        }
        
        /* --- 2. FUN√á√ÉO PARA VOLTAR AO MENU DE PERFIL (Necess√°ria no seu HTML) --- */
        function verNotaCompleta(chave) {
            notaSendoLida = chave;
            
            const partes = chave.split('_');
            const livSigla = partes[0];
            const cap = parseInt(partes[1]);
            const ver = parseInt(partes[2]);
        
            // Usa a fun√ß√£o inteligente
            const indiceLivro = obterIndicePorSigla(livSigla);
        
            let nomeLivro = livSigla.toUpperCase();
            if (indiceLivro !== -1 && typeof listaLivros !== 'undefined' && listaLivros[indiceLivro]) {
                nomeLivro = listaLivros[indiceLivro];
            }
            
            const tituloEl = document.getElementById('leitura-titulo');
            if(tituloEl) tituloEl.innerText = `${nomeLivro} ${cap}:${ver}`;
        
            // --- AJUSTE DE SEGURAN√áA AQUI ---
            // Garante que pega a b√≠blia mesmo que a vari√°vel local falhe
            const bibliaAlvo = window.bibliaCompleta || window.biblia || bibliaCompleta;
            let textoBiblico = "Texto indispon√≠vel.";
            
            if (bibliaAlvo && indiceLivro !== -1 && bibliaAlvo[indiceLivro]) {
                try {
                    textoBiblico = bibliaAlvo[indiceLivro].chapters[cap-1][ver-1];
                } catch (e) {
                    console.error("Erro modal:", e);
                }
            }
        
            const textoBiblicoEl = document.getElementById('leitura-texto-biblico');
            if(textoBiblicoEl) textoBiblicoEl.innerText = `"${textoBiblico}"`;
        
            let conteudoNota = dadosUsuario.notas[chave];
            let textoReal = "";
            
            if (typeof conteudoNota === 'object' && conteudoNota !== null) {
                textoReal = conteudoNota.texto || conteudoNota.conteudo || "";
            } else {
                textoReal = conteudoNota || "";
            }
            
            const notaEl = document.getElementById('leitura-nota-usuario');
            if(notaEl) notaEl.innerText = textoReal;
        
            const modal = document.getElementById('modal-leitura-nota');
            if(modal) {
                modal.style.display = 'flex';
                modal.classList.remove('escondido');
            }
        }
        
        function fecharModalLeitura(event) {
            if (event && event.target.id !== 'modal-leitura-nota') return;
            document.getElementById('modal-leitura-nota').style.display = 'none';
        }
        
        function editarNotaAtual() {
            if(!notaSendoLida) return;
        
            // 1. Fecha o modal de leitura
            document.getElementById('modal-leitura-nota').style.display = 'none';
        
            // 2. Pega os dados da chave (ex: gn_1_1)
            const partes = notaSendoLida.split('_');
            const livSigla = partes[0];
            const cap = parseInt(partes[1]);
            const ver = parseInt(partes[2]);
            
            // --- O SEGREDO EST√Å AQUI ---
            // Criamos o objeto que a sua fun√ß√£o de salvar exige
            window.versoSelecionado = {
                livro: livSigla,
                cap: cap,
                num: ver
            };
        
            // 3. Pega o texto atual
            let conteudoNota = dadosUsuario.notas[notaSendoLida];
            let textoAtual = "";
            if (typeof conteudoNota === 'object' && conteudoNota !== null) {
                textoAtual = conteudoNota.texto || conteudoNota.conteudo || "";
            } else {
                textoAtual = conteudoNota || ""; // Caso seja s√≥ string antiga
            }
        
            // 4. Preenche e abre o Editor
            const textArea = document.getElementById('texto-nota-input');
            const tituloEditor = document.getElementById('titulo-editor');
            const refEditor = document.getElementById('ref-editor');
            
            // Tenta pegar nome bonito do livro
            let nomeLivro = (typeof nomesLivros !== 'undefined' && nomesLivros[livSigla]) ? nomesLivros[livSigla] : livSigla.toUpperCase();
        
            if(textArea) textArea.value = textoAtual;
            if(tituloEditor) tituloEditor.innerText = "Editando Anota√ß√£o";
            if(refEditor) refEditor.innerText = `${nomeLivro} ${cap}:${ver}`;
        
            // Mostra o editor
            const modalEditor = document.getElementById('modal-editor-nota');
            if(modalEditor) {
                modalEditor.style.display = 'flex';
                modalEditor.classList.remove('escondido');
            }
        }
        
        // Fun√ß√µes de Resetar
        function resetarFavoritos() {
            // Em vez de: if(confirm("...")) { ... }
            // Usamos:
            mostrarConfirmacao("Apagar todos os destaques coloridos?", function() {
                // O c√≥digo que antes estava dentro do IF vem para aqui
                dadosUsuario.grifos = {};
                salvarDados();
                abrirTelaFavoritos();
            });
        }

        function apagarItemIndividual(tipo, chave, livro, cap, num) {
            const mensagem = tipo === 'grifos' ? "Remover este destaque?" : "Apagar esta anota√ß√£o?";
            
            mostrarConfirmacao(mensagem, function() {
                // Remove a chave espec√≠fica do objeto (grifos ou notas)
                if (dadosUsuario[tipo] && dadosUsuario[tipo][chave]) {
                    delete dadosUsuario[tipo][chave];
                    
                    salvarDados(); // Grava no localStorage
                    
                    // Atualiza a tela que estiver aberta
                    if (tipo === 'grifos') abrirTelaFavoritos();
                    else abrirTelaComentarios();
                    
                    // Opcional: Se quiser que o vers√≠culo na B√≠blia perca a cor na hora:
                    if(typeof renderizarVersiculos === 'function') renderizarVersiculos();
                }
            });
        }
        
        function resetarComentarios() {
            mostrarConfirmacao("Apagar todas as suas anota√ß√µes?", function() {
                dadosUsuario.notas = {};
                salvarDados();
                abrirTelaComentarios();
            });
        }
    
        /* ============================================================
        SISTEMA DE BACKUP E RESTAURA√á√ÉO (Final com Download + DarkMode)
        ============================================================ */

        /* 1. FAZER BACKUP - Abre modal com C√≥digo + Op√ß√µes */
        async function fazerBackup() {
            try {
                // 1. Gera o pacote de dados
                const pacoteDados = {
                    versao: "1.0",
                    data: new Date().toISOString(),
                    notas: dadosUsuario.notas || {},
                    grifos: dadosUsuario.grifos || {},
                    favoritos: dadosUsuario.favoritos || [] 
                };
                
                // Converte para texto
                const jsonString = JSON.stringify(pacoteDados);

                // 2. Cria o Modal Visualmente
                const div = document.createElement('div');
                div.className = 'modal-overlay';
                
                // Note que removemos o bot√£o de compartilhar que dava erro
                div.innerHTML = `
                    <div class="caixa-confirmacao zoom-in">
                        <h3>Seu C√≥digo de Backup</h3>
                        <p>Copie o c√≥digo abaixo e guarde em local seguro (WhatsApp, E-mail, Notas) ou baixe o arquivo.</p>
                        
                        <textarea id="txt-backup-copy" readonly>${jsonString}</textarea>
                        
                        <button onclick="copiarCodigoBackup()" class="btn-modal" style="background:#3498db; color:white;">
                            üìã Copiar C√≥digo
                        </button>

                        <button onclick="baixarBackupPeloModal()" class="btn-modal" style="background:#27ae60; color:white;">
                            üíæ Baixar Arquivo .JSON
                        </button>
                        
                        <button onclick="fecharModalTemp(this)" class="btn-modal" style="background:#e74c3c; color:white; margin-top:15px;">
                            Fechar
                        </button>
                    </div>
                `;
                document.body.appendChild(div);

            } catch (e) {
                console.error(e);
                mostrarAlerta("Erro ao gerar backup.", "Erro");
            }
        }

        /* Fun√ß√£o: Copiar texto da caixa (Universal) */
        function copiarCodigoBackup() {
            const textarea = document.getElementById('txt-backup-copy');
            
            // Seleciona o texto visualmente
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Essencial para mobile
            
            try {
                // Tenta usar a API nativa do Capacitor se existir, sen√£o usa a do navegador
                if(window.Capacitor && window.Capacitor.isNative) {
                    const { Clipboard } = Capacitor.Plugins;
                    // Se n√£o tiver o plugin Clipboard, ele cai no catch e usa o execCommand
                    if (Clipboard) {
                        Clipboard.write({ string: textarea.value });
                    } else {
                        document.execCommand('copy');
                    }
                } else {
                    // M√©todo padr√£o PC/Web
                    document.execCommand('copy');
                    
                    // Tenta tamb√©m a API mais moderna de clipboard (se dispon√≠vel)
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(textarea.value);
                    }
                }
                mostrarAlerta("C√≥digo copiado! Cole no WhatsApp ou Bloco de Notas.", "Sucesso ‚úÖ");
            } catch (err) {
                // Fallback: Se tudo falhar, o usu√°rio j√° viu o texto selecionado
                mostrarAlerta("O texto foi selecionado. Toque e segure para copiar.", "Aviso");
            }
        }

        /* Fun√ß√£o: Baixar arquivo (Web/PC) */
        function baixarBackupPeloModal() {
            try {
                const texto = document.getElementById('txt-backup-copy').value;
                const blob = new Blob([texto], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                const dataHoje = new Date().toISOString().split('T')[0];
                a.download = `backup_biblia_${dataHoje}.json`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarAlerta("Download iniciado!", "Sucesso ‚¨áÔ∏è");
            } catch(e) {
                mostrarAlerta("Erro ao baixar. Tente a op√ß√£o Copiar.", "Erro");
            }
        }

        /* 2. RESTAURAR BACKUP - Menu de Escolha */
        function acionarRestauracao() {
            const div = document.createElement('div');
            div.className = 'modal-overlay';
            div.innerHTML = `
                <div class="caixa-confirmacao zoom-in">
                    <h3>Restaurar Dados</h3>
                    <p>Escolha como deseja recuperar seus dados:</p>
                    
                    <button onclick="abrirTelaColar(this)" class="btn-modal" style="background:#3498db; color:white;">
                        üìã Colar C√≥digo (Texto)
                    </button>
                    
                    <button onclick="document.getElementById('input-restore-hidden').click(); fecharModalTemp(this)" class="btn-modal" style="background:#27ae60; color:white;">
                        üìÇ Abrir Arquivo .JSON
                    </button>
                    
                    <button onclick="fecharModalTemp(this)" class="btn-modal" style="background:#95a5a6; color:white; margin-top:15px;">
                        Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(div);
        }

        /* Abre tela para colar o c√≥digo manualmente */
        function abrirTelaColar(btnAnterior) {
            fecharModalTemp(btnAnterior);
            
            const div = document.createElement('div');
            div.className = 'modal-overlay';
            div.innerHTML = `
                <div class="caixa-confirmacao zoom-in">
                    <h3>Colar C√≥digo</h3>
                    <p>Cole aqui o c√≥digo que voc√™ salvou anteriormente.</p>
                    <textarea id="txt-paste-backup" placeholder="Cole aqui..." style="margin-bottom:10px;"></textarea>
                    
                    <button onclick="processarTextoRestauracao()" class="btn-modal" style="background:#27ae60; color:white;">
                        Restaurar Agora
                    </button>
                    <button onclick="fecharModalTemp(this)" class="btn-modal" style="background:#e74c3c; color:white;">
                        Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(div);
        }

        /* Processa o texto colado na restaura√ß√£o */
        function processarTextoRestauracao() {
            const texto = document.getElementById('txt-paste-backup').value;
            if(!texto) return mostrarAlerta("Cole o c√≥digo primeiro!", "Aten√ß√£o");
            
            fecharModalTemp(document.getElementById('txt-paste-backup'));
            confirmarRestauracaoTexto(texto);
        }

        /* Valida e salva os dados (serve para arquivo ou texto colado) */
        function confirmarRestauracaoTexto(jsonString) {
            try {
                const dados = JSON.parse(jsonString);
                
                // Verifica√ß√£o simples se √© o nosso backup
                if (!dados.notas && !dados.favoritos && !dados.grifos) {
                    throw new Error("Formato inv√°lido");
                }

                // Atualiza os dados globais
                if(dados.notas) dadosUsuario.notas = dados.notas;
                if(dados.grifos) dadosUsuario.grifos = dados.grifos;
                if(dados.favoritos) dadosUsuario.favoritos = dados.favoritos;
                
                salvarDados(); // Salva no LocalStorage
                
                mostrarAlerta("Seus dados foram recuperados com sucesso!", "Parab√©ns üéâ");
                
                // Recarrega a p√°gina para atualizar tudo
                setTimeout(() => window.location.reload(), 2000);

            } catch (e) {
                mostrarAlerta("O c√≥digo colado n√£o √© v√°lido.", "Erro ‚ùå");
            }
        }

        /* Utilit√°rio para fechar modais */
        function fecharModalTemp(elemento) {
            const modal = elemento.closest('.modal-overlay');
            if(modal) modal.remove();
        }
        
        iniciarApp();
    </script>
</body>
</html>
